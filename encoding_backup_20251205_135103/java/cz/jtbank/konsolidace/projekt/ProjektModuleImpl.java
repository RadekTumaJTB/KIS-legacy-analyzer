package cz.jtbank.konsolidace.projekt;
import cz.jtbank.konsolidace.common.*;
import cz.jtbank.konsolidace.excel.*;
import cz.jtbank.konsolidace.mail.*;
import java.sql.*;
import java.io.*;
import java.util.*;
import oracle.jbo.client.*;
import oracle.jbo.*;
import oracle.jbo.domain.Number;
import oracle.jbo.server.DBTransaction;
import oracle.jbo.server.ApplicationModuleImpl;
import cz.jtbank.konsolidace.doklady.KpKtgUcetnispolecnostViewImpl;
import cz.jtbank.konsolidace.users.KtgAppuserViewImpl;
import cz.jtbank.konsolidace.fininv.KpCisMenaViewImpl;
import cz.jtbank.konsolidace.ms.*;
import cz.jtbank.konsolidace.ucskup.KpRelUcetniskupinaclenViewImpl;
import cz.jtbank.konsolidace.users.KpKtgEmailzpravyViewImpl;
import cz.jtbank.konsolidace.doklady.KpEmailParamViewImpl;
import cz.jtbank.konsolidace.ifrs.KpCisIfrssegmentViewImpl;
import cz.jtbank.konsolidace.ifrs.KpCisIfrssubsegmentViewImpl;
import cz.jtbank.konsolidace.ifrs.KpCisMngsegmentViewImpl;
import cz.jtbank.konsolidace.ifrs.KpDatMngsegmentbossViewImpl;

import org.apache.log4j.*;
import cz.jtbank.konsolidace.common.Logging;

//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---------------------------------------------------------------

public class ProjektModuleImpl extends ApplicationModuleImpl implements cz.jtbank.konsolidace.projekt.common.ProjektModule 
{
/*esc 18.04.08*/
static Logger logger = Logger.getLogger(ProjektModuleImpl.class);

  /**
   * 
   * This is the default constructor (do not remove)
   */
  public ProjektModuleImpl()
  {
  }

  /**
   * 
   * Container's getter for KpKtgProjektView1
   */
  public KpKtgProjektViewImpl getKpKtgProjektView1()
  {
    return (KpKtgProjektViewImpl)findViewObject("KpKtgProjektView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektstatusView1
   */
  public KpCisProjektstatusViewImpl getKpCisProjektstatusView1()
  {
    return (KpCisProjektstatusViewImpl)findViewObject("KpCisProjektstatusView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektkategorieView1
   */
  public KpCisProjektkategorieViewImpl getKpCisProjektkategorieView1()
  {
    return (KpCisProjektkategorieViewImpl)findViewObject("KpCisProjektkategorieView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektjtView1
   */
  public KpCisProjektjtViewImpl getKpCisProjektjtView1()
  {
    return (KpCisProjektjtViewImpl)findViewObject("KpCisProjektjtView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektskupView1
   */
  public KpCisProjektskupViewImpl getKpCisProjektskupView1()
  {
    return (KpCisProjektskupViewImpl)findViewObject("KpCisProjektskupView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektpbView1
   */
  public KpCisProjektpbViewImpl getKpCisProjektpbView1()
  {
    return (KpCisProjektpbViewImpl)findViewObject("KpCisProjektpbView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektuverView1
   */
  public KpCisProjektuverViewImpl getKpCisProjektuverView1()
  {
    return (KpCisProjektuverViewImpl)findViewObject("KpCisProjektuverView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektfrekvenceView1
   */
  public KpCisProjektfrekvenceViewImpl getKpCisProjektfrekvenceView1()
  {
    return (KpCisProjektfrekvenceViewImpl)findViewObject("KpCisProjektfrekvenceView1");
  }

  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
//  public static void main(String[] args)
//  {
//    launchTester("cz.jtbank.konsolidace.projekt", "ProjektModuleLocal");
//  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostView1
   */
  public KpKtgUcetnispolecnostViewImpl getKpKtgUcetnispolecnostView1()
  {
    return (KpKtgUcetnispolecnostViewImpl)findViewObject("KpKtgUcetnispolecnostView1");
  }

  /**
   * 
   * Container's getter for KtgAppuserView1
   */
  public KtgAppuserViewImpl getKtgAppuserView1()
  {
    return (KtgAppuserViewImpl)findViewObject("KtgAppuserView1");
  }

  /**
   * 
   * Container's getter for KpCisMenaView1
   */
  public KpCisMenaViewImpl getKpCisMenaView1()
  {
    return (KpCisMenaViewImpl)findViewObject("KpCisMenaView1");
  }

  private String getUser() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, false);
    return user;
  }
  
  private int getPuvodniHodnota(int idProjekt,
                              String sloupec)
  {
    int idOsoba = -1;
  
    ViewObject vo = getKpKtgProjektView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idProjekt);
    while(vo.hasNext()) 
    {
      Row row = vo.next();
      Number hlp = (Number) row.getAttribute(sloupec);
      if(hlp!=null) idOsoba = hlp.intValue();
    }
    vo.closeRowSet();
    
    return idOsoba;
  }
  
  private int getMngSegmentBoss(int idProjekt)
  {
    Number idMngSeg = null;
    int idOsoba = -1;

    ViewObject vo = getKpKtgProjektView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idProjekt);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      idMngSeg = (Number) row.getAttribute("IdMngsegment");
    }
    vo.closeRowSet();
  
    vo = getKpDatMngsegmentbossView1();
    vo.clearCache();
    vo.setWhereClause("KpDatMngsegmentboss.ID = "+idMngSeg);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      Number hlp = (Number) row.getAttribute("IdBoss");
      if(hlp!=null) idOsoba = hlp.intValue();
    }
    vo.closeRowSet();
    
    return idOsoba;
  }

  private String getMngSegment(int idMngSeg)
  {
    String nazev = null;

    ViewObject vo = getKpCisMngsegmentView1();
    vo.clearCache();
    vo.setWhereClause("KpCisMngsegment.ID = "+idMngSeg);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      nazev = (String) row.getAttribute("SPopis");
    }
    vo.closeRowSet();
    
    return nazev;
  }
  
  public void kpProjekt(String akce,
                        int idProjekt,
                        String nazev,
                        String cisloOld,
                        int status,
                        int navrhuje,
                        int pman,
                        int mngSeg,
                        String menaN,
                        java.sql.Date dtStartOceneni,
                        int freq,
                        String popis,
                        int idNavrh,
                        java.sql.Date dtMDalsi,
                        int mMesicu,
                        int idTypBilance,
                        String sBudget,
                        int idTypBudgetu,
                        int kategorie) throws KisException
  {
    int origPman = -1,
        origSpol = -1,
        origIdMngSeg = -1,
        origIdBoss = -1;
    if("U".equals(akce)) {
      origPman = getPuvodniHodnota(idProjekt,"IdPmanager");
      origSpol = getPuvodniHodnota(idProjekt,"IdKtgucetnispolecnost");
      origIdMngSeg = getPuvodniHodnota(idProjekt, "IdMngsegment");
      origIdBoss = getMngSegmentBoss(idProjekt);
    }
  
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_KpProjekt(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idProjekt);
      st.setString(3, nazev);
      st.setString(4, cisloOld);
      st.setInt(5, status);
      st.setInt(6, navrhuje);
      st.setInt(7, pman);
      if(mngSeg>0) st.setInt(8, mngSeg);
      else st.setNull(8, Types.INTEGER);
      st.setString(9, menaN);
      st.setDate(10, dtStartOceneni);
      st.setInt(11, freq);
      st.setString(12, popis);
      if(idNavrh>0)
        st.setInt(13, idNavrh);
      else
        st.setNull(13, Types.INTEGER);
      st.setDate(14, dtMDalsi);
      st.setInt(15, mMesicu);
      st.setString(16, userName);
      if(idTypBilance>0) st.setInt(17, idTypBilance);
      else st.setNull(17, Types.INTEGER);
      st.setString(18, sBudget);
      if(idTypBudgetu>0) st.setInt(19, idTypBudgetu);
      else st.setNull(19, Types.INTEGER);
      if(kategorie>0) st.setInt(20, kategorie);
      else st.setNull(20, Types.INTEGER);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_KpProjekt",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    Mail mail = new Mail();
    int idBoss = getMngSegmentBoss(mngSeg);
    if("I".equals(akce)) 
    {
      mail.sendNewProject(this, pman, nazev, mngSeg);
    }
    else if("U".equals(akce)) 
    {
/*esc 18.04.08*/
logger.debug("PROJEKT Nazev:"+nazev+"-mngSeg:"+mngSeg+"-origIdMngSeg:"+origIdMngSeg);	
      if(pman!=origPman) {
        mail.sendChngProject(this, pman, origPman, nazev, mngSeg);
      }
      if(mngSeg != origIdMngSeg) 
      {
/*esc 18.04.08*/
logger.debug("Volam mail.sendChngProjektMngSeg idProjekt"+idProjekt+" PROJEKT Nazev:"+nazev+" -mngSeg:"+mngSeg+" - getMngSegment(mngSeg)"+getMngSegment(mngSeg)+" -origIdMngSeg:"+origIdMngSeg+" getMngSegment(origIdMngSeg)"+getMngSegment(origIdMngSeg));	
        mail.sendChngProjektMngSeg(this,idProjekt,nazev,
                                   new int[]{origIdBoss,idBoss},
                                   getMngSegment(origIdMngSeg),
                                   getMngSegment(mngSeg),
                                   mngSeg,
                                   origIdMngSeg);
      }
    }
    /*
    if(origSpol!=idSpol) 
    {
      Set set = new HashSet();
      String spol = null;
      ViewObject vo = getKpKtgUcetnispolecnostView1();
      vo.clearCache();
      vo.setWhereClause("ID = "+(idSpol>0?idSpol:origSpol));
      while(vo.hasNext()) 
      {
        Row row = vo.next();
        spol = (String) row.getAttribute("SNazev");
        Number hlp = (Number) row.getAttribute("IdZodpovednaucetni");
        if(hlp!=null) set.add(hlp);
        hlp = (Number) row.getAttribute("IdOdpovednaosoba");
        if(hlp!=null) set.add(hlp);
        hlp = (Number) row.getAttribute("IdTopmng");
        if(hlp!=null) set.add(hlp);
        if(pman>0) {
          hlp = new Number(pman);
          set.add(hlp);
        }
      }
      vo.closeRowSet();
      mail.sendProjektSpolecnost(this, nazev, idProjekt, spol, set, idSpol>0);
    }
    */
  }

  public void kpProjektNavrh(String akce,
                              int idProjektNavrh,
                              String nazev,
                              int navrhuje,
                              String email,
                              int sponzor,
                              int pman,
                              String popis,
                              double vynos,
                              String menaV,
                              double naklad,
                              String menaN,
                              java.sql.Date dtZacatek,
                              java.sql.Date dtKonec) throws KisException
  {
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_KpProjektNavrh(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idProjektNavrh);
      st.setString(3, nazev);
      st.setInt(4, navrhuje);
      st.setString(5, email);
      st.setInt(6, sponzor);
      st.setInt(7, pman);
      st.setString(8, popis);
      st.setDouble(9, vynos);
      st.setString(10, menaV);
      st.setDouble(11, naklad);
      st.setString(12, menaN);
      st.setDate(13, dtZacatek);
      st.setDate(14, dtKonec);
      st.setString(15, userName);
      st.registerOutParameter(2, Types.INTEGER);
      st.execute();
      idProjektNavrh = st.getInt(2);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_KpProjektNavrh",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    if("I".equals(akce)) 
    {
      Mail mail = new Mail();
      mail.sendNewProjectNavrh(this, idProjektNavrh);
    }
  }

  public void kpProjektCashFlow(String akce,
                                int id,
                                int idProjekt,
                                int typ,
                                java.sql.Date datum,
                                double castka,
                                String mena,
                                String inout,
                                int inoutTyp,
                                String poznamka) throws KisException
  {
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_KpProjektCashFlow(?,?,?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, id);
      st.setInt(3, idProjekt);
      st.setInt(4, typ);
      st.setDate(5, datum);
      st.setDouble(6, castka);
      st.setString(7, mena);
      st.setString(8, inout);
      st.setInt(9, inoutTyp);
      st.setString(10, poznamka);
      st.setString(11, userName);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_KpProjektCashFlow",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  

  public void exportExcel(java.sql.Date datum) throws KisException 
  {
    ESExportProjekty ep = new ESExportProjekty(this, datum);
    try {
      ep.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  public void exportExcelCashFlow(java.sql.Date datum, int idProjekt) throws KisException 
  {
    ESExportProjektCashFlow ep = new ESExportProjektCashFlow(this, idProjekt, datum);
    try {
      ep.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  public void exportExcelCashFlowAll(java.sql.Date datum) throws KisException 
  {
    ESExportProjektCashFlowAll ep = new ESExportProjektCashFlowAll(this, datum);
    try {
      ep.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  public void exportExcelTransakce(java.sql.Date datum, int idProjekt) throws KisException 
  {
    ESExportProjektTransakce ep = new ESExportProjektTransakce(this, idProjekt, datum);
    try {
      ep.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  public void exportExcelTransakceAll(java.sql.Date datum) throws KisException 
  {
    ESExportProjektTransakceAll ep = new ESExportProjektTransakceAll(this, datum);
    try {
      ep.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  public void exportExcelSLDeveloper(java.sql.Date datum, int idProjekt) throws KisException 
  {
    ESExportProjektSLDeveloper ep = new ESExportProjektSLDeveloper(this, idProjekt, datum);
    try {
      ep.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  public void exportExcelUvery(java.sql.Date datum) throws KisException
  {
    ESExportUvery ep = new ESExportUvery(this, datum);
    try {
      ep.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }
  
  protected FileFilter getFileFilter(final String name) 
  {
    return new FileFilter() {
      public boolean accept(File pathname) 
      {
        return true;
      }
    };
  }

  private java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);
  
  public String getExcels() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_PROJEKTY;
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_PROJEKTY+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public String getExcelsCashFlow(int idProjekt) 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_PROJEKTY_CF+"\\"+idProjekt;
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_PROJEKTY_CF+"|5C"+idProjekt+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public String getExcelsTransakce(int idProjekt) 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_PROJEKTY_TRANSAKCE+"\\"+idProjekt;
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a href=\"FileDeleteOwn.jsp?file=data|5C"+Constants.DIR_PROJEKTY_TRANSAKCE+"|5C"+idProjekt+"|5C" + name + "\">DEL</a>&nbsp;");

        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_PROJEKTY_TRANSAKCE+"|5C"+idProjekt+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public String getExcelsSLDeveloper(int idProjekt) 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_PROJEKTY_SLDEV+"\\"+idProjekt;
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a href=\"FileDeleteOwn.jsp?file=data|5C"+Constants.DIR_PROJEKTY_SLDEV+"|5C"+idProjekt+"|5C" + name + "\">DEL</a>&nbsp;");

        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_PROJEKTY_SLDEV+"|5C"+idProjekt+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public String getExcelsUvery() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_UVERY+"\\";
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_UVERY+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  /**
   * 
   * Container's getter for KpLogProjektView1
   */
  public KpLogProjektViewImpl getKpLogProjektView1()
  {
    return (KpLogProjektViewImpl)findViewObject("KpLogProjektView1");
  }

  public void loadNaklady() throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_loadNaklady; end;",0);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_loadNaklady",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_processNaklady; end;",0);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_processNaklady",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpDatProjektnakladydetailView1
   */
  public KpDatProjektnakladydetailViewImpl getKpDatProjektnakladydetailView1()
  {
    return (KpDatProjektnakladydetailViewImpl)findViewObject("KpDatProjektnakladydetailView1");
  }

  private void insertRowFromMs(MsData data) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_insertRowFromMs(?,?,?,?,?,?,?); end;",0);
      st.setString(1, data.cisloOld);
      st.setString(2, data.popis);
      st.setDate(3, data.datum);
      st.setDouble(4, data.castka);
      st.setString(5, data.mena);
      st.setString(6, data.spolecnost);
      st.setString(7, data.dodavatele);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_insertRowFromMs",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  
  private void processDetailMs() throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_processDetailMs; end;",0);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_processDetailMs",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  
  public void loadDataFromMs(java.util.List list) throws KisException 
  {
    if(list==null) return;

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_cleanUp; end;",0);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_cleanUp",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    Iterator iter = list.iterator();
    while(iter.hasNext()) 
    {
      MsData data = (MsData) iter.next();
      insertRowFromMs(data);
    }

    processDetailMs();
  }
  
  public static void main(String[] argv) throws Exception
  {
    ProjektModuleImpl pm = (ProjektModuleImpl)Configuration.createRootApplicationModule("cz.jtbank.konsolidace.projekt.ProjektModule","ProjektModuleLocal");
    pm.loadDataFromMs(null);
  }

  /**
   * 
   * Container's getter for KpRelUcetniskupinaclenView1
   */
  public KpRelUcetniskupinaclenViewImpl getKpRelUcetniskupinaclenView1()
  {
    return (KpRelUcetniskupinaclenViewImpl)findViewObject("KpRelUcetniskupinaclenView1");
  }

  /**
   * 
   * Container's getter for KpRelAppuserProjektView1
   */
  public KpRelAppuserProjektViewImpl getKpRelAppuserProjektView1()
  {
    return (KpRelAppuserProjektViewImpl)findViewObject("KpRelAppuserProjektView1");
  }

  public void deleteUserProjekt(int userId) throws KisException
  {
    Statement st = getDBTransaction().createStatement(0);
    try 
    {
      st.execute("DELETE FROM DB_JT.KP_REL_APPUSER_PROJEKT WHERE ID_APPUSER = "+userId);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury deleteUserProjekt()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void deleteUserProjekt(int userId, int typ) throws KisException
  {
    Statement st = getDBTransaction().createStatement(0);
    try 
    {
      st.execute("DELETE FROM DB_JT.KP_REL_APPUSER_PROJEKT WHERE ID_APPUSER = "+userId+" AND ID_TYPPRAVA = "+typ);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury deleteUserProjekt()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  
  public void insertUserProjekt(int userId,
                                int idProjekt,
                                int typ) throws KisException
  {
    Statement st = getDBTransaction().createStatement(0);
    try 
    {
      ResultSet rs = st.executeQuery("SELECT COUNT(*) AS CNT FROM DB_JT.KP_REL_APPUSER_PROJEKT "+
        "WHERE ID_APPUSER = "+userId+" AND ID_KTGPROJEKT = "+idProjekt+" AND ID_TYPPRAVA = "+typ);
      if(rs.next()) 
      {
        if( rs.getInt("CNT") > 0 ) {
          rs.close();
          st.close();
          return;
        }
      }
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury insertUserProjekt()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    st = getDBTransaction().createStatement(0);
    try 
    {
      st.execute("INSERT INTO DB_JT.KP_REL_APPUSER_PROJEKT (ID_APPUSER,ID_KTGPROJEKT,ID_TYPPRAVA)"+
                 " VALUES ("+userId+","+idProjekt+","+typ+")");
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury insertUserProjekt()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void projektManagerDefault(int userId,int typ) throws KisException
  {
    if(userId == 0) return;

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_pravaNaProjekty(?,?); end;",0);
      st.setInt(1, userId);
      st.setInt(2, typ);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_pravaNaProjekty",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void setAllDefault(int userId,int typ) throws KisException
  {
    if(userId == 0) return;

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_pravaNaVsechnyProjekty(?,?); end;",0);
      st.setInt(1, userId);
      st.setInt(2, typ);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_pravaNaVsechnyProjekty",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }


  /**
   * 
   * Container's getter for KpKtgEmailzpravyView1
   */
  public KpKtgEmailzpravyViewImpl getKpKtgEmailzpravyView1()
  {
    return (KpKtgEmailzpravyViewImpl)findViewObject("KpKtgEmailzpravyView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektcashflowtypView1
   */
  public KpCisProjektcashflowtypViewImpl getKpCisProjektcashflowtypView1()
  {
    return (KpCisProjektcashflowtypViewImpl)findViewObject("KpCisProjektcashflowtypView1");
  }

  /**
   * 
   * Container's getter for KpDatProjektcashflowView1
   */
  public KpDatProjektcashflowViewImpl getKpDatProjektcashflowView1()
  {
    return (KpDatProjektcashflowViewImpl)findViewObject("KpDatProjektcashflowView1");
  }
  
  public boolean isCurrentUserAdmin(int idProjekt) 
  {
    boolean ret = false;
  
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    Number userId = null;

    if(Constants.ADMIN_USER.equals(user)) return true;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("S_USERID = '"+user+"'");
    if(voUser.hasNext()) 
    {
      Row rowUser = voUser.next();
      userId = (Number) rowUser.getAttribute("Id");
    }
    voUser.closeRowSet();
    if(userId == null) return false;
    
    ViewObject vo = getKpRelAppuserProjektView1();
    vo.clearCache();
    vo.setWhereClause("ID_KTGPROJEKT = "+idProjekt+" AND ID_APPUSER = "+userId+" AND ID_TYPPRAVA = 2");
    if(vo.hasNext()) 
    {
      ret = true;
    }
    vo.closeRowSet();
    
    return ret;
  }

  public boolean isCurrentUserPMan(int idProjekt) 
  {
    boolean ret = false;
  
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    Number userId = null;
    
    if(Constants.ADMIN_USER.equals(user)) return true;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("S_USERID = '"+user+"'");
    if(voUser.hasNext()) 
    {
      Row rowUser = voUser.next();
      userId = (Number) rowUser.getAttribute("Id");
    }
    voUser.closeRowSet();
    if(userId == null) return false;
    
    ViewObject vo = getKpKtgProjektView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idProjekt+" AND ID_PMANAGER = "+userId);
    if(vo.hasNext()) 
    {
      ret = true;
    }
    vo.closeRowSet();
    
    return ret;
  }

  public boolean isCurrentUserSS(int idProjekt) 
  {
    boolean ret = false;
  
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    Number userId = null;
    
    if(Constants.ADMIN_USER.equals(user)) return true;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("S_USERID = '"+user+"'");
    if(voUser.hasNext()) 
    {
      Row rowUser = voUser.next();
      userId = (Number) rowUser.getAttribute("Id");
    }
    voUser.closeRowSet();
    if(userId == null) return false;
    
    ViewObject vo = getKpKtgProjektView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idProjekt+" AND (ID_MNGSEGMENTBOSS = "+userId+" OR ID_MNGSEGMENTBOSS IN (select sz.ID_KOHO from db_jt.KP_DAT_SEGMENTZASTUP sz where sz.nl_typ = 1 and sz.id_kdo = "+userId+" and sysdate between sz.DT_PLATNOSTOD and sz.DT_PLATNOSTDO))");
    if(vo.hasNext()) 
    {
      ret = true;
    }
    vo.closeRowSet();
    
    return ret;
  }

  public void setUroven(int idProjekt,
                        double castka,
                        int uroven) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    String sql = "UPDATE DB_JT.KP_KTG_PROJEKT SET ND_DOCUROVEN"+uroven+"=? WHERE ID=?";
    try {
      st = dbTran.createCallableStatement(sql,0);
      st.setDouble(1,castka);
      st.setInt(2,idProjekt);
      st.execute();
      dbTran.commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhal update ND_DOCUROVEN"+uroven+" tab. DB_JT.KP_KTG_PROJEKT",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpEmailParamView1
   */
  public KpEmailParamViewImpl getKpEmailParamView1()
  {
    return (KpEmailParamViewImpl)findViewObject("KpEmailParamView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektinouttypView1
   */
  public KpCisProjektinouttypViewImpl getKpCisProjektinouttypView1()
  {
    return (KpCisProjektinouttypViewImpl)findViewObject("KpCisProjektinouttypView1");
  }

  /**
   * 
   * Container's getter for KpRelProjektcfexportView1
   */
  public KpRelProjektcfexportViewImpl getKpRelProjektcfexportView1()
  {
    return (KpRelProjektcfexportViewImpl)findViewObject("KpRelProjektcfexportView1");
  }

  public void setCashFlowExport(Map map) throws KisException
  {
    if(map == null || map.keySet() == null) return;
  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    String sql = "DELETE FROM DB_JT.KP_REL_PROJEKTCFEXPORT";
    try {
      st = dbTran.createCallableStatement(sql,0);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhal update DB_JT.KP_REL_PROJEKTCFEXPORT",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    sql = "INSERT INTO DB_JT.KP_REL_PROJEKTCFEXPORT (ID_PROJEKT, ID_TYP) VALUES (?,?)";
    try {
      st = dbTran.createCallableStatement(sql,0);
      Iterator iter = map.keySet().iterator();
      while(iter.hasNext()) {
        String idProjekt = (String) iter.next();
        String idTyp = (String) map.get(idProjekt);
        st.setInt(1,Integer.parseInt(idProjekt));
        st.setInt(2,Integer.parseInt(idTyp));
        st.execute();
      }
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhal update DB_JT.KP_REL_PROJEKTCFEXPORT",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpDatProjektcashflowExportView1
   */
  public KpDatProjektcashflowExportViewImpl getKpDatProjektcashflowExportView1()
  {
    return (KpDatProjektcashflowExportViewImpl)findViewObject("KpDatProjektcashflowExportView1");
  }

  /**
   * 
   * Container's getter for KpKtgProjektnavrhView1
   */
  public KpKtgProjektnavrhViewImpl getKpKtgProjektnavrhView1()
  {
    return (KpKtgProjektnavrhViewImpl)findViewObject("KpKtgProjektnavrhView1");
  }

  /**
   * 
   * Container's getter for VwKtgProjektnavrhView1
   */
  public VwKtgProjektnavrhViewImpl getVwKtgProjektnavrhView1()
  {
    return (VwKtgProjektnavrhViewImpl)findViewObject("VwKtgProjektnavrhView1");
  }

  /**
   * 
   * Container's getter for VwKpProjekttransakceView1
   */
  public VwKpProjekttransakceViewImpl getVwKpProjekttransakceView1()
  {
    return (VwKpProjekttransakceViewImpl)findViewObject("VwKpProjekttransakceView1");
  }

  /**
   * 
   * Container's getter for VwKtgProjektView1
   */
  public VwKtgProjektViewImpl getVwKtgProjektView1()
  {
    return (VwKtgProjektViewImpl)findViewObject("VwKtgProjektView1");
  }

  /**
   * 
   * Container's getter for VwDatProjekttransakcedocView1
   */
  public VwDatProjekttransakcedocViewImpl getVwDatProjekttransakcedocView1()
  {
    return (VwDatProjekttransakcedocViewImpl)findViewObject("VwDatProjekttransakcedocView1");
  }

  /**
   * 
   * Container's getter for VwKtgProjektuserpravaView1
   */
  public VwKtgProjektuserpravaViewImpl getVwKtgProjektuserpravaView1()
  {
    return (VwKtgProjektuserpravaViewImpl)findViewObject("VwKtgProjektuserpravaView1");
  }
  
  public void setAllPMan(int idCis) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_pravaNaProjektyAll(?); end;",0);
      st.setInt(1, idCis);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_pravaNaProjektyAll",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for VwKtgUverView1
   */
  public VwKtgUverViewImpl getVwKtgUverView1()
  {
    return (VwKtgUverViewImpl)findViewObject("VwKtgUverView1");
  }

  public void uverTypKategorie(int idRadek,
                               int typKat) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    Statement st = null;
    String extSys = null,
           extSys2 = null;
    try {
      st = dbTran.createStatement(0);
      ResultSet rs = st.executeQuery("SELECT TRIM(ID_EXTSYSTEM), TRIM(ID_EXTSYSTEM2) FROM DB_JT.VW_KTG_UVER WHERE ID = "+idRadek);
      if(rs.next()) 
      {
        extSys = rs.getString(1);
        extSys2 = rs.getString(2);
      }
      rs.close();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury uverTypKategorie - select",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    System.out.print("extSys="+extSys+",extSys2="+extSys2);

    int count = 0;
    try {
      st = dbTran.createStatement(0);
      ResultSet rs = st.executeQuery("SELECT COUNT(*) FROM DB_JT.KP_DAT_UVERMANUAL WHERE TRIM(ID_EXTSYSTEM) = '"+extSys+"' AND TRIM(ID_EXTSYSTEM2) = '"+extSys2+"'");
      if(rs.next()) 
      {
        count = rs.getInt(1);
      }
      rs.close();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury uverTypKategorie - select count",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    PreparedStatement pst = null;    
    try {
      if(typKat<1)
        pst = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_DAT_UVERMANUAL WHERE ID_TYPKATEGORIE <> ? AND TRIM(ID_EXTSYSTEM) = ? AND TRIM(ID_EXTSYSTEM2) = ?",0);
      else if(count==0)
        pst = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_DAT_UVERMANUAL (ID_TYPKATEGORIE, ID_EXTSYSTEM, ID_EXTSYSTEM2) VALUES (?,?,?)",0);
      else       
        pst = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_UVERMANUAL SET ID_TYPKATEGORIE = ? WHERE TRIM(ID_EXTSYSTEM) = ? AND TRIM(ID_EXTSYSTEM2) = ?",0);
      pst.setInt(1, typKat);
      pst.setString(2, extSys);
      pst.setString(3, extSys2);
      pst.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury uverTypKategorie - insert/delete/update",s);
    }
    finally {
      try {
        if (pst != null) pst.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }
  
  public Map getProjektyUvery()
  {
    Map map = new HashMap();
    ViewObject vo = getVwKtgUverView1();
    vo.clearCache();
    vo.setWhereClause("ID_DOKLAD = DB_JT.F_GETMAXDOKLAD(ID_KTGUCETNISPOLECNOST, TO_DATE('"+cz.jtbank.konsolidace.common.Utils.getLastDateMB()+"','dd.mm.yyyy')) "+
                      "and id_ktgprojekt is not null "+
                      "and id_ktgprojekt <> 1000001");
    vo.setOrderByClause("ID_KTGPROJEKT, S_POPIS");
    while(vo.hasNext()) 
    {
      Row row = vo.next();
      Number idProjekt = (Number) row.getAttribute("IdKtgprojekt");
      Number id = (Number) row.getAttribute("Id");
      String popis = (String) row.getAttribute("SPopis");
      Object[] par = new Object[] {id, popis};
      List list = null;
      if(map.containsKey(idProjekt)) list = (List) map.get(idProjekt);
      else {
        list = new ArrayList();
        map.put(idProjekt,list);
      }
      list.add(par);
    }
    vo.closeRowSet();
    
    return map;
  }

  public void kpRelProjektUcSpol(String akce,
                                 int idProjekt,
                                 int idUcSpol,
                                 java.sql.Date matkaOd,
                                 java.sql.Date matkaDo) throws KisException
  {
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_KpRelProjektUcSpol(?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idProjekt);
      st.setInt(3, idUcSpol);
      st.setString(4, userName);
      st.setDate(5, matkaOd);
      st.setDate(6, matkaDo);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_KpRelProjektUcSpol",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    Set set = new HashSet();
    String projekt = null;
    Number pman = null;
    Number idSegProj=null, idSegSpol=null;
    ViewObject voProj = getKpKtgProjektView1();
    voProj.clearCache();
    voProj.setWhereClause("ID = "+idProjekt);
    if(voProj.hasNext()) 
    {
      Row row = voProj.next();
      projekt = (String) row.getAttribute("SNazev");
      pman = (Number) row.getAttribute("IdPmanager");
      if(pman!=null) set.add(pman);
      idSegProj = (Number) row.getAttribute("IdMngsegment");
      Number hlp = (Number) row.getAttribute("IdMngsegmentboss");
      if(hlp!=null) set.add(hlp);
    }
    voProj.closeRowSet();
    
    String spol = null;
    ViewObject vo = getKpKtgUcetnispolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idUcSpol);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      spol = (String) row.getAttribute("SNazev");
      Number hlp = (Number) row.getAttribute("IdZodpovednaucetni");
      if(hlp!=null) set.add(hlp);
      hlp = (Number) row.getAttribute("IdOdpovednaosoba");
      if(hlp!=null) set.add(hlp);
      //hlp = (Number) row.getAttribute("IdTopmng");
      //if(hlp!=null) set.add(hlp);
      hlp = (Number) row.getAttribute("IdMngsegmentboss");
      if(hlp!=null) set.add(hlp);
      idSegSpol = (Number) row.getAttribute("IdMngsegment");
    }
    vo.closeRowSet();
    
    String pmanJmeno = null;
    ViewObject voJmeno = getKtgAppuserView1();
    voJmeno.clearCache();
    voJmeno.setWhereClause("ID = "+pman);
    if(voJmeno.hasNext()) 
    {
      Row row = voJmeno.next();
      pmanJmeno = row.getAttribute("SKrestni") + " " + row.getAttribute("SPrijmeni");
    }
    voJmeno.closeRowSet();    
    
    String segProj = null, segSpol = null;
    ViewObject voSeg = getKpCisMngsegmentView1();
    voSeg.clearCache();
    voSeg.setWhereClause("ID = "+idSegProj);
    if(voSeg.hasNext()) 
    {
      Row row = voSeg.next();
      segProj = (String)row.getAttribute("SPopis");
    }
    voSeg.closeRowSet();    
    voSeg.setWhereClause("ID = "+idSegSpol);
    if(voSeg.hasNext()) 
    {
      Row row = voSeg.next();
      segSpol = (String)row.getAttribute("SPopis");
    }
    voSeg.closeRowSet();    
    
    Mail mail = new Mail();
    mail.sendProjektSpolecnost(this, projekt, idProjekt, pmanJmeno, spol, set, akce, segProj, segSpol);
  }

  public void setPouzitHv(int idProjekt,
                          int idUcSpol) throws KisException
  {
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_setPouzitHv(?,?,?); end;",0);
      st.setInt(1, idProjekt);
      st.setInt(2, idUcSpol);
      st.setString(3, userName);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_setPouzitHv",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpRelProjektucspolView1
   */
  public KpRelProjektucspolViewImpl getKpRelProjektucspolView1()
  {
    return (KpRelProjektucspolViewImpl)findViewObject("KpRelProjektucspolView1");
  }

  /**
   * 
   * Container's getter for KpKtgProjektmemorandumView1
   */
  public KpKtgProjektmemorandumViewImpl getKpKtgProjektmemorandumView1()
  {
    return (KpKtgProjektmemorandumViewImpl)findViewObject("KpKtgProjektmemorandumView1");
  }

  /**
   * 
   * Container's getter for KpDatProjektmemorandumzpravaView1
   */
  public KpDatProjektmemorandumzpravaViewImpl getKpDatProjektmemorandumzpravaView1()
  {
    return (KpDatProjektmemorandumzpravaViewImpl)findViewObject("KpDatProjektmemorandumzpravaView1");
  }

  public void memoradnum(int idProjekt,
                         String cil,
                         String zacleneni,
                         String vstup) throws KisException
  {
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_KpProjektMemoradnum(?,?,?,?,?); end;",0);
      st.setInt(1, idProjekt);
      st.setString(2, cil);
      st.setString(3, zacleneni);
      st.setString(4, vstup);
      st.setString(5, userName);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_KpProjektMemoradnum",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void memoradnumZprava(int id,
                               int idProjekt,
                               java.sql.Date datum,
                               String zprava) throws KisException
  {
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projekt.p_KpProjektMemorandumZprava(?,?,?,?,?); end;",0);
      st.setInt(1, id);
      st.setInt(2, idProjekt);
      st.setDate(3, datum);
      st.setString(4, zprava);
      st.setString(5, userName);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projekt.p_KpProjektMemorandumZprava",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for VwRelProjektappuserView1
   */
  public VwRelProjektappuserViewImpl getVwRelProjektappuserView1()
  {
    return (VwRelProjektappuserViewImpl)findViewObject("VwRelProjektappuserView1");
  }

  /**
   * 
   * Container's getter for VwLogProjektView1
   */
  public VwLogProjektViewImpl getVwLogProjektView1()
  {
    return (VwLogProjektViewImpl)findViewObject("VwLogProjektView1");
  }

  /**
   * 
   * Container's getter for KpCisIfrssegmentView1
   */
  public KpCisIfrssegmentViewImpl getKpCisIfrssegmentView1()
  {
    return (KpCisIfrssegmentViewImpl)findViewObject("KpCisIfrssegmentView1");
  }

  /**
   * 
   * Container's getter for KpCisIfrssubsegmentView1
   */
  public KpCisIfrssubsegmentViewImpl getKpCisIfrssubsegmentView1()
  {
    return (KpCisIfrssubsegmentViewImpl)findViewObject("KpCisIfrssubsegmentView1");
  }

  /**
   * 
   * Container's getter for KpCisMngsegmentView1
   */
  public KpCisMngsegmentViewImpl getKpCisMngsegmentView1()
  {
    return (KpCisMngsegmentViewImpl)findViewObject("KpCisMngsegmentView1");
  }

  /**
   * 
   * Container's getter for VwDatMistransakceView1
   */
  public VwDatMistransakceViewImpl getVwDatMistransakceView1()
  {
    return (VwDatMistransakceViewImpl)findViewObject("VwDatMistransakceView1");
  }

  /**
   * 
   * Container's getter for VwKtgUversplatkyView1
   */
  public VwKtgUversplatkyViewImpl getVwKtgUversplatkyView1()
  {
    return (VwKtgUversplatkyViewImpl)findViewObject("VwKtgUversplatkyView1");
  }

  /**
   * 
   * Container's getter for VwKtgUversplatkyhistView1
   */
  public VwKtgUversplatkyhistViewImpl getVwKtgUversplatkyhistView1()
  {
    return (VwKtgUversplatkyhistViewImpl)findViewObject("VwKtgUversplatkyhistView1");
  }

  public int getMaxDoklad(int idSpol,
                          java.sql.Date datum,
                          int krok) throws KisException
  {
    int idDoklad = 0;
    if(datum == null) datum = new java.sql.Date(System.currentTimeMillis());
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin ? := db_jt.f_getMaxDoklad(?,?,?); end;",0);
      st.registerOutParameter(1, Types.INTEGER);
      st.setInt(2, idSpol);
      st.setDate(3, datum);
      st.setInt(4, krok);
      st.execute();
      idDoklad = st.getInt(1);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.f_getMaxDoklad",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    return idDoklad;
  }

  /**
   * 
   * Container's getter for KpCisTypprojektovebilanceView1
   */
  public KpCisTypprojektovebilanceViewImpl getKpCisTypprojektovebilanceView1()
  {
    return (KpCisTypprojektovebilanceViewImpl)findViewObject("KpCisTypprojektovebilanceView1");
  }

  /**
   * 
   * Container's getter for KpCisTypbudgetuprojektuView1
   */
  public KpCisTypbudgetuprojektuViewImpl getKpCisTypbudgetuprojektuView1()
  {
    return (KpCisTypbudgetuprojektuViewImpl)findViewObject("KpCisTypbudgetuprojektuView1");
  }

  /**
   * 
   * Container's getter for KpDatProjektdokladdenikView1
   */
  public KpDatProjektdokladdenikViewImpl getKpDatProjektdokladdenikView1()
  {
    return (KpDatProjektdokladdenikViewImpl)findViewObject("KpDatProjektdokladdenikView1");
  }

  /**
   * 
   * Container's getter for KpDatMngsegmentbossView1
   */
  public KpDatMngsegmentbossViewImpl getKpDatMngsegmentbossView1()
  {
    return (KpDatMngsegmentbossViewImpl)findViewObject("KpDatMngsegmentbossView1");
  }

  /**
   * 
   * Container's getter for VwDatSlprojektdeveloperView1
   */
  public VwDatSlprojektdeveloperViewImpl getVwDatSlprojektdeveloperView1()
  {
    return (VwDatSlprojektdeveloperViewImpl)findViewObject("VwDatSlprojektdeveloperView1");
  }

  public void deleteProjektBilance(int idProjektDoklad) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_projektDoklad.p_deleteProjektDoklad(?); end;",0);
      st.setInt(1, idProjektDoklad);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_projektDoklad.p_deleteProjektDoklad",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for VwKtgProjektsimpleView1
   */
  public VwKtgProjektsimpleViewImpl getVwKtgProjektsimpleView1()
  {
    return (VwKtgProjektsimpleViewImpl)findViewObject("VwKtgProjektsimpleView1");
  }

  /**
   * 
   * Container's getter for VwKtgProjektOverviewView1
   */
  public VwKtgProjektOverviewViewImpl getVwKtgProjektOverviewView1()
  {
    return (VwKtgProjektOverviewViewImpl)findViewObject("VwKtgProjektOverviewView1");
  }

  /**
   * 
   * Container's getter for VwKtgProjektuserpravaOverviewView1
   */
  public VwKtgProjektuserpravaOverviewViewImpl getVwKtgProjektuserpravaOverviewView1()
  {
    return (VwKtgProjektuserpravaOverviewViewImpl)findViewObject("VwKtgProjektuserpravaOverviewView1");
  }
}
