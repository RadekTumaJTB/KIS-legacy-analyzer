package cz.jtbank.konsolidace.users;
import java.sql.*;
import oracle.jbo.*;
import oracle.jbo.client.*;
import oracle.jbo.server.ApplicationModuleImpl;
import cz.jtbank.konsolidace.common.*;
import cz.jtbank.konsolidace.xml.*;
import javax.xml.parsers.*;
import org.xml.sax.*;
import org.xml.sax.helpers.*;
import java.io.*;
import java.util.*;
import cz.jtbank.konsolidace.doklady.ViewJtSpolImpl;
import cz.jtbank.konsolidace.doklady.KpKtgUcetnispolecnostViewImpl;
import oracle.jbo.domain.Number;
import oracle.jbo.server.DBTransaction;
import cz.jtbank.konsolidace.ucskup.KpKtgUcetniskupinaViewImpl;
//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---------------------------------------------------------------

public class UsersModuleImpl extends ApplicationModuleImpl implements cz.jtbank.konsolidace.users.common.UsersModule 
{
  /**
   * 
   * This is the default constructor (do not remove)
   */
  public UsersModuleImpl()
  {
  }


  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
  public static void main(String[] args)
  {
    launchTester("cz.jtbank.konsolidace.users", "UsersModuleLocal");
  }
  
  public void usersJaznXmlToDb() throws KisException
  {
    if(System.getProperty("org.xml.sax.driver")==null) {
      System.setProperty("org.xml.sax.driver","oracle.xml.parser.v2.SAXParser");
    }
    FileInputStream fis = null;
    UsersHandler uh = new UsersHandler();
    try {
      fis = new FileInputStream(Constants.JAZN_XML_FILE);
      byte[] data = new byte[ fis.available() ];
      fis.read(data);
      fis.close();
         
      String xmlDoc = new String ( data ).trim();
   
      ByteArrayInputStream byteIS = new ByteArrayInputStream ( xmlDoc.getBytes() );
    
      XMLReader saxParser = XMLReaderFactory.createXMLReader();
      saxParser.setContentHandler( uh );
      saxParser.parse( new InputSource ( byteIS ) );
    }
    catch (Exception e) {
      e.printStackTrace();
      return;
    }

    Map map = uh.getParsedData();
    Iterator iter = map.keySet().iterator();
    while(iter.hasNext()) 
    {
      String id = (String) iter.next();
      String name = (String) map.get(id);
      appUser(id, name);
    }
/*    
    ViewObject vo = getKtgAppuserView1();
    while(iter.hasNext()) 
    {
      String id = (String) iter.next();
      String name = (String) map.get(id);
      vo.setWhereClause("S_USERID = '"+id+"'");
      RowSet rs = vo.getRowSet();
      if(vo.hasNext()) {
        Row row = rs.next();
        row.setAttribute("SUsername",name);
      }
      else {
        Row row = rs.createRow();
        row.setAttribute("Id",null);
        row.setAttribute("SUserid",id);
        row.setAttribute("SUsername",name);
      }
      vo.closeRowSet();
    }
*/
    }

  public void savePassword(String pwd) throws KisException
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
System.out.println(user);      

    String newPwd = null;
    
    try {
      oracle.security.jazn.realm.RealmManager realmMgr = oracle.security.jazn.JAZNContext.getRealmManager(); 
      oracle.security.jazn.realm.Realm realm = realmMgr.getRealm("jazn.com"); 
      oracle.security.jazn.realm.UserManager userMgr = realm.getUserManager(); 
      oracle.security.jazn.spi.xml.XMLRealmUser xmlrealmuser = (oracle.security.jazn.spi.xml.XMLRealmUser)userMgr.getUser(user); 
      if(xmlrealmuser == null) 
      throw new KisException("Chyba pøi zápisu hesla!!!"); 
      
      //xmlrealmuser.setCredentials("test", "test");
      xmlrealmuser.setCredentialsNoCheck(pwd);
      userMgr.refresh();
      java.io.StringWriter sw = new java.io.StringWriter();
      xmlrealmuser.writeXML(sw);
      sw.close();
      
      newPwd = sw.toString();
    }
    catch (Exception e) {
      e.printStackTrace();
      throw new KisException("Chyba v savePassword :", e);
    }

    String userTag = "<name>"+user+"</name>";
  
    String xmlDoc = null;
    FileInputStream fis = null;
    try {
      fis = new FileInputStream(Constants.JAZN_XML_FILE);
      byte[] data = new byte[ fis.available() ];
      fis.read(data);
      fis.close();
         
      xmlDoc = new String ( data ).trim();
    }
    catch (Exception e) {
      e.printStackTrace();
      throw new KisException("Chyba v savePassword :", e);
    }
      
    int index = xmlDoc.indexOf(userTag);
  
    int indexStart = xmlDoc.indexOf("<credentials>",index)+13;
    int indexEnd = xmlDoc.indexOf("</credentials>",indexStart);
    //String credOrig = xmlDoc.substring(indexStart,indexEnd);

    int newIndexStart = newPwd.indexOf("<credentials>")+13;
    int newIndexEnd = newPwd.indexOf("</credentials>",newIndexStart);
    String credNew = newPwd.substring(newIndexStart,newIndexEnd);
    
    String xmlDocNew = xmlDoc.substring(0,indexStart) + credNew + xmlDoc.substring(indexEnd);
    
    java.io.File f = new java.io.File(Constants.JAZN_XML_FILE);
    
    String backupName = Constants.JAZN_XML_FILE+System.currentTimeMillis();
    java.io.File fBackup = new java.io.File(backupName);
    try {
      f.renameTo(fBackup);
      FileWriter fw = new FileWriter(f);
      //FileWriter fw = new FileWriter(fBackup);//to be removed
      fw.write(xmlDocNew);
      fw.close();
    }
    catch (Exception e) {
      e.printStackTrace();
      throw new KisException("Chyba v savePassword :", e);
    }
  }
    
  private void appUser(String id, String name) throws KisException
  {  
    Statement st = null;
    try 
    {
      st = getDBTransaction().createStatement(0);
      java.sql.ResultSet rs = st.executeQuery("SELECT COUNT(*) AS CNT FROM DB_JT.KTG_APPUSER"+
                                              " WHERE S_USERID = '"+id+"'");
      int cnt = 0;
      if(rs.next()) 
      {
        cnt = rs.getInt("CNT");
      }
      rs.close();
      st.close();
      st = getDBTransaction().createStatement(0);
      if(cnt > 0) 
      {
        st.execute("UPDATE DB_JT.KTG_APPUSER SET S_USERNAME = '"+name+"'"+
                   " WHERE S_USERID = '"+id+"'");
      }
      else 
      {
        st.execute("INSERT INTO DB_JT.KTG_APPUSER (S_USERID,S_USERNAME)"+
                   " VALUES ('"+id+"','"+name+"')");
      }
      st.close();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury usersJaznXmlToDb()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    getDBTransaction().commit();
  }

  /**
   * 
   * Container's getter for KpRelAppuserSpolecnostpravoView1
   */
  public KpRelAppuserSpolecnostpravoViewImpl getKpRelAppuserSpolecnostpravoView1()
  {
    return (KpRelAppuserSpolecnostpravoViewImpl)findViewObject("KpRelAppuserSpolecnostpravoView1");
  }

  /**
   * 
   * Container's getter for ViewJtSpol1
   */
  public ViewJtSpolImpl getViewJtSpol1()
  {
    return (ViewJtSpolImpl)findViewObject("ViewJtSpol1");
  }

  /**
   * 
   * Container's getter for KpCisSpolecnostpravoView1
   */
  public KpCisSpolecnostpravoViewImpl getKpCisSpolecnostpravoView1()
  {
    return (KpCisSpolecnostpravoViewImpl)findViewObject("KpCisSpolecnostpravoView1");
  }
  
  public void deleteUserSpol(String user) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_deletePravaNaSpolecnosti(?,?); end;",0);
      st.setString(1, user);
      st.setString(2, cz.jtbank.konsolidace.common.Utils.getUserName(this, false));
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_guiv.p_deletePravaNaSpolecnosti",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void insertUserSpol(String user,
                             int idSpol,
                             int idCis) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_insertPravoNaSpolecnost(?,?,?,?); end;",0);
      st.setString(1, user);
      st.setInt(2, idSpol);
      st.setInt(3, idCis);
      st.setString(4, cz.jtbank.konsolidace.common.Utils.getUserName(this, false));
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_guiv.p_insertPravoNaSpolecnost",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void deleteUserSpol(String user, int idCis, String vcetne) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_deletePravaNaSpolecnosti(?,?,?,?); end;",0);
      st.setString(1, user);
      st.setInt(2, idCis);
      st.setString(3, vcetne);
      st.setString(4, cz.jtbank.konsolidace.common.Utils.getUserName(this, false));
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_guiv.p_deletePravaNaSpolecnosti (2)",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KtgAppuserView1
   */
  public KtgAppuserViewImpl getKtgAppuserView1()
  {
    return (KtgAppuserViewImpl)findViewObject("KtgAppuserView1");
  }
  
  public void ucetniOdpovednaDefault(String user, int idCis, String vcetne) throws KisException
  {
    if(user == null || idCis == 0) return;
  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_pravaNaSpolecnosti(?,?,?,?); end;",0);
      st.setString(1, user);
      st.setInt(2, idCis);
      st.setString(3, vcetne );
      st.setString(4, cz.jtbank.konsolidace.common.Utils.getUserName(this, false));
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_guiv.p_pravaNaSpolecnosti",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void setAllDefault(String user, int idCis, String vcetne) throws KisException
  {
    if(user == null || idCis == 0) return;
  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_pravaNaVsechnySpolecnosti(?,?,?,?); end;",0);
      st.setString(1, user);
      st.setInt(2, idCis);
      st.setString(3, vcetne );
      st.setString(4, cz.jtbank.konsolidace.common.Utils.getUserName(this, false));
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_guiv.p_pravaNaVsechnySpolecnosti",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  
  private Map vyjimky = new HashMap();
  
  private void setVyjimky() 
  {
    vyjimky.clear();
  
    ViewObject vo = getKpTmpAppuserspolVyjimkyView1();
    vo.clearCache();
    while(vo.hasNext()) 
    {
      Row row = vo.next();
      Number userId = (Number) row.getAttribute("IdAppuser");
      String vsechno = (String) row.getAttribute("CVsechno");
      vyjimky.put(userId, vsechno);
    }
    vo.closeRowSet();
  }
  
  public void setAllUcOdAd(int idCis, String vcetne) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_pravaNaSpolecnostiAll(?,?,?); end;",0);
      st.setInt(1, idCis);
      st.setString(2, vcetne );
      st.setString(3, cz.jtbank.konsolidace.common.Utils.getUserName(this, false));
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_guiv.p_pravaNaSpolecnostiAll",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  
  public void setUserSpolKategorie(String user, int idCis, int[] katArr, String vcetne) throws KisException
  {
    if(katArr == null || katArr.length==0) return;
  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;

    for(int i=0; i<katArr.length; i++) {
      try {
        st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_pravaNaSpolecnostiKategorie(?,?,?,?,?); end;",0);
        st.setString(1, user);
        st.setInt(2, idCis);
        st.setInt(3, katArr[i]);
        st.setString(4, vcetne );
        st.setString(5, cz.jtbank.konsolidace.common.Utils.getUserName(this, false));
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury db_jt.kap_guiv.p_pravaNaSpolecnostiKategorie",s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
  }

  public void setUserKonsSkupina(String user, int idCis, int idSkup) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_pravaNaSpolecnostiSkupiny(?,?,?,?); end;",0);
      st.setString(1, user);
      st.setInt(2, idCis);
      st.setInt(3, idSkup);
      st.setString(4, cz.jtbank.konsolidace.common.Utils.getUserName(this, false));
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_guiv.p_pravaNaSpolecnostiSkupiny",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostView1
   */
  public KpKtgUcetnispolecnostViewImpl getKpKtgUcetnispolecnostView1()
  {
    return (KpKtgUcetnispolecnostViewImpl)findViewObject("KpKtgUcetnispolecnostView1");
  }

  /**
   * 
   * Container's getter for KpKtgEmailzpravyView1
   */
  public KpKtgEmailzpravyViewImpl getKpKtgEmailzpravyView1()
  {
    return (KpKtgEmailzpravyViewImpl)findViewObject("KpKtgEmailzpravyView1");
  }

  /**
   * 
   * Container's getter for KpCisEmailzpravyView1
   */
  public KpCisEmailzpravyViewImpl getKpCisEmailzpravyView1()
  {
    return (KpCisEmailzpravyViewImpl)findViewObject("KpCisEmailzpravyView1");
  }
  
  public void deleteEmailUser(int userId, int typeId) throws KisException 
  {
    Statement st = getDBTransaction().createStatement(0);
    try 
    {
      st.execute("DELETE FROM DB_JT.KP_KTG_EMAILZPRAVY WHERE ID_KTGAPPUSER = "+userId+" AND ID_MSGTYPE = "+typeId);
      getTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury deleteEmailUser()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void insertEmailUser(int userId, int typeId) throws KisException 
  {
    Statement st = getDBTransaction().createStatement(0);
    try 
    {
      st.execute("INSERT INTO DB_JT.KP_KTG_EMAILZPRAVY (ID_KTGAPPUSER, ID_MSGTYPE) VALUES ("+userId+", "+typeId+")");
      getTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury insertEmailUser()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpTmpAppuserspolVyjimkyView1
   */
  public KpTmpAppuserspolVyjimkyViewImpl getKpTmpAppuserspolVyjimkyView1()
  {
    return (KpTmpAppuserspolVyjimkyViewImpl)findViewObject("KpTmpAppuserspolVyjimkyView1");
  }

  /**
   * 
   * Container's getter for KtgAppuserNadrizenaView1
   */
  public KtgAppuserNadrizenaViewImpl getKtgAppuserNadrizenaView1()
  {
    return (KtgAppuserNadrizenaViewImpl)findViewObject("KtgAppuserNadrizenaView1");
  }

  /**
   * 
   * Container's getter for KtgAppuserNadrizenaView2
   */
  public KtgAppuserNadrizenaViewImpl getKtgAppuserNadrizenaView2()
  {
    return (KtgAppuserNadrizenaViewImpl)findViewObject("KtgAppuserNadrizenaView2");
  }

  public void setNadrizenaUcetni(int id, int idNadrizena) throws KisException
  {  
    PreparedStatement st = null;
    try 
    {
      st = getDBTransaction().createPreparedStatement("UPDATE DB_JT.KTG_APPUSER SET ID_NADRIZENAUCETNI = ? WHERE ID = ?",0);
      if(idNadrizena>0) st.setInt(1, idNadrizena);
      else st.setNull(1, Types.INTEGER);
      st.setInt(2, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury setNadrizenaUcetni()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    getDBTransaction().commit();
  }


  /**
   * 
   * Container's getter for KtgAppuserEditView1
   */
  public KtgAppuserEditViewImpl getKtgAppuserEditView1()
  {
    return (KtgAppuserEditViewImpl)findViewObject("KtgAppuserEditView1");
  }

  /**
   * 
   * Container's getter for KpKtgUcetniskupinaView1
   */
  public KpKtgUcetniskupinaViewImpl getKpKtgUcetniskupinaView1()
  {
    return (KpKtgUcetniskupinaViewImpl)findViewObject("KpKtgUcetniskupinaView1");
  }

  /**
   * 
   * Container's getter for KpRelAppuserskupinaView1
   */
  public KpRelAppuserskupinaViewImpl getKpRelAppuserskupinaView1()
  {
    return (KpRelAppuserskupinaViewImpl)findViewObject("KpRelAppuserskupinaView1");
  }

  public void appuserSkupina(String akce,
                             int idSkupina,
                             int idUser) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_REL_APPUSERSKUPINA "+
                                            "(ID_UCETNISKUPINA, ID_KTGAPPUSER) "+
                                            "VALUES (?,?)",0);
        st.setInt(1, idSkupina);
        st.setInt(2, idUser);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury appuserSkupina akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_REL_APPUSERSKUPINA "+
                                            "WHERE ID_UCETNISKUPINA=? AND ID_KTGAPPUSER=?",0);
        st.setInt(1, idSkupina);
        st.setInt(2, idUser);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury appuserSkupina akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  public void appuserVyjimky(String akce,
                             int idUser,
                             String vsechno) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_TMP_APPUSERSPOL_VYJIMKY "+
                                            "(ID_APPUSER, C_VSECHNO) "+
                                            "VALUES (?,?)",0);
        st.setInt(1, idUser);
        st.setString(2, vsechno);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury appuserVyjimky akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_TMP_APPUSERSPOL_VYJIMKY "+
                                            "SET C_VSECHNO=? "+
                                            "WHERE ID_APPUSER=?",0);
        st.setString(1, vsechno);
        st.setInt(2, idUser);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury appuserVyjimky akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_TMP_APPUSERSPOL_VYJIMKY "+
                                            "WHERE ID_APPUSER=?",0);
        st.setInt(1, idUser);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury appuserVyjimky akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KtgAppuserIExterniView1
   */
  public KtgAppuserIExterniViewImpl getKtgAppuserIExterniView1()
  {
    return (KtgAppuserIExterniViewImpl)findViewObject("KtgAppuserIExterniView1");
  }
}