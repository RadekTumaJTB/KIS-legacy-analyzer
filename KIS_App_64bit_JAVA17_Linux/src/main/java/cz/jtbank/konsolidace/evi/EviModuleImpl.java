package cz.jtbank.konsolidace.evi;
import oracle.jbo.server.ApplicationModuleImpl;
import oracle.jbo.server.ViewLinkImpl;
import cz.jtbank.konsolidace.ucskup.KpCisStatViewImpl;
import cz.jtbank.konsolidace.users.KtgAppuserViewImpl;
import oracle.jbo.server.DBTransaction;
import java.sql.*;
import cz.jtbank.konsolidace.common.KisException;
import cz.jtbank.konsolidace.doklady.KpKtgUcetnispolecnostViewImpl;
import oracle.jbo.ViewObject;
import oracle.jbo.Row;
import cz.jtbank.konsolidace.mail.Mail;
import java.util.*;
import oracle.jbo.domain.Number;
import cz.jtbank.konsolidace.doklady.KpEmailParamViewImpl;
import cz.jtbank.konsolidace.protistrany.KpKtgSpolecnostViewImpl;
import cz.jtbank.konsolidace.protistrany.VwProtistranadetailViewImpl;
import cz.jtbank.konsolidace.users.KpKtgEmailzpravyViewImpl;
import cz.jtbank.konsolidace.ifrs.KpDatMngsegmentbossViewImpl;
import cz.jtbank.konsolidace.fininv.KpCisMenaViewImpl;
import java.io.*;
import cz.jtbank.konsolidace.excel.*;
import cz.jtbank.konsolidace.common.Constants;

//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---------------------------------------------------------------

public class EviModuleImpl extends ApplicationModuleImpl implements cz.jtbank.konsolidace.evi.common.EviModule 
{
  /**
   * 
   * This is the default constructor (do not remove)
   */
  public EviModuleImpl()
  {
  }

  /**
   * 
   * Container's getter for KpCisEvidoidentifikaceView1
   */
  public KpCisEvidoidentifikaceViewImpl getKpCisEvidoidentifikaceView1()
  {
    return (KpCisEvidoidentifikaceViewImpl)findViewObject("KpCisEvidoidentifikaceView1");
  }

  /**
   * 
   * Container's getter for KpCisEvidovaneinformaceView1
   */
  public KpCisEvidovaneinformaceViewImpl getKpCisEvidovaneinformaceView1()
  {
    return (KpCisEvidovaneinformaceViewImpl)findViewObject("KpCisEvidovaneinformaceView1");
  }

  /**
   * 
   * Container's getter for KpCisEviobchodnirejstrikView1
   */
  public KpCisEviobchodnirejstrikViewImpl getKpCisEviobchodnirejstrikView1()
  {
    return (KpCisEviobchodnirejstrikViewImpl)findViewObject("KpCisEviobchodnirejstrikView1");
  }

  /**
   * 
   * Container's getter for KpCisEvistatusView1
   */
  public KpCisEvistatusViewImpl getKpCisEvistatusView1()
  {
    return (KpCisEvistatusViewImpl)findViewObject("KpCisEvistatusView1");
  }

  /**
   * 
   * Container's getter for KpCisEvitypstatzastupceView1
   */
  public KpCisEvitypstatzastupceViewImpl getKpCisEvitypstatzastupceView1()
  {
    return (KpCisEvitypstatzastupceViewImpl)findViewObject("KpCisEvitypstatzastupceView1");
  }

  /**
   * 
   * Container's getter for KpDatEvibankyView1
   */
  public KpDatEvibankyViewImpl getKpDatEvibankyView1()
  {
    return (KpDatEvibankyViewImpl)findViewObject("KpDatEvibankyView1");
  }

  /**
   * 
   * Container's getter for KpDatEvidoidentifikaceView1
   */
  public KpDatEvidoidentifikaceViewImpl getKpDatEvidoidentifikaceView1()
  {
    return (KpDatEvidoidentifikaceViewImpl)findViewObject("KpDatEvidoidentifikaceView1");
  }

  /**
   * 
   * Container's getter for KpDatEvidokumentView1
   */
  public KpDatEvidokumentViewImpl getKpDatEvidokumentView1()
  {
    return (KpDatEvidokumentViewImpl)findViewObject("KpDatEvidokumentView1");
  }

  /**
   * 
   * Container's getter for KpDatEvikomisionarskesmlouvyView1
   */
  public KpDatEvikomisionarskesmlouvyViewImpl getKpDatEvikomisionarskesmlouvyView1()
  {
    return (KpDatEvikomisionarskesmlouvyViewImpl)findViewObject("KpDatEvikomisionarskesmlouvyView1");
  }

  /**
   * 
   * Container's getter for KpDatEvikorespondenceView1
   */
  public KpDatEvikorespondenceViewImpl getKpDatEvikorespondenceView1()
  {
    return (KpDatEvikorespondenceViewImpl)findViewObject("KpDatEvikorespondenceView1");
  }

  /**
   * 
   * Container's getter for KpDatEviobchodnirejstrikView1
   */
  public KpDatEviobchodnirejstrikViewImpl getKpDatEviobchodnirejstrikView1()
  {
    return (KpDatEviobchodnirejstrikViewImpl)findViewObject("KpDatEviobchodnirejstrikView1");
  }

  /**
   * 
   * Container's getter for KpDatEvizplnomocneniView1
   */
  public KpDatEvizplnomocneniViewImpl getKpDatEvizplnomocneniView1()
  {
    return (KpDatEvizplnomocneniViewImpl)findViewObject("KpDatEvizplnomocneniView1");
  }

  /**
   * 
   * Container's getter for KpKtgEviadminspolecnostView1
   */
  public KpKtgEviadminspolecnostViewImpl getKpKtgEviadminspolecnostView1()
  {
    return (KpKtgEviadminspolecnostViewImpl)findViewObject("KpKtgEviadminspolecnostView1");
  }

  /**
   * 
   * Container's getter for KpKtgEviexterniadminView1
   */
  public KpKtgEviexterniadminViewImpl getKpKtgEviexterniadminView1()
  {
    return (KpKtgEviexterniadminViewImpl)findViewObject("KpKtgEviexterniadminView1");
  }

  /**
   * 
   * Container's getter for KpKtgEvisidloView1
   */
  public KpKtgEvisidloViewImpl getKpKtgEvisidloView1()
  {
    return (KpKtgEvisidloViewImpl)findViewObject("KpKtgEvisidloView1");
  }

  /**
   * 
   * Container's getter for KpKtgEvistatutarnizastupceView1
   */
  public KpKtgEvistatutarnizastupceViewImpl getKpKtgEvistatutarnizastupceView1()
  {
    return (KpKtgEvistatutarnizastupceViewImpl)findViewObject("KpKtgEvistatutarnizastupceView1");
  }

  /**
   * 
   * Container's getter for KpRelTypspolevidinfoView1
   */
  public KpRelTypspolevidinfoViewImpl getKpRelTypspolevidinfoView1()
  {
    return (KpRelTypspolevidinfoViewImpl)findViewObject("KpRelTypspolevidinfoView1");
  }











  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
  public static void main(String[] args)
  {
    launchTester("cz.jtbank.konsolidace.evi", "EviModuleLocal");
  }

  /**
   * 
   * Container's getter for VwKtgEviadminspolecnostView1
   */
  public VwKtgEviadminspolecnostViewImpl getVwKtgEviadminspolecnostView1()
  {
    return (VwKtgEviadminspolecnostViewImpl)findViewObject("VwKtgEviadminspolecnostView1");
  }

  /**
   * 
   * Container's getter for KpCisStatView1
   */
  public KpCisStatViewImpl getKpCisStatView1()
  {
    return (KpCisStatViewImpl)findViewObject("KpCisStatView1");
  }

  /**
   * 
   * Container's getter for KtgAppuserView1
   */
  public KtgAppuserViewImpl getKtgAppuserView1()
  {
    return (KtgAppuserViewImpl)findViewObject("KtgAppuserView1");
  }
  
  public void test() 
  {
    
  }
  
  public void externiAdmin(String akce,
                           int id,
                           String nazev,
                           String stat,
                           String poznamka) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_KTG_EVIEXTERNIADMIN "+
                                            "(ID, S_NAZEV, S_STAT, S_POZNAMKA) "+
                                            "SELECT NVL(MAX(ID),0)+1,?,?,? FROM DB_JT.KP_KTG_EVIEXTERNIADMIN",0);
        st.setString(1, nazev);
        st.setString(2, stat);
        st.setString(3, poznamka);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury externiAdmin akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_KTG_EVIEXTERNIADMIN "+
                                            "SET S_NAZEV=?, S_STAT=?, S_POZNAMKA=? "+
                                            "WHERE ID=?",0);
        st.setString(1, nazev);
        st.setString(2, stat);
        st.setString(3, poznamka);
        st.setInt(4, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury externiAdmin akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_KTG_EVIEXTERNIADMIN "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury externiAdmin akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  private int getPuvodniOsoba(int idSpol,
                              String sloupec)
  {
    int idOsoba = -1;
  
    ViewObject vo = getKpKtgEviadminspolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idSpol);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      Number hlp = (Number) row.getAttribute(sloupec);
      if(hlp!=null) idOsoba = hlp.intValue();
    }
    vo.closeRowSet();
    
    return idOsoba;
  }

  private int getUcSpolSegment(int idUcSpol)
  {
    int idSegment = -1;
  
    ViewObject vo = getKpKtgUcetnispolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idUcSpol);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      Number hlp = (Number) row.getAttribute("IdMngsegment");
      if(hlp!=null) idSegment = hlp.intValue();
    }
    vo.closeRowSet();
    
    return idSegment;
  }

  private int[] getOsobyUcSpol(int idUcSpol)
  {
    int[] osoby = new int[3];
  
    ViewObject vo = getKpKtgUcetnispolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idUcSpol);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      Number hlp = (Number) row.getAttribute("IdZodpovednaucetni");
      if(hlp!=null) osoby[0] = hlp.intValue(); else osoby[0] = -1;
      hlp = (Number) row.getAttribute("IdOdpovednaosoba");
      if(hlp!=null) osoby[1] = hlp.intValue(); else osoby[1] = -1;
      hlp = (Number) row.getAttribute("IdAdministrator");
      if(hlp!=null) osoby[2] = hlp.intValue(); else osoby[2] = -1;
//      hlp = (Number) row.getAttribute("IdTopmng");
//      if(hlp!=null) osoby[3] = hlp.intValue(); else osoby[3] = -1;
    }
    vo.closeRowSet();
    
    return osoby;
  }

  private Object getPuvodniHodnota(int idSpol,
                                   String sloupec)
  {
    Object ret = null;
  
    ViewObject vo = getKpKtgEviadminspolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idSpol);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      ret = row.getAttribute(sloupec);
    }
    vo.closeRowSet();
    
    return ret;
  }

  private Set getDbLinkUcSpol(String where)
  {
    Set set = new HashSet();

    ViewObject vo = getVwProtistranadetailView1();
    vo.clearCache();
    vo.setWhereClause(where);
    while(vo.hasNext()) 
    {
      Row row = vo.next();
      String dbLink = (String)row.getAttribute("SDblink");
      if(dbLink!=null) set.add(dbLink);
    }
    vo.closeRowSet();
    
    return set;
  }

  public void spolecnost(String akce,
                         int id,
                         String nazev,
                         String stat,
                         int idExt,
                         int idAdministrator,
                         int idStatus,
                         int idUcSpol,
                         String ico,
                         String icoDok,
                         java.sql.Date dtZalozeni,
                         String navrh,
                         String nazevNavrh,
                         String icoNavrh,
                         int idAdminNavrh) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_KTG_EVIADMINSPOLECNOST "+
                                            "(S_NAZEV, S_STAT, ID_EXTERNIADMIN, ID_ADMINISTRATOR, ID_STATUS, ID_KTGUCETNISPOLECNOST, S_ICO, S_ICODOKUMENTY, DT_DATUMZALOZENI, C_NAVRH, S_NAZEVNAVRH, S_ICONAVRH, ID_ADMINISTRATORNAVRH, ID_TYPSPOL) "+
                                            "VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,1)",0);
        st.setString(1, nazev);
        st.setString(2, stat);
        if(idExt>0) st.setInt(3, idExt); else st.setNull(3,Types.INTEGER);
        if(idAdministrator>0) st.setInt(4, idAdministrator); else st.setNull(4,Types.INTEGER);
        if(idStatus>0) st.setInt(5, idStatus); else st.setNull(5,Types.INTEGER);
        if(idUcSpol>0) st.setInt(6, idUcSpol); else st.setNull(6,Types.INTEGER);
        st.setString(7, ico==null?null:ico.trim());
        st.setString(8, icoDok);
        st.setDate(9, dtZalozeni);
        st.setString(10, navrh);
        st.setString(11, nazevNavrh);
        st.setString(12, icoNavrh);
        if(idAdminNavrh>0) st.setInt(13, idAdminNavrh); else st.setNull(13,Types.INTEGER);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolecnost akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
      Mail mail = new Mail();
      Set dbLinks = getDbLinkUcSpol("S_ICO = '"+ico+"'");
      mail.sendEviSpolecnostNova(this,nazev,ico,dbLinks);
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      String origNazev = (String)getPuvodniHodnota(id, "SNazev");
      String origIco = (String)getPuvodniHodnota(id, "SIco");
      if(origNazev==null) origNazev="";
      if(origIco==null) origIco="";
    
      int origAdmin = getPuvodniOsoba(id,"IdAdministrator");
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_KTG_EVIADMINSPOLECNOST "+
                                            "SET S_NAZEV=?, S_STAT=?, ID_EXTERNIADMIN=?, ID_ADMINISTRATOR=?, ID_STATUS=?, ID_KTGUCETNISPOLECNOST=?, S_ICO=?, S_ICODOKUMENTY=?, DT_DATUMZALOZENI=?, C_NAVRH=?, S_NAZEVNAVRH=?, S_ICONAVRH=?, ID_ADMINISTRATORNAVRH=? "+
                                            "WHERE ID=?",0);
        st.setString(1, nazev);
        st.setString(2, stat);
        if(idExt>0) st.setInt(3, idExt); else st.setNull(3,Types.INTEGER);
        if(idAdministrator>0) st.setInt(4, idAdministrator); else st.setNull(4,Types.INTEGER);
        if(idStatus>0) st.setInt(5, idStatus); else st.setNull(5,Types.INTEGER);
        if(idUcSpol>0) st.setInt(6, idUcSpol); else st.setNull(6,Types.INTEGER);
        st.setString(7, ico==null?null:ico.trim());
        st.setString(8, icoDok);
        st.setDate(9, dtZalozeni);
        st.setString(10, navrh);
        st.setString(11, nazevNavrh);
        st.setString(12, icoNavrh);
        if(idAdminNavrh>0) st.setInt(13, idAdminNavrh); else st.setNull(13,Types.INTEGER);
        st.setInt(14, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolecnost akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
      Mail mail = new Mail();
      if(origAdmin!=idAdministrator && idUcSpol>0) {
        int[] osoby = getOsobyUcSpol(idUcSpol);
        mail.sendChngSpolecnost(this,idUcSpol,nazev,idAdministrator,origAdmin,"administrátor/ka",osoby,getUcSpolSegment(idUcSpol));
      }
      if(!origNazev.equals(nazev) || !origIco.equals(ico)) 
      {
        String tico = origIco;
        while(tico.length()<10) tico="0"+tico;
        Set dbLinks = getDbLinkUcSpol("S_ICO = '"+tico+"'");
        mail.sendEviSpolecnostZmena(this,nazev,ico,origNazev,origIco,dbLinks);
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_KTG_EVIADMINSPOLECNOST "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolecnost akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }

    //LOGOVANI
    try {
      st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_LOG_EVIADMINSPOLECNOST "+
                                          "(ID, S_NAZEV, S_STAT, ID_EXTERNIADMIN, ID_ADMINISTRATOR, ID_STATUS, ID_KTGUCETNISPOLECNOST, S_ICO, S_ICODOKUMENTY, DT_DATUMZALOZENI, C_NAVRH, S_NAZEVNAVRH, S_ICONAVRH, ID_ADMINISTRATORNAVRH, ID_TYPSPOL, S_AKCE, S_UZIVATEL) "+
                                          "VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,1,?,?)",0);
      if(id>0) st.setInt(1, id); else st.setNull(1,Types.INTEGER);
      st.setString(2, nazev);
      st.setString(3, stat);
      if(idExt>0) st.setInt(4, idExt); else st.setNull(4,Types.INTEGER);
      if(idAdministrator>0) st.setInt(5, idAdministrator); else st.setNull(5,Types.INTEGER);
      if(idStatus>0) st.setInt(6, idStatus); else st.setNull(6,Types.INTEGER);
      if(idUcSpol>0) st.setInt(7, idUcSpol); else st.setNull(7,Types.INTEGER);
      st.setString(8, ico==null?null:ico.trim());
      st.setString(9, icoDok);
      st.setDate(10, dtZalozeni);
      st.setString(11, navrh);
      st.setString(12, nazevNavrh);
      st.setString(13, icoNavrh);
      if(idAdminNavrh>0) st.setInt(14, idAdminNavrh); else st.setNull(14,Types.INTEGER);
      st.setString(15, akce);
      st.setString(16, getUser());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury spolecnost akce="+akce,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  private static String[] tablesInfo = 
    new String[] {"kp_ktg_eviSidlo",
                  "kp_dat_eviZplnomocneni",
                  "kp_ktg_eviStatutarniZastupce",
                  "kp_dat_eviKorespondence",
                  "kp_dat_eviBanky",
                  "kp_dat_eviKomisionarskeSmlouvy",
                  "kp_dat_eviDokument",
                  "kp_dat_eviDoidentifikace",
                  "kp_dat_eviObchodniRejstrik"
                 };

  private String getInfoTable(int info) 
  {
    return tablesInfo[info-1];
  }

  public void insertInfo(int idSpol, int info) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    String table = getInfoTable(info);
    int id = 0;

    try {
      st = dbTran.createPreparedStatement("INSERT INTO DB_JT."+table+" "+
                                          "(ID,ID_ADMINSPOLECNOST) "+
                                          "SELECT NVL(MAX(ID),0)+1,? FROM DB_JT."+table,0);
      st.setInt(1, idSpol);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury insertInfo info="+info,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    dbTran.commit();
  }

  public void deleteInfo(int info, int id) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    String table = getInfoTable(info);

    try {
      st = dbTran.createPreparedStatement("DELETE FROM DB_JT."+table+" "+
                                          "WHERE ID = ?",0);
      st.setInt(1, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury deleteInfo id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void updateInfoSidlo(int id,
                              String ulice,
                              String mesto,
                              String psc,
                              String stat,
                              java.sql.Date dtOd,
                              java.sql.Date dtDo,
                              String navrh) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_KTG_EVISIDLO "+
                                          "SET S_ULICE=?, S_MESTO=?, S_PSC=?, S_STAT=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, C_NAVRH=? "+
                                          "WHERE ID=?",0);
      st.setString(1, ulice);
      st.setString(2, mesto);
      st.setString(3, psc);
      st.setString(4, stat);
      st.setDate(5, dtOd);
      st.setDate(6, dtDo);
      st.setString(7, navrh);
      st.setInt(8, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury updateInfoSidlo id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }
  
  public void updateInfoZplnomocneni(int id,
                                     String poznamka,
                                     java.sql.Date dtOd,
                                     java.sql.Date dtDo,
                                     String navrh) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_EVIZPLNOMOCNENI "+
                                          "SET S_POZNAMKA=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, C_NAVRH=? "+
                                          "WHERE ID=?",0);
      st.setString(1, poznamka);
      st.setDate(2, dtOd);
      st.setDate(3, dtDo);
      st.setString(4, navrh);
      st.setInt(5, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury updateInfoZplnomocneni id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void updateInfoStatZastupce(int id,
                                     String poznamka,
                                     java.sql.Date dtOd,
                                     java.sql.Date dtDo,
                                     int idTyp,
                                     int idProti,
                                     String spojVazby,
                                     String navrh) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_KTG_EVISTATUTARNIZASTUPCE "+
                                          "SET S_POZNAMKA=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, ID_TYP=?, ID_KTGSPOLECNOST=?, C_SPOJOVATVAZBY=?, C_NAVRH=? "+
                                          "WHERE ID=?",0);
      st.setString(1, poznamka);
      st.setDate(2, dtOd);
      st.setDate(3, dtDo);
      if(idTyp>0) st.setInt(4, idTyp); else st.setNull(4,Types.INTEGER);
      if(idProti>0) st.setInt(5, idProti); else st.setNull(5,Types.INTEGER);
      st.setString(6, spojVazby);
      st.setString(7, navrh);
      st.setInt(8, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury updateInfoStatZastupce id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void updateInfoKorespondence(int id,
                                      String poznamka,
                                      java.sql.Date dtOd,
                                      java.sql.Date dtDo,
                                      String navrh) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_EVIKORESPONDENCE "+
                                          "SET S_POZNAMKA=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, C_NAVRH=? "+
                                          "WHERE ID=?",0);
      st.setString(1, poznamka);
      st.setDate(2, dtOd);
      st.setDate(3, dtDo);
      st.setString(4, navrh);
      st.setInt(5, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury updateInfoKorespondence id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void updateInfoBanky(int id,
                              String poznamka,
                              java.sql.Date dtOd,
                              java.sql.Date dtDo,
                              int idProti,
                              String navrh) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_EVIBANKY "+
                                          "SET S_POZNAMKA=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, IDBANKA=?, C_NAVRH=? "+
                                          "WHERE ID=?",0);
      st.setString(1, poznamka);
      st.setDate(2, dtOd);
      st.setDate(3, dtDo);
      if(idProti>0) st.setInt(4, idProti); else st.setNull(4,Types.INTEGER);
      st.setString(5, navrh);
      st.setInt(6, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury updateInfoBanky id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void updateInfoKomisSmlouvy(int id,
                                     String poznamka,
                                     java.sql.Date dtOd,
                                     java.sql.Date dtDo,
                                     String navrh) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_EVIKOMISIONARSKESMLOUVY "+
                                          "SET S_POZNAMKA=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, C_NAVRH=? "+
                                          "WHERE ID=?",0);
      st.setString(1, poznamka);
      st.setDate(2, dtOd);
      st.setDate(3, dtDo);
      st.setString(4, navrh);
      st.setInt(5, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury updateInfoKomisSmlouvy id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void updateInfoDokument(int id,
                                 String poznamka,
                                 java.sql.Date dtOd,
                                 java.sql.Date dtDo,
                                 String navrh) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_EVIDOKUMENT "+
                                          "SET S_POZNAMKA=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, C_NAVRH=? "+
                                          "WHERE ID=?",0);
      st.setString(1, poznamka);
      st.setDate(2, dtOd);
      st.setDate(3, dtDo);
      st.setString(4, navrh);
      st.setInt(5, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury updateInfoDokument id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void updateInfoDoidentifikace(int id,
                                       String poznamka,
                                       java.sql.Date dtOd,
                                       java.sql.Date dtDo,
                                       int idCis,
                                       String navrh) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_EVIDOIDENTIFIKACE "+
                                          "SET S_POZNAMKA=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, ID_CISDOIDENTIFIKACE=?, C_NAVRH=? "+
                                          "WHERE ID=?",0);
      st.setString(1, poznamka);
      st.setDate(2, dtOd);
      st.setDate(3, dtDo);
      if(idCis>0) st.setInt(4, idCis); else st.setNull(4,Types.INTEGER);
      st.setString(5, navrh);
      st.setInt(6, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury updateInfoDoidentifikace id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void updateInfoOR(int id,
                           java.sql.Date datum,
                           int idCis) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_EVIOBCHODNIREJSTRIK "+
                                          "SET DT_DATUM=?, ID_CISOBCHODNIREJSTRIK=? "+
                                          "WHERE ID=?",0);
      st.setDate(1, datum);
      if(idCis>0) st.setInt(2, idCis); else st.setNull(2,Types.INTEGER);
      st.setInt(3, id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury updateInfoOR id="+id,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void obchodniRejstrik(String akce,
                               int id,
                               int idSpol,
                               int idCis,
                               java.sql.Date datum) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_DAT_EVIOBCHODNIREJSTRIK "+
                                            "(ID, ID_ADMINSPOLECNOST, ID_CISOBCHODNIREJSTRIK, DT_DATUM) "+
                                            "SELECT NVL(MAX(ID),0)+1,?,?,? FROM DB_JT.KP_DAT_EVIOBCHODNIREJSTRIK",0);
        st.setInt(1, idSpol);
        st.setInt(2, idCis);
        st.setDate(3, datum);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury obchodniRejstrik akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_EVIOBCHODNIREJSTRIK "+
                                            "SET ID_ADMINSPOLECNOST=?, ID_CISOBCHODNIREJSTRIK=?, DT_DATUM=? "+
                                            "WHERE ID=?",0);
        st.setInt(1, idSpol);
        st.setInt(2, idCis);
        st.setDate(3, datum);
        st.setInt(4, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury obchodniRejstrik akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_DAT_EVIOBCHODNIREJSTRIK "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury obchodniRejstrik akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostView1
   */
  public KpKtgUcetnispolecnostViewImpl getKpKtgUcetnispolecnostView1()
  {
    return (KpKtgUcetnispolecnostViewImpl)findViewObject("KpKtgUcetnispolecnostView1");
  }
  
  private String getUser() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, false);
    return user;
  }
  
  public int currentUsersId() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    Number userId = null;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("S_USERID = '"+user+"'");
    if(voUser.hasNext()) 
    {
      Row rowUser = voUser.next();
      userId = (Number) rowUser.getAttribute("Id");
    }
    voUser.closeRowSet();
    if(userId == null) return -1;
    
    return userId.intValue();
  }

  public boolean isCurrentUserAdministrator(int idSpol) 
  {
    boolean ret = false;

    int userId = currentUsersId();
    if(userId < 0) return false;

    ViewObject vo = getKpKtgEviadminspolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idSpol+" AND ID_ADMINISTRATOR = "+userId);
    if(vo.hasNext()) 
    {
      ret = true;
    }
    vo.closeRowSet();
    
    return ret;
  }

  /**
   * 
   * Container's getter for KpRelDblinkappuserView1
   */
  public KpRelDblinkappuserViewImpl getKpRelDblinkappuserView1()
  {
    return (KpRelDblinkappuserViewImpl)findViewObject("KpRelDblinkappuserView1");
  }

  /**
   * 
   * Container's getter for KpCisDatabazeView1
   */
  public KpCisDatabazeViewImpl getKpCisDatabazeView1()
  {
    return (KpCisDatabazeViewImpl)findViewObject("KpCisDatabazeView1");
  }

  public void deleteEmailUser(int userId, String dbLink) throws KisException 
  {
    Statement st = getDBTransaction().createStatement(0);
    try 
    {
      st.execute("DELETE FROM DB_JT.KP_REL_DBLINKAPPUSER WHERE ID_APPUSER = "+userId+" AND S_DBLINK = '"+dbLink+"'");
      getTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury deleteEmailUser()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void insertEmailUser(int userId, String dbLink) throws KisException 
  {
    Statement st = getDBTransaction().createStatement(0);
    try 
    {
      st.execute("INSERT INTO DB_JT.KP_REL_DBLINKAPPUSER (ID_APPUSER, S_DBLINK) VALUES ("+userId+", '"+dbLink+"')");
      getTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury insertEmailUser()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  
  private Object getDataFromSpolecnost(int idUcSpol, String sloupec) 
  {
    Object ret = null;
    ViewObject vo = getKpKtgEviadminspolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID_KTGUCETNISPOLECNOST = "+idUcSpol+" AND C_NAVRH <> '1'");
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      ret = row.getAttribute(sloupec);
    }
    vo.closeRowSet();
    
    return ret;
  }

  private Object getDataFromSidlo(int idSpol, String sloupec) 
  {
    Object ret = null;
    ViewObject vo = getKpKtgEvisidloView1();
    vo.clearCache();
    vo.setWhereClause("ID_ADMINSPOLECNOST = "+idSpol+
                " AND (DT_PLATNOSTOD IS NULL OR DT_PLATNOSTOD < SYSDATE)"+
                " AND (DT_PLATNOSTDO IS NULL OR DT_PLATNOSTDO > SYSDATE)"+
                " AND C_NAVRH <> '1'");
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      ret = row.getAttribute(sloupec);
    }
    vo.closeRowSet();
    
    return ret;
  }
  
  private boolean equalsIco(String ico1, String ico2) 
  {
    if(ico1==ico2) return true;
    else if(ico1==null && ico2!=null) return false;
    else if(ico1!=null && ico2==null) return false;

    ico1 = ico1.trim();
    ico2 = ico2.trim();
    while(ico1.startsWith("0")) ico1 = ico1.substring(1);
    while(ico2.startsWith("0")) ico2 = ico2.substring(1);
    if(ico1.equals(ico2)) return true;
    
    return false;
  }
  
  public String getEmailText(int idUcSpol, String dbLink) 
  {
    String nazev = (String) getDataFromSpolecnost(idUcSpol, "SNazev"); if(nazev==null) nazev="";
    StringBuffer text = new StringBuffer("V evidenci administrovaných společností došlo ke změně u společnosti '"+nazev+"' a bylo vyžádáno rozeslání tohoto informačního e-mailu.");

    if(dbLink==null) return text.toString();
    
    text.append("\nVe \"vaší\" databázi "+dbLink+" jsou některé údaje jinak...");

    Number id = null;
    ViewObject voS = getKpKtgSpolecnostView1();
    voS.clearCache();
    voS.setWhereClause("ID_KTGSPOLECNOST = "+idUcSpol);
    if(voS.hasNext()) 
    {
      Row rowS = voS.next();
      id = (Number)rowS.getAttribute("Id");
    }
    voS.closeRowSet();

    Number idSpol = (Number) getDataFromSpolecnost(idUcSpol, "Id");
    if(idSpol==null) return text.toString();
    String ico = (String) getDataFromSpolecnost(idUcSpol, "SIco"); if(ico==null) ico="";
    String ulice = (String) getDataFromSidlo(idSpol.intValue(), "SUlice"); if(ulice==null) ulice="";
    String mesto = (String) getDataFromSidlo(idSpol.intValue(), "SMesto"); if(mesto==null) mesto="";
    String psc = (String) getDataFromSidlo(idSpol.intValue(), "SPsc"); if(psc==null) psc="";
    String stat = (String) getDataFromSidlo(idSpol.intValue(), "SStat"); if(stat==null) stat="";

    ViewObject voUS = getVwProtistranadetailView1();
    voUS.clearCache();
    voUS.setWhereClause("ID_SPOLECNOST = "+id+" AND S_DBLINK = '"+dbLink+"'");
    while(voUS.hasNext()) 
    {
      Row rowUS = voUS.next();
      String sNazev = (String)rowUS.getAttribute("SNazev");
      String sIco = (String)rowUS.getAttribute("SIco");
      String sUlice = (String)rowUS.getAttribute("Ulice");
      String sMesto = (String)rowUS.getAttribute("Mesto");
      String sPsc = (String)rowUS.getAttribute("Psc");
      String sStat = (String)rowUS.getAttribute("Stat");
      if(!nazev.equals(sNazev)) 
        text.append("\nNázev společnosti v evidenci KIS je '"+nazev+"' zatímco u vás '"+sNazev+"'.");
      if(!equalsIco(ico,sIco)) 
        text.append("\nIČ společnosti v evidenci KIS je '"+ico+"' zatímco u vás '"+sIco+"'.");
      if(!ulice.equals(sUlice)) 
        text.append("\nUlice sídla společnosti v evidenci KIS je '"+ulice+"' zatímco u vás '"+sUlice+"'.");
      if(!mesto.equals(sMesto)) 
        text.append("\nMěsto sídla společnosti v evidenci KIS je '"+mesto+"' zatímco u vás '"+sMesto+"'.");
      if(!psc.equals(sPsc)) 
        text.append("\nPSČ sídla společnosti v evidenci KIS je '"+psc+"' zatímco u vás '"+sPsc+"'.");
      if(!stat.equals(sStat)) 
        text.append("\nStát sídla společnosti v evidenci KIS je '"+stat+"' zatímco u vás '"+sStat+"'.");
    }
    voUS.closeRowSet();

    return text.toString();
  }
  
  public Map getUsersForEmail(int idUcSpol) 
  {
    Map map = new HashMap();
    Number id = null;
    Set dbLinks = new HashSet();
    
    Number idSpol = (Number) getDataFromSpolecnost(idUcSpol, "Id");
    if(idSpol==null) return map;
    String nazev = (String) getDataFromSpolecnost(idUcSpol, "SNazev");
    String ico = (String) getDataFromSpolecnost(idUcSpol, "SIco");
    String ulice = (String) getDataFromSidlo(idSpol.intValue(), "SUlice");
    String mesto = (String) getDataFromSidlo(idSpol.intValue(), "SMesto");
    String psc = (String) getDataFromSidlo(idSpol.intValue(), "SPsc");
    String stat = (String) getDataFromSidlo(idSpol.intValue(), "SStat");

    ViewObject voS = getKpKtgSpolecnostView1();
    voS.clearCache();
    voS.setWhereClause("ID_KTGSPOLECNOST = "+idUcSpol);
    if(voS.hasNext()) 
    {
      Row rowS = voS.next();
      id = (Number)rowS.getAttribute("Id");
    }
    voS.closeRowSet();
    
    ViewObject voUS = getVwProtistranadetailView1();
    voUS.clearCache();
    voUS.setWhereClause("ID_SPOLECNOST = "+id+" AND (1=0"+
                       (nazev!=null?" OR S_NAZEV <> '"+nazev+"'":"")+
                       (ico!=null?" OR S_ICO <> '"+ico+"'":"")+
                       (ulice!=null?" OR ULICE <> '"+ulice+"'":"")+
                       (mesto!=null?" OR MESTO <> '"+mesto+"'":"")+
                       (psc!=null?" OR PSC <> '"+psc+"'":"")+
                       (stat!=null?" OR STAT <> '"+stat+"'":"")+
                       ")");
    while(voUS.hasNext()) 
    {
      Row rowUS = voUS.next();
      String dbLink = (String)rowUS.getAttribute("SDblink");
      if(dbLink!=null) dbLinks.add(dbLink);
    }
    voUS.closeRowSet();

    ViewObject voMail = getKpRelDblinkappuserView1();
    voMail.clearCache();
    Iterator iterLink = dbLinks.iterator();
    while(iterLink.hasNext()) 
    {
      String dbLink = (String) iterLink.next();

      voMail.setWhereClause("S_DBLINK = '"+dbLink+"'");
      while(voMail.hasNext()) 
      {
        Row row = voMail.next();
        Number user = (Number) row.getAttribute("IdAppuser");
        if(user!=null) map.put(user,getEmailText(idUcSpol, dbLink));
      }
      voMail.closeRowSet();
    }
    
    return map;
  }

  public void rozeslatMaily(int idUcSpol, String text, Set manUsers) 
  {
    Mail mail = new Mail();

    Map map = getUsersForEmail(idUcSpol);
    
    Set set = new HashSet();
    Iterator iter = map.keySet().iterator();
    while(iter.hasNext()) 
    {
      Number user = (Number) iter.next();
      set.clear(); set.add(user);
      String textUser = (String) map.get(user);
      mail.sendEviSpolecnost(this, set, textUser);
    }

    if(!manUsers.isEmpty()) {
      mail.sendEviSpolecnost(this, manUsers, text);
    }
  }

  public String getEmailNavrhText(int idSpol) 
  {
    String nazev = null;
    String navrh = null;
    ViewObject vo = getKpKtgEviadminspolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idSpol);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      nazev = (String) row.getAttribute("SNazev");
      navrh = (String) row.getAttribute("CNavrh");
    }
    vo.closeRowSet();
    if(nazev==null) nazev="";
    
    StringBuffer text = new StringBuffer("V evidenci administrovaných společností vznikl návrh změny u společnosti '"+nazev+"' a bylo vyžádáno rozeslání tohoto informačního e-mailu.");

    if("1".equals(navrh))
      text.append("\nZměna je navrhována v základních datech společnosti (název, IČ...).");

    vo = null;
    String zmena = null;
    for(int i=0; i<8; i++) {
      switch (i) {
        case 0: vo = getKpKtgEvisidloView1(); zmena="sídle"; break;
        case 1: vo = getKpDatEvizplnomocneniView1(); zmena="zplnomocnění"; break;
        case 2: vo = getKpKtgEvistatutarnizastupceView1(); zmena="statutárním zástupci"; break;
        case 3: vo = getKpDatEvikorespondenceView1(); zmena="korespondenci"; break;
        case 4: vo = getKpDatEvibankyView1(); zmena="bance"; break;
        case 5: vo = getKpDatEvikomisionarskesmlouvyView1(); zmena="komisionářské smlouvě"; break;
        case 6: vo = getKpDatEvidokumentView1(); zmena="dokumentu"; break;
        case 7: vo = getKpDatEvidoidentifikaceView1(); zmena="doidentifikaci"; break;
        default: continue;
      }
      vo.clearCache();
      vo.setWhereClause("ID_ADMINSPOLECNOST = "+idSpol+" AND C_NAVRH='1'");
      while(vo.hasNext()) 
      {
        vo.next();
        text.append("\nZměna je navrhována v "+zmena+".");
      }
      vo.closeRowSet();
    }
    
    return text.toString();
  }

  public void rozeslatMailyNavrh(String text, Set manUsers) 
  {
    Mail mail = new Mail();

    if(!manUsers.isEmpty()) {
      mail.sendEviSpolecnostNavrh(this, manUsers, text, currentUsersId());
    }
  }

  /**
   * 
   * Container's getter for KpEmailParamView1
   */
  public KpEmailParamViewImpl getKpEmailParamView1()
  {
    return (KpEmailParamViewImpl)findViewObject("KpEmailParamView1");
  }

  /**
   * 
   * Container's getter for KpKtgSpolecnostView1
   */
  public KpKtgSpolecnostViewImpl getKpKtgSpolecnostView1()
  {
    return (KpKtgSpolecnostViewImpl)findViewObject("KpKtgSpolecnostView1");
  }

  /**
   * 
   * Container's getter for VwProtistranadetailView1
   */
  public VwProtistranadetailViewImpl getVwProtistranadetailView1()
  {
    return (VwProtistranadetailViewImpl)findViewObject("VwProtistranadetailView1");
  }

  /**
   * 
   * Container's getter for KpKtgEmailzpravyView1
   */
  public KpKtgEmailzpravyViewImpl getKpKtgEmailzpravyView1()
  {
    return (KpKtgEmailzpravyViewImpl)findViewObject("KpKtgEmailzpravyView1");
  }

  /**
   * 
   * Container's getter for VwKpEviobchodnirejstrik3mView1
   */
  public VwKpEviobchodnirejstrik3mViewImpl getVwKpEviobchodnirejstrik3mView1()
  {
    return (VwKpEviobchodnirejstrik3mViewImpl)findViewObject("VwKpEviobchodnirejstrik3mView1");
  }

  /**
   * 
   * Container's getter for KpLogEviadminspolecnostView1
   */
  public KpLogEviadminspolecnostViewImpl getKpLogEviadminspolecnostView1()
  {
    return (KpLogEviadminspolecnostViewImpl)findViewObject("KpLogEviadminspolecnostView1");
  }

  /**
   * 
   * Container's getter for VwKtgPodpisovevzoryquaestorView1
   */
  public VwKtgPodpisovevzoryquaestorViewImpl getVwKtgPodpisovevzoryquaestorView1()
  {
    return (VwKtgPodpisovevzoryquaestorViewImpl)findViewObject("VwKtgPodpisovevzoryquaestorView1");
  }

  /**
   * 
   * Container's getter for KpDatMngsegmentbossView1
   */
  public KpDatMngsegmentbossViewImpl getKpDatMngsegmentbossView1()
  {
    return (KpDatMngsegmentbossViewImpl)findViewObject("KpDatMngsegmentbossView1");
  }

  /**
   * 
   * Container's getter for KpDatEviadmindodavatelView1
   */
  public KpDatEviadmindodavatelViewImpl getKpDatEviadmindodavatelView1()
  {
    return (KpDatEviadmindodavatelViewImpl)findViewObject("KpDatEviadmindodavatelView1");
  }

  public void eviAdminDodavatel(String akce,
                                int idSpol,
                                int idAdminSpol,
                                double castka,
                                String mena) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.kp_dat_eviAdminDodavatel "+
                                            "(ID_KTGSPOLECNOST,ND_CASTKANAKLADY,S_MENA,S_UZIVATEL,ID_EVIADMINSPOL) "+
                                            "VALUES (?,?,?,?,?)",0);
        st.setInt(1, idSpol);
        st.setDouble(2, castka);
        st.setString(3, mena);
        st.setString(4, getUser());
        st.setInt(5, idAdminSpol);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury eviAdminDodavatel akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.kp_dat_eviAdminDodavatel "+
                                            "SET ND_CASTKANAKLADY=?,S_MENA=?,S_UZIVATEL=?,DT_DATUMZMENY=SYSDATE "+
                                            "WHERE ID_KTGSPOLECNOST=? AND ID_EVIADMINSPOL=? AND DT_DATUM = TRUNC(SYSDATE,'Q')",0);
        st.setDouble(1, castka);
        st.setString(2, mena);
        st.setString(3, getUser());
        st.setInt(4, idSpol);
        st.setInt(5, idAdminSpol);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury eviAdminDodavatel akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.kp_dat_eviAdminDodavatel "+
                                            "SET S_UZIVATEL=?,DT_DATUMZMENY=SYSDATE "+
                                            "WHERE ID_KTGSPOLECNOST=? AND ID_EVIADMINSPOL=? AND DT_DATUM = TRUNC(SYSDATE,'Q')",0);
        st.setString(1, getUser());
        st.setInt(2, idSpol);
        st.setInt(3, idAdminSpol);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury eviAdminDodavatel akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }

      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.kp_dat_eviAdminDodavatel "+
                                            "WHERE ID_KTGSPOLECNOST=? AND ID_EVIADMINSPOL=? AND DT_DATUM = TRUNC(SYSDATE,'Q')",0);
        st.setInt(1, idSpol);
        st.setInt(2, idAdminSpol);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury eviAdminDodavatel akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpCisMenaView1
   */
  public KpCisMenaViewImpl getKpCisMenaView1()
  {
    return (KpCisMenaViewImpl)findViewObject("KpCisMenaView1");
  }

  public void eviExtDodavatel(int idSpol) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.kp_ktg_spolecnost "+
                                          "SET c_eviExtDodavatel = decode(c_eviExtDodavatel,'0','1',NULL,'1','0') "+
                                          "WHERE id=?",0);
      st.setInt(1, idSpol);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury eviExtDodavatel idSpol="+idSpol,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  public void exportExcelDN(java.sql.Date datum) throws KisException
  {
    ESExportEviDodavatelNaklad ei = new ESExportEviDodavatelNaklad(this, datum);
    try {
      ei.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }
  
  protected FileFilter getFileFilter(final String name) 
  {
    return new FileFilter() {
      public boolean accept(File pathname) 
      {
        return true;
      }
    };
  }
  
  java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);

  public String getExcelsDN() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_ADMIN_NAKLADY;
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_ADMIN_NAKLADY+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }
}