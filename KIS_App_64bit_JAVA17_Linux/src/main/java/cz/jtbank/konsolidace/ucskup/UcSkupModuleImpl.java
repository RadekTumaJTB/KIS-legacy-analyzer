package cz.jtbank.konsolidace.ucskup;
import java.net.*;
import oracle.jbo.*;
import oracle.jbo.server.*;
import oracle.jbo.server.ApplicationModuleImpl;
import oracle.jbo.server.ViewLinkImpl;
import cz.jtbank.konsolidace.doklady.ViewJtSpolImpl;
import java.sql.*;
import cz.jtbank.konsolidace.common.KisException;
import cz.jtbank.konsolidace.doklady.KpKtgUcetnispolecnostViewImpl;
import cz.jtbank.konsolidace.mustky.KpTmpCissubjectViewImpl;
import cz.jtbank.konsolidace.fininv.KpCisMenaViewImpl;
import java.io.*;
import cz.jtbank.konsolidace.excel.ESExportSpolecnosti;
import cz.jtbank.konsolidace.common.Constants;
import cz.jtbank.konsolidace.users.KtgAppuserViewImpl;
import cz.jtbank.konsolidace.protistrany.VwProtistranaViewImpl;
import oracle.jbo.domain.Number;
import cz.jtbank.konsolidace.doklady.KpDatDokladViewImpl;
import cz.jtbank.konsolidace.mail.Mail;
import cz.jtbank.konsolidace.doklady.KpEmailParamViewImpl;
import cz.jtbank.konsolidace.users.KpKtgEmailzpravyViewImpl;
import cz.jtbank.konsolidace.subkons.KpRelSubkonsolidaceclenViewImpl;
import java.util.*;
import cz.jtbank.konsolidace.doklady.CisLocaleViewImpl;
import cz.jtbank.konsolidace.evi.KpKtgEviadminspolecnostViewImpl;
import cz.jtbank.konsolidace.protistrany.KpCisDatabazeViewImpl;
import cz.jtbank.konsolidace.doklady.VwKpDokladzustatkyuctuproti2ViewImpl;
import cz.jtbank.konsolidace.protistrany.KpKtgSpolecnostViewImpl;
import cz.jtbank.konsolidace.doklady.KpLogUcetnispolecnostOnlineViewImpl;
import cz.jtbank.konsolidace.ifrs.KpCisMngsegmentViewImpl;
import cz.jtbank.konsolidace.ifrs.KpDatMngsegmentbossViewImpl;
import cz.jtbank.konsolidace.projekt.VwKtgProjektViewImpl;
import cz.jtbank.konsolidace.users.KtgAppuserIExterniViewImpl;
import cz.jtbank.konsolidace.doklady.KpKtgUcetnispolecnostZamkyViewImpl;
//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---------------------------------------------------------------

public class UcSkupModuleImpl extends ApplicationModuleImpl implements cz.jtbank.konsolidace.ucskup.common.UcSkupModule 
{
  /**
   * 
   * This is the default constructor (do not remove)
   */
  public UcSkupModuleImpl()
  {
  }

  /**
   * 
   * Container's getter for KpKtgUcetniskupinaView1
   */
  public KpKtgUcetniskupinaViewImpl getKpKtgUcetniskupinaView1()
  {
    return (KpKtgUcetniskupinaViewImpl)findViewObject("KpKtgUcetniskupinaView1");
  }

  /**
   * 
   * Container's getter for KpRelUcetniskupinaclenView1
   */
  public KpRelUcetniskupinaclenViewImpl getKpRelUcetniskupinaclenView1()
  {
    return (KpRelUcetniskupinaclenViewImpl)findViewObject("KpRelUcetniskupinaclenView1");
  }



  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
  public static void main(String[] args)
  {
    //launchTester("cz.jtbank.konsolidace.ucskup", "UcSkupModuleLocal");
/*
    UcSkupModuleImpl dm = (UcSkupModuleImpl)
      oracle.jbo.client.Configuration.createRootApplicationModule("cz.jtbank.konsolidace.ucskup.UcSkupModule","UcSkupModuleLocal");
    try {
      dm.kartaPravidla("I",0,2,"ahoj",new java.sql.Date(System.currentTimeMillis()),new java.sql.Date(System.currentTimeMillis()));
    }
    catch(Exception e) 
    {
      e.printStackTrace();
    }
*/
String typ = "pokushokus";
//typ = typ.substring(0,typ.indexOf("\\")) + "|5C" + typ.substring(typ.indexOf("\\")+1);
typ = typ.replaceAll("\\\\","|5C");
System.out.println(typ);
/*  
    try {
      String s = URLEncoder.encode("Senovďż˝nďż˝ nďż˝mďż˝stďż˝ 32 pracovnďż˝ zprďż˝va k 12.10.2005.doc","windows-1250");
      System.out.println(s);
      s = URLDecoder.decode(s,"windows-1250");
      System.out.println(s);
    }
    catch(Throwable t) 
    {
      t.printStackTrace();
    }
*/
  }


  public void deleteUcSkup() throws KisException
  {
    try (Statement st = getDBTransaction().createStatement(0))
    {
      st.execute("DELETE FROM DB_JT.KP_REL_UCETNISKUPINACLEN");
      st.execute("INSERT INTO DB_JT.KP_LOG_UCETNISKUPINACLEN (S_AKCE,S_UZIVATEL) VALUES ('DeleteAll','"+getUser()+"')");
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury deleteUcSkup()",s);
    }
  }
  
  public void insertUcSkup(int idSpol,
                           int idCis) throws KisException
  {
    try (Statement st = getDBTransaction().createStatement(0))
    {
      st.execute("INSERT INTO DB_JT.KP_REL_UCETNISKUPINACLEN (ID_KTGUCETNISKUPINA,ID_KTGUCETNISPOLECNOST)"+
                 " VALUES ("+idCis+","+idSpol+")");
      st.execute("INSERT INTO DB_JT.KP_LOG_UCETNISKUPINACLEN (S_AKCE,ID_KTGUCETNISKUPINA,ID_KTGUCETNISPOLECNOST,S_UZIVATEL) VALUES ('Insert',"+idCis+","+idSpol+",'"+getUser()+"')");
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury insertUcSkup()",s);
    }
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostView1
   */
  public KpKtgUcetnispolecnostViewImpl getKpKtgUcetnispolecnostView1()
  {
    return (KpKtgUcetnispolecnostViewImpl)findViewObject("KpKtgUcetnispolecnostView1");
  }

  /**
   * 
   * Container's getter for KpTmpCissubjectView1
   */
  public KpTmpCissubjectViewImpl getKpTmpCissubjectView1()
  {
    return (KpTmpCissubjectViewImpl)findViewObject("KpTmpCissubjectView1");
  }

  /**
   * 
   * Container's getter for KpCisMenaView1
   */
  public KpCisMenaViewImpl getKpCisMenaView1()
  {
    return (KpCisMenaViewImpl)findViewObject("KpCisMenaView1");
  }

  /**
   * 
   * Container's getter for KpCisSpolecnostkategorieView1
   */
  public KpCisSpolecnostkategorieViewImpl getKpCisSpolecnostkategorieView1()
  {
    return (KpCisSpolecnostkategorieViewImpl)findViewObject("KpCisSpolecnostkategorieView1");
  }

  /**
   * 
   * Container's getter for KpCisKatspolView1
   */
  public KpCisKatspolViewImpl getKpCisKatspolView1()
  {
    return (KpCisKatspolViewImpl)findViewObject("KpCisKatspolView1");
  }
  
  private int getPuvodniOsoba(int idSpol,
                              String sloupec)
  {
    int idOsoba = -1;
  
    ViewObject vo = getKpKtgUcetnispolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idSpol);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      Number hlp = (Number) row.getAttribute(sloupec);
      if(hlp!=null) idOsoba = hlp.intValue();
    }
    vo.closeRowSet();
    
    return idOsoba;
  }

  private int getMngSegmentBoss(int idSpol)
  {
    Number idMngSeg = null;
    int idOsoba = -1;

    ViewObject vo = getKpKtgUcetnispolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idSpol);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      idMngSeg = (Number) row.getAttribute("IdMngsegment");
    }
    vo.closeRowSet();
  
    vo = getKpDatMngsegmentbossView1();
    vo.clearCache();
    vo.setWhereClause("KpDatMngsegmentboss.ID_MNGSEGMENT = "+idMngSeg);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      Number hlp = (Number) row.getAttribute("IdBoss");
      if(hlp!=null) idOsoba = hlp.intValue();
    }
    vo.closeRowSet();
    
    return idOsoba;
  }

  private String getMngSegment(int idMngSeg)
  {
    String nazev = null;

    ViewObject vo = getKpCisMngsegmentView1();
    vo.clearCache();
    vo.setWhereClause("KpCisMngsegment.ID = "+idMngSeg);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      nazev = (String) row.getAttribute("SPopis");
    }
    vo.closeRowSet();
    
    return nazev;
  }

  private Object getPuvodniHodnota(int idSpol,
                                   String sloupec)
  {
    Object ret = null;
  
    ViewObject vo = getKpKtgUcetnispolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idSpol);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      ret = row.getAttribute(sloupec);
    }
    vo.closeRowSet();
    
    return ret;
  }
  
  public int processSpolecnost(String akce,
                                int idSpol,
                                int idCissubject,
                                String ico,
                                int spinId,
                                String topasId,
                                String questId,
                                String extSystem,
                                String nazev,
                                String pocitatRozvahu,
                                String souborPredpona,
                                //String mena,
                                //String dbLink,
                                int idDatabaze,
                                String autoGen,
                                int idKat,
                                String rkc,
                                String zkratka,
                                String datumArchivace,
                                String opce,
                                int idOpce,
                                int idNominee,
                                int idKatspol,
                                int idUcetni,
                                int idOdpovednaosoba,
                                int idAdministrator,
                                String poznamka,
                                int idTypProjektu,
                                String dtObdobiStart,
                                String dtObdobiKonec,
                                boolean isAdmin,
                                int idEvidSpol,
                                String online,
                                String dtOnlineOd,
                                String country,
                                int idMngSeg) throws KisException
  {
    if(!isAdmin && "I".equals(akce)) 
    {
      if(!"M".equals(extSystem)) 
      {
        throw new KisException("Uďż˝ivatel s Vaďż˝imi oprďż˝vnďż˝nďż˝mi mďż˝ďż˝e nastavovat jen manuďż˝lnďż˝ spoleďż˝nosti. Systďż˝m tedy musďż˝ bďż˝t 'M'.",
              new KisException(Constants.ERR_MESSAGE_ONLY));
      }
      if(900!=idDatabaze) 
      {
        throw new KisException("Uďż˝ivatel s Vaďż˝imi oprďż˝vnďż˝nďż˝mi mďż˝ďż˝e nastavovat jen manuďż˝lnďż˝ spoleďż˝nosti. DB Link tedy musďż˝ bďż˝t 'Manual'.",
              new KisException(Constants.ERR_MESSAGE_ONLY));
      }
    }
    
    if(ico!=null) ico=ico.trim();
    if(souborPredpona!=null) 
    {
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","a");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","c");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","d");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","e");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","e");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","i");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","n");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","o");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","r");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","s");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","t");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","u");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","u");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","y");
      souborPredpona = souborPredpona.replaceAll("[ďż˝ďż˝]","z");
      souborPredpona = souborPredpona.replaceAll("\\W","_");
    }
    
    List list = new ArrayList();
    if(nazev==null || nazev.length()==0) { list.add("Nďż˝zev"); }
    if(ico==null || ico.length()==0) { list.add("Iďż˝"); }
    if(souborPredpona==null || souborPredpona.length()==0) { list.add("Adresďż˝ďż˝ souborďż˝"); }
    //if(dbLink==null || dbLink.length()==0) { list.add("DB - Link"); }
    if(extSystem==null || extSystem.length()==0) { list.add("Systďż˝m (T|S|Q|M)"); }
    if(list.size() > 0) 
    {
      StringBuffer buf = new StringBuffer("Chybďż˝ nďż˝sledujďż˝cďż˝ povinnďż˝ nebo potďż˝ebnďż˝ ďż˝daje: ");
      Iterator iter = list.iterator(); boolean first = true;
      while(iter.hasNext()) 
      {
        String txt = (String) iter.next();
        if(first) first=false;
        else buf.append(", ");
        buf.append("\""+txt+"\"");
      }
      throw new KisException(buf.toString(),
            new KisException(Constants.ERR_MESSAGE_ONLY));
    }
  
    Statement st = getDBTransaction().createStatement(0);
    datumArchivace = datumArchivace==null || "".equals(datumArchivace.trim()) ?
      "NULL" : "TO_DATE('"+datumArchivace+"','dd.mm.yyyy')";
    if(dtObdobiStart==null || "".equals(dtObdobiStart.trim())) dtObdobiStart = "'01.01.'||to_char(sysdate,'yyyy')";
    else dtObdobiStart = "'"+dtObdobiStart+"'";
    dtObdobiStart = "TO_DATE("+dtObdobiStart+",'dd.mm.yyyy')";
    if(dtObdobiKonec==null || "".equals(dtObdobiKonec.trim())) dtObdobiKonec = "'31.12.'||to_char(sysdate,'yyyy')";
    else dtObdobiKonec = "'"+dtObdobiKonec+"'";
    dtObdobiKonec = "TO_DATE("+dtObdobiKonec+",'dd.mm.yyyy')";
    dtOnlineOd = dtOnlineOd==null || "".equals(dtOnlineOd.trim()) ?
      "NULL" : "TO_DATE('"+dtOnlineOd+"','dd.mm.yyyy')";
    String sql;  

    int origUcetni = -1,
        origOO = -1,
        origAdmin = -1,
        origTop = -1,
        origBoss = -1;
    String origOnline = null;
    int origIdKatspol = -1,
        origIdMngSeg = -1;
    if("U".equals(akce)) 
    {
      origUcetni = getPuvodniOsoba(idSpol,"IdZodpovednaucetni");
      origOO = getPuvodniOsoba(idSpol,"IdOdpovednaosoba");
      origAdmin = getPuvodniOsoba(idSpol,"IdAdministrator");
      origTop = getPuvodniOsoba(idSpol,"IdTopmng");
      origOnline = (String)getPuvodniHodnota(idSpol, "COnline");
      Number hlpNum = (Number)getPuvodniHodnota(idSpol, "IdCiskatspol");
      origIdKatspol = hlpNum!=null ? hlpNum.intValue() : -1;
      hlpNum = (Number)getPuvodniHodnota(idSpol, "IdMngsegment");
      origIdMngSeg = hlpNum!=null ? hlpNum.intValue() : -1;
      origBoss = getMngSegmentBoss(origIdMngSeg);
      sql = "UPDATE DB_JT.KP_KTG_UCETNISPOLECNOST SET ID_CISSUBJECT="+idCissubject+", "+
                                                      "S_ICO='"+ico+"', "+
                                                      //"SPIN_ID="+(spinId<0?"NULL":""+spinId)+", "+
                                                      //"TOPAS_ID='"+topasId+"', "+
                                                      //"QUEST_ID='"+questId+"', "+
                                                      //"C_EXTSYSTEM='"+extSystem+"', "+
                                                      "S_NAZEV='"+nazev+"', "+
                                                      "C_POCITATROZVAHU='"+pocitatRozvahu+"', "+
                                                      "S_SOUBORPREDPONA='"+souborPredpona+"', "+
                                                      //"S_MENA='"+mena+"', "+
                                                      //"S_DBLINK='"+dbLink+"', "+
                                                      //"ID_CISDATABAZE = "+idDatabaze+", "+
                                                      "C_AUTOMATICKEGENEROVANI='"+autoGen+"', "+
                                                      "ID_KATEGORIE="+idKat+", "+
                                                      "C_RKC='"+rkc+"', "+
                                                      "S_ZKRATKA='"+zkratka+"', "+
                                                      "ID_ZODPOVEDNAUCETNI="+idUcetni+", "+
                                                      "DT_DATUMARCHIVACE="+datumArchivace+", "+
                                                      "C_OPCE='"+opce+"', "+
                                                      "ID_CISOPCE="+idOpce+", "+
                                                      "ID_CISNOMINEE="+idNominee+", "+
                                                      "ID_ODPOVEDNAOSOBA="+idOdpovednaosoba+", "+
                                                      "ID_ADMINISTRATOR="+idAdministrator+", "+
                                                      "S_POZNAMKA='"+poznamka+"', "+
                                                      "ID_CISKATSPOL="+idKatspol+", "+
                                                      "ID_TYPPROJEKTU="+idTypProjektu+","+
                                                      "DT_UCETNIOBDOBISTART="+dtObdobiStart+","+
                                                      "DT_UCETNIOBDOBIKONEC="+dtObdobiKonec+","+
                                                      "C_ONLINE='"+online+"',"+
                                                      "DT_ONLINEOD="+dtOnlineOd+", "+
                                                      "ID_MNGSEGMENT="+(idMngSeg>0?""+idMngSeg:"NULL")+","+
                                                      "S_UZIVATEL='"+getUser()+"'"+
                                                      " WHERE ID="+idSpol;
    }
    else 
    {
      try 
      {
        ResultSet rs = st.executeQuery("select db_jt.f_nextIdUcSpol('"+extSystem+"') from dual");
        if(rs.next()) 
        {
          idSpol = rs.getInt(1);
        }
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury processSpolecnost()",s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
      st = getDBTransaction().createStatement(0);
      sql = "INSERT INTO DB_JT.KP_KTG_UCETNISPOLECNOST ("+
            "ID, ID_CISSUBJECT, S_ICO, SPIN_ID, TOPAS_ID, QUEST_ID, C_EXTSYSTEM, S_NAZEV, C_POCITATROZVAHU, "+
            "S_SOUBORPREDPONA, S_MENA, ID_CISDATABAZE, C_AUTOMATICKEGENEROVANI, ID_KATEGORIE, C_RKC, S_ZKRATKA, ID_ZODPOVEDNAUCETNI, "+
            "DT_DATUMARCHIVACE, C_OPCE, ID_CISOPCE, ID_CISNOMINEE, ID_ODPOVEDNAOSOBA, ID_ADMINISTRATOR, S_POZNAMKA, "+
            "ID_CISKATSPOL, ID_TYPPROJEKTU, DT_UCETNIOBDOBISTART, DT_UCETNIOBDOBIKONEC, C_ONLINE, DT_ONLINEOD, ID_MNGSEGMENT, S_UZIVATEL) "+
            "VALUES ("+idSpol+", "+idCissubject+", '"+ico+"', NULL, '', "+
            "'', '"+extSystem+"', '"+nazev+"', '"+pocitatRozvahu+"', '"+souborPredpona+"', 'CZK', "+
            idDatabaze+", '"+autoGen+"', "+idKat+", '"+rkc+"', '"+zkratka+"', "+idUcetni+", "+
            datumArchivace+", '"+opce+"', "+idOpce+", "+idNominee+", "+idOdpovednaosoba+", "+idAdministrator+", '"+poznamka+"', "+
            idKatspol+", "+idTypProjektu+", "+dtObdobiStart+", "+dtObdobiKonec+", '"+online+"', "+dtOnlineOd+", "+(idMngSeg>0?""+idMngSeg:"NULL")+", '"+getUser()+"')";
    }

    try 
    {
      st.execute(sql);
      getDBTransaction().commit();
      int idBoss = getMngSegmentBoss(idSpol);
      int[] osoby = new int[] {idUcetni,idOdpovednaosoba,idAdministrator/*,idTopmng,idBoss*/};
      if("I".equals(akce)) {
        Mail mail = new Mail();
        mail.sendNewSpolecnost(this,idSpol,nazev,osoby,idMngSeg);
        if(idUcetni>0) mail.sendNewSpolecnost(this,idSpol,nazev,idUcetni,"zodpovďż˝dnďż˝/ďż˝ ďż˝ďż˝etnďż˝",osoby,idMngSeg);
        if(idOdpovednaosoba>0) mail.sendNewSpolecnost(this,idSpol,nazev,idOdpovednaosoba,"odpovďż˝dnďż˝ osoba",osoby,idMngSeg);
        if(idAdministrator>0) mail.sendNewSpolecnost(this,idSpol,nazev,idAdministrator,"administrďż˝tor/ka",osoby,idMngSeg);
        //if(idTopmng>0) mail.sendNewSpolecnost(this,idSpol,nazev,idTopmng,"top manager/ka",osoby);
      }
      else if("U".equals(akce)) {
        Mail mail = new Mail();
        if(idUcetni!=origUcetni) mail.sendChngSpolecnost(this,idSpol,nazev,idUcetni,origUcetni,"zodpovďż˝dnďż˝/ďż˝ ďż˝ďż˝etnďż˝",osoby,idMngSeg);
        if(idOdpovednaosoba!=origOO) mail.sendChngSpolecnost(this,idSpol,nazev,idOdpovednaosoba,origOO,"odpovďż˝dnďż˝ osoba",osoby,idMngSeg);
        if(idAdministrator!=origAdmin) mail.sendChngSpolecnost(this,idSpol,nazev,idAdministrator,origAdmin,"administrďż˝tor/ka",osoby,idMngSeg);
        //if(idTopmng!=origTop) mail.sendChngSpolecnost(this,idSpol,nazev,idTopmng,origTop,"top manager/ka",osoby);
        if(!online.equals(origOnline)) mail.sendOnlineSpolecnost(this,idSpol,nazev,osoby,online,idMngSeg);
        if(idKatspol!=origIdKatspol && !"NULL".equals(datumArchivace)) 
        {
          if((idKatspol==5 || idKatspol==10) && (origIdKatspol!=5 && origIdKatspol!=10))
          {
            mail.sendChngSpolecnostKat(this,idSpol,nazev,osoby,false,idMngSeg);
          }
          else if((origIdKatspol==5 || origIdKatspol==10) && (idKatspol!=5 && idKatspol!=10)) 
          {
            mail.sendChngSpolecnostKat(this,idSpol,nazev,osoby,true,idMngSeg);
          }
        }
        if(origIdMngSeg != idMngSeg) 
        {
          mail.sendChngSpolecnostMngSeg(this,idSpol,nazev,
                                        new int[]{origBoss,idBoss},
                                        getMngSegment(origIdMngSeg),
                                        getMngSegment(idMngSeg),
                                        idMngSeg,
                                        origIdMngSeg);
        }
      }
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury processSpolecnost()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    if(country!=null) {
      try 
      {
        st = getDBTransaction().createStatement(0);
        st.execute("UPDATE DB_JT.KP_KTG_SPOLECNOST SET S_COUNTRY = '"+country+"' WHERE ID_KTGSPOLECNOST = "+idSpol);
        getDBTransaction().commit();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury processSpolecnost() - country",s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    if("I".equals(akce) && idEvidSpol>0) 
    {
      try 
      {
        st = getDBTransaction().createStatement(0);
        st.execute("UPDATE DB_JT.KP_KTG_EVIADMINSPOLECNOST SET ID_KTGUCETNISPOLECNOST = "+idSpol+" WHERE ID = "+idEvidSpol);
        getDBTransaction().commit();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury processSpolecnost()",s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
/*
    //jeste zapsat log
    st = getDBTransaction().createStatement(0);
    sql = "INSERT INTO DB_JT.KP_LOG_UCETNISPOLECNOST ("+
          "S_AKCE, ID, ID_CISSUBJECT, S_ICO, SPIN_ID, TOPAS_ID, QUEST_ID, C_EXTSYSTEM, S_NAZEV, C_POCITATROZVAHU, "+
          "S_SOUBORPREDPONA, S_MENA, ID_CISDATABAZE, C_AUTOMATICKEGENEROVANI, ID_KATEGORIE, C_RKC, S_ZKRATKA, ID_ZODPOVEDNAUCETNI, "+
          "DT_DATUMARCHIVACE, C_OPCE, ID_CISOPCE, ID_CISNOMINEE, ID_ODPOVEDNAOSOBA, ID_TOPMNG, ID_ADMINISTRATOR, S_POZNAMKA, "+
          "ID_CISKATSPOL, ID_TYPPROJEKTU, S_UZIVATEL, DT_UCETNIOBDOBISTART, DT_UCETNIOBDOBIKONEC, C_ONLINE, DT_ONLINEOD) "+
          "VALUES ('"+akce+"', "+idSpol+", "+idCissubject+", '"+ico+"', "+(spinId<0?"NULL":""+spinId)+", '"+topasId+"', "+
          "'"+questId+"', '"+extSystem+"', '"+nazev+"', '"+pocitatRozvahu+"', '"+souborPredpona+"', '"+mena+"', "+
          idDatabaze+", '"+autoGen+"', "+idKat+", '"+rkc+"', '"+zkratka+"', "+idUcetni+", "+
          datumArchivace+", '"+opce+"', "+idOpce+", "+idNominee+", "+idOdpovednaosoba+", "+idTopmng+", "+idAdministrator+", '"+poznamka+"', "+
          idKatspol+", "+idTypProjektu+", '"+getUser()+"', "+dtObdobiStart+", "+dtObdobiKonec+", '"+online+"', "+dtOnlineOd+")";
    try 
    {
      st.execute(sql);
      getDBTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury processSpolecnost()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { }
    }
*/    
    return idSpol;
  }

  public void setDanovaZtrata(int idSpol,
                              String datum,
                              String danZtr,
                              double castkaDanZtr,
                              double vyuzDanZtr)  throws KisException 
  {
    boolean insert = true;
    Statement st = null;
    String sql = "select * from DB_JT.KP_DAT_DANE "+
                 " WHERE ID_KTGUCETNISPOLECNOST = "+idSpol+" AND DT_DATUM = TO_DATE('"+datum+"','DD.MM.YYYY')";
    try 
    {
      st = getDBTransaction().createStatement(0);
      ResultSet rs = st.executeQuery(sql);
      if(rs.next()) insert = false;
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury setDanovaZtrata()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  
    if(insert) 
    {
      sql = "INSERT INTO DB_JT.KP_DAT_DANE (ID_KTGUCETNISPOLECNOST, DT_DATUM, C_DANOVAZTRATA, ND_CASTKADANZTRATA, ND_VYUZITIDANZTRATA) "+
            " VALUES ("+idSpol+",TO_DATE('"+datum+"','DD.MM.YYYY'),'"+danZtr+"',"+castkaDanZtr+","+vyuzDanZtr+")";
    }
    else 
    {
      sql = "UPDATE DB_JT.KP_DAT_DANE SET C_DANOVAZTRATA = '"+danZtr+"', "+
                                         "ND_CASTKADANZTRATA = "+castkaDanZtr+", "+
                                         "ND_VYUZITIDANZTRATA = "+vyuzDanZtr+" "+
            " WHERE ID_KTGUCETNISPOLECNOST = "+idSpol+" AND DT_DATUM = TO_DATE('"+datum+"','DD.MM.YYYY')";
    }
    try 
    {
      st = getDBTransaction().createStatement(0);
      st.execute(sql);
      getDBTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury setDanovaZtrata()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void setOdhady(int idSpol,
                        String datum,
                        double odhadHV,
                        double odhadDZ,
                        String platceDPH,
                        int freqDPH)  throws KisException 
  {
    boolean insert = true;
    Statement st = null;
    String sql = "select * from DB_JT.KP_DAT_DANE "+
                 " WHERE ID_KTGUCETNISPOLECNOST = "+idSpol+" AND DT_DATUM = TO_DATE('"+datum+"','DD.MM.YYYY')";
    try 
    {
      st = getDBTransaction().createStatement(0);
      ResultSet rs = st.executeQuery(sql);
      if(rs.next()) insert = false;
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury setOdhady()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  
    if(insert) 
    {
      sql = "INSERT INTO DB_JT.KP_DAT_DANE (ID_KTGUCETNISPOLECNOST, DT_DATUM, ND_ODHADHOSPVYSL, ND_ODHADZAKLADUDANE, C_PLATCEDPH, ID_FREKVENCEDPH) "+
            " VALUES ("+idSpol+",TO_DATE('"+datum+"','DD.MM.YYYY'),"+odhadHV+","+odhadDZ+",'"+platceDPH+"',"+freqDPH+")";
    }
    else 
    {
      sql = "UPDATE DB_JT.KP_DAT_DANE SET ND_ODHADHOSPVYSL = "+odhadHV+", "+
                                         "ND_ODHADZAKLADUDANE = "+odhadDZ+", "+
                                         "C_PLATCEDPH = "+platceDPH+", "+
                                         "ID_FREKVENCEDPH = "+freqDPH+" "+
            " WHERE ID_KTGUCETNISPOLECNOST = "+idSpol+" AND DT_DATUM = TO_DATE('"+datum+"','DD.MM.YYYY')";
    }
    try 
    {
      st = getDBTransaction().createStatement(0);
      st.execute(sql);
      getDBTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury setOdhady()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void exportExcel(java.sql.Date datum) throws KisException 
  {
    ESExportSpolecnosti es = new ESExportSpolecnosti(this, datum);
    try {
      es.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  public void exportExcelPredavani(java.sql.Date datum) throws KisException 
  {
    ESExportSpolecnosti es = new ESExportSpolecnosti(this, datum, true);
    try {
      es.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }
  
  java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);
  
  public String getExcels() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_SPOLECNOSTI;
    File dir = new File(dirName);
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_SPOLECNOSTI+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public String getExcelsPredavani() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_SPOL_PREDAV;
    File dir = new File(dirName);
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_SPOL_PREDAV+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }


  /**
   * 
   * Container's getter for KtgAppuserView1
   */
  public KtgAppuserViewImpl getKtgAppuserView1()
  {
    return (KtgAppuserViewImpl)findViewObject("KtgAppuserView1");
  }

  /**
   * 
   * Container's getter for VwRelUcetniskupinaclenView1
   */
  public VwRelUcetniskupinaclenViewImpl getVwRelUcetniskupinaclenView1()
  {
    return (VwRelUcetniskupinaclenViewImpl)findViewObject("VwRelUcetniskupinaclenView1");
  }

  /**
   * 
   * Container's getter for VwProtistranaView1
   */
  public VwProtistranaViewImpl getVwProtistranaView1()
  {
    return (VwProtistranaViewImpl)findViewObject("VwProtistranaView1");
  }

  /**
   * 
   * Container's getter for VwKpDokladposlednisumView1
   */
  public VwKpDokladposlednisumViewImpl getVwKpDokladposlednisumView1()
  {
    return (VwKpDokladposlednisumViewImpl)findViewObject("VwKpDokladposlednisumView1");
  }

  /**
   * 
   * Container's getter for KpCisStatView1
   */
  public KpCisStatViewImpl getKpCisStatView1()
  {
    return (KpCisStatViewImpl)findViewObject("KpCisStatView1");
  }

  /**
   * 
   * Container's getter for KpDatDanovesazbyView1
   */
  public KpDatDanovesazbyViewImpl getKpDatDanovesazbyView1()
  {
    return (KpDatDanovesazbyViewImpl)findViewObject("KpDatDanovesazbyView1");
  }

  public void danoveSazby(String akce,
                          int id,
                          String stat,
                          double pasmoOd,
                          double pasmoDo,
                          String mena,
                          double sazba,
                          java.sql.Date platnostOd,
                          java.sql.Date platnostDo) throws KisException
  {
    DBTransaction dbTran = getDBTransaction();
    CallableStatement st = null;
    //Smazat pouzity radek
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KpDatDanoveSazby(?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1,akce);
      st.setInt(2,id);
      st.setString(3,stat);
      st.setDouble(4,pasmoOd);
      st.setDouble(5,pasmoDo);
      st.setString(6,mena);
      st.setDouble(7,sazba);
      st.setDate(8,platnostOd);
      st.setDate(9,platnostDo);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury db_jt.kap_gui.p_KpDatDanoveSazby",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void addStat(String id,String nazev) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("INSERT INTO DB_JT.KP_CIS_STAT (ID,S_POPIS)"+
                 " VALUES ('"+id+"','"+nazev+"')",0);
      st.execute();
      this.getTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo INSERT INTO DB_JT.KP_CIS_STAT",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpCisFrekvencedphView1
   */
  public KpCisFrekvencedphViewImpl getKpCisFrekvencedphView1()
  {
    return (KpCisFrekvencedphViewImpl)findViewObject("KpCisFrekvencedphView1");
  }

  /**
   * 
   * Container's getter for KpDatDaneView1
   */
  public KpDatDaneViewImpl getKpDatDaneView1()
  {
    return (KpDatDaneViewImpl)findViewObject("KpDatDaneView1");
  }

  private String getUser() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, false);
    return user;
  }

  public int currentUsersId() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    Number userId = null;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("S_USERID = '"+user+"'");
    if(voUser.hasNext()) 
    {
      Row rowUser = voUser.next();
      userId = (Number) rowUser.getAttribute("Id");
    }
    voUser.closeRowSet();
    if(userId == null) return -1;
    
    return userId.intValue();
  }

  public boolean isCurrentUserType(int idSpol, int typeUser) 
  {
    boolean ret = false;
    int userId = currentUsersId();
    if(userId==81) return true;

    String where = null;
    if(typeUser==Constants.UCETNI) where="ID_ZODPOVEDNAUCETNI = "+userId;
    else if(typeUser==Constants.OO) where="ID_ODPOVEDNAOSOBA = "+userId;
    else if(typeUser==Constants.TOP) where="ID_TOPMNG = "+userId;
    else if(typeUser==Constants.NADRIZENA_UCETNI) where="ID_ZODPOVEDNAUCETNI in (select id from db_jt.ktg_appUser au where au.ID_NADRIZENAUCETNI = "+userId+")";
    else if(typeUser==Constants.SPRAVCE) where="ID_SPRAVCEKONSOLIDACE = "+userId;
    else if(typeUser==Constants.SEF_SEGMENTU) where="ID_MNGSEGMENTBOSS = "+userId;
    
    ViewObject vo = getKpKtgUcetnispolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idSpol+
                      " AND "+where);
    if(vo.hasNext()) 
    {
      ret = true;
    }
    vo.closeRowSet();
    
    return ret;
  }

  /**
   * 
   * Container's getter for KpCisOpceView1
   */
  public KpCisOpceViewImpl getKpCisOpceView1()
  {
    return (KpCisOpceViewImpl)findViewObject("KpCisOpceView1");
  }

  /**
   * 
   * Container's getter for KpDatAuditView1
   */
  public KpDatAuditViewImpl getKpDatAuditView1()
  {
    return (KpDatAuditViewImpl)findViewObject("KpDatAuditView1");
  }

  public void setAudit(int idSpol,
                       String datum,
                       String audit,
                       String auditor,
                       double cenaStat,
                       String menaStat,
                       String auditBalik,
                       double cenaBalik,
                       String menaBalik,
                       double cenaStatBalik,
                       String menaStatBalik,
                       String datumPriznani,
                       String priznani)  throws KisException 
  {
    boolean insert = true;
    Statement st = null;
    String sql = "select * from DB_JT.KP_DAT_AUDIT "+
                 " WHERE ID_KTGUCETNISPOLECNOST = "+idSpol+" AND DT_DATUM = TO_DATE('"+datum+"','DD.MM.YYYY')";
    try 
    {
      st = getDBTransaction().createStatement(0);
      ResultSet rs = st.executeQuery(sql);
      if(rs.next()) insert = false;
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury setAudit()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  
    if(insert) 
    {
      sql = "INSERT INTO DB_JT.KP_DAT_AUDIT (ID_KTGUCETNISPOLECNOST, DT_DATUM, C_POVINNOST, S_AUDITOR, ND_CENASTAT, S_MENASTAT, "+
            "S_AUDITBALIK, ND_CENABALIK, S_MENABALIK, ND_CENASTATBALIK, S_MENASTATBALIK, DT_TERMINPRIZNANI, C_PODANOPRIZNANI) "+
            " VALUES ("+idSpol+",TO_DATE('"+datum+"','DD.MM.YYYY'),'"+audit+"','"+auditor+"',"+cenaStat+",'"+menaStat+"','"+
            auditBalik+"',"+cenaBalik+",'"+menaBalik+"',"+cenaStatBalik+",'"+menaStatBalik+"',TO_DATE('"+datumPriznani+"','DD.MM.YYYY'),'"+priznani+"')";
    }
    else 
    {
      sql = "UPDATE DB_JT.KP_DAT_AUDIT SET C_POVINNOST='"+audit+"', "+
                                          "S_AUDITOR='"+auditor+"', "+
                                          "ND_CENASTAT="+cenaStat+", "+
                                          "S_MENASTAT='"+menaStat+"', "+
                                          "S_AUDITBALIK='"+auditBalik+"', "+
                                          "ND_CENABALIK="+cenaBalik+", "+
                                          "S_MENABALIK='"+menaBalik+"', "+
                                          "ND_CENASTATBALIK="+cenaStatBalik+", "+
                                          "S_MENASTATBALIK='"+menaStatBalik+"', "+
                                          "DT_TERMINPRIZNANI=TO_DATE('"+datumPriznani+"','DD.MM.YYYY'), "+
                                          "C_PODANOPRIZNANI='"+priznani+"' "+
            " WHERE ID_KTGUCETNISPOLECNOST = "+idSpol+" AND DT_DATUM = TO_DATE('"+datum+"','DD.MM.YYYY')";
    }
    try 
    {
      st = getDBTransaction().createStatement(0);
      st.execute(sql);
      getDBTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury setAudit()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpDatDokladZamekView1
   */
  public KpDatDokladZamekViewImpl getKpDatDokladZamekView1()
  {
    return (KpDatDokladZamekViewImpl)findViewObject("KpDatDokladZamekView1");
  }

  /**
   * 
   * Container's getter for VwKpUcetnispolecnostprehledView1
   */
  public VwKpUcetnispolecnostprehledViewImpl getVwKpUcetnispolecnostprehledView1()
  {
    return (VwKpUcetnispolecnostprehledViewImpl)findViewObject("VwKpUcetnispolecnostprehledView1");
  }

  /**
   * 
   * Container's getter for KpCisNomineeView1
   */
  public KpCisNomineeViewImpl getKpCisNomineeView1()
  {
    return (KpCisNomineeViewImpl)findViewObject("KpCisNomineeView1");
  }

  /**
   * 
   * Container's getter for KpCisPrenosprioritaView1
   */
  public KpCisPrenosprioritaViewImpl getKpCisPrenosprioritaView1()
  {
    return (KpCisPrenosprioritaViewImpl)findViewObject("KpCisPrenosprioritaView1");
  }

  /**
   * 
   * Container's getter for KpKtgUcspolpredavaniView1
   */
  public KpKtgUcspolpredavaniViewImpl getKpKtgUcspolpredavaniView1()
  {
    return (KpKtgUcspolpredavaniViewImpl)findViewObject("KpKtgUcspolpredavaniView1");
  }

  public void ucSpolPredavani(String akce,
                              int idUcSpol,
                              int priorita,
                              int kat,
                              String accStatus,
                              String uzavrUcet,
                              java.sql.Date datum) throws KisException
  {
    DBTransaction dbTran = getDBTransaction();
    CallableStatement st = null;
    //Smazat pouzity radek
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_KpKtgUcSpolPredavani(?,?,?,?,?,?,?,?); end;",0);
      st.setString(1,akce);
      st.setInt(2,idUcSpol);
      st.setInt(3,priorita);
      st.setInt(4,kat);
      st.setString(5,accStatus);
      st.setString(6,uzavrUcet);
      st.setDate(7, datum);
      st.setString(8,getUser());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury db_jt.kap_guiv.p_KpKtgUcSpolPredavani",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void predavaniSchvaleno(String akce,
                                 int idUcSpol,
                                 int typOO) throws KisException
  {
    int userId = currentUsersId();
  
    DBTransaction dbTran = getDBTransaction();
    CallableStatement st = null;
    //Smazat pouzity radek
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_predavaniSchvaleno(?,?,?,?); end;",0);
      st.setString(1,akce);
      st.setInt(2,idUcSpol);
      st.setInt(3,typOO);
      st.setInt(4,userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury db_jt.kap_guiv.p_predavaniSchvaleno",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for VwKtgUcspolpredavaniView1
   */
  public VwKtgUcspolpredavaniViewImpl getVwKtgUcspolpredavaniView1()
  {
    return (VwKtgUcspolpredavaniViewImpl)findViewObject("VwKtgUcspolpredavaniView1");
  }

  /**
   * 
   * Container's getter for KpCisPrenoskategorieView1
   */
  public KpCisPrenoskategorieViewImpl getKpCisPrenoskategorieView1()
  {
    return (KpCisPrenoskategorieViewImpl)findViewObject("KpCisPrenoskategorieView1");
  }

  /**
   * 
   * Container's getter for VwRelSubkonsolidaceclenView1
   */
  public VwRelSubkonsolidaceclenViewImpl getVwRelSubkonsolidaceclenView1()
  {
    return (VwRelSubkonsolidaceclenViewImpl)findViewObject("VwRelSubkonsolidaceclenView1");
  }

  /**
   * 
   * Container's getter for DatKurzlistavgView1
   */
  public DatKurzlistavgViewImpl getDatKurzlistavgView1()
  {
    return (DatKurzlistavgViewImpl)findViewObject("DatKurzlistavgView1");
  }

  /**
   * 
   * Container's getter for CisBankaView1
   */
  public CisBankaViewImpl getCisBankaView1()
  {
    return (CisBankaViewImpl)findViewObject("CisBankaView1");
  }
  
  public void setKurzovyListek(String datum,
                               int cisBanka,
                               String cisMena,
                               double kurz,
                               int kvantita) throws KisException 
  {
    String sql = null;
  
    ViewObject voTest = getDatKurzlistavgView1();
    voTest.clearCache();
    voTest.setWhereClause("DT_DATUM = TO_DATE('"+datum+"','dd.mm.yyyy') "+
                      "AND ID_CISBANKA = "+cisBanka+" "+
                      "AND ID_CISMENA = '"+cisMena+"'");
    if(voTest.hasNext()) 
    {
      sql = "UPDATE DB_JT.DAT_KURZLISTAVG SET ND_KURZ = "+kurz+", NL_KVANTITA = "+kvantita+" "+
            "WHERE DT_DATUM = TO_DATE('"+datum+"','dd.mm.yyyy') "+
              "AND ID_CISBANKA = "+cisBanka+" "+
              "AND ID_CISMENA = '"+cisMena+"'";
    }
    else 
    {
      sql = "INSERT INTO DB_JT.DAT_KURZLISTAVG (DT_DATUM, ID_CISBANKA, ID_CISMENA, ND_KURZ, NL_KVANTITA) VALUES "+
            "(TO_DATE('"+datum+"','dd.mm.yyyy'),"+cisBanka+",'"+cisMena+"',"+kurz+","+kvantita+")";
    }
    voTest.closeRowSet();
    
    DBTransaction dbTran = getDBTransaction();
    Statement st = null;
    //Smazat pouzity radek
    try {
      st = dbTran.createStatement(0);
      st.execute(sql);
      dbTran.commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo spusteni SQL: "+sql,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
  }

  /**
   * 
   * Container's getter for VwKtgUcetnispolecnostView1
   */
  public VwKtgUcetnispolecnostViewImpl getVwKtgUcetnispolecnostView1()
  {
    return (VwKtgUcetnispolecnostViewImpl)findViewObject("VwKtgUcetnispolecnostView1");
  }

  /**
   * 
   * Container's getter for KpDatDokladView1
   */
  public KpDatDokladViewImpl getKpDatDokladView1()
  {
    return (KpDatDokladViewImpl)findViewObject("KpDatDokladView1");
  }

  /**
   * 
   * Container's getter for KpEmailParamView1
   */
  public KpEmailParamViewImpl getKpEmailParamView1()
  {
    return (KpEmailParamViewImpl)findViewObject("KpEmailParamView1");
  }

  /**
   * 
   * Container's getter for KpKtgEmailzpravyView1
   */
  public KpKtgEmailzpravyViewImpl getKpKtgEmailzpravyView1()
  {
    return (KpKtgEmailzpravyViewImpl)findViewObject("KpKtgEmailzpravyView1");
  }

  /**
   * 
   * Container's getter for KpRelSubkonsolidaceclenView1
   */
  public KpRelSubkonsolidaceclenViewImpl getKpRelSubkonsolidaceclenView1()
  {
    return (KpRelSubkonsolidaceclenViewImpl)findViewObject("KpRelSubkonsolidaceclenView1");
  }

  /**
   * 
   * Container's getter for KpCisTypprojektuView1
   */
  public KpCisTypprojektuViewImpl getKpCisTypprojektuView1()
  {
    return (KpCisTypprojektuViewImpl)findViewObject("KpCisTypprojektuView1");
  }

  /**
   * 
   * Container's getter for CisLocaleView1
   */
  public CisLocaleViewImpl getCisLocaleView1()
  {
    return (CisLocaleViewImpl)findViewObject("CisLocaleView1");
  }

  /**
   * 
   * Container's getter for KpKtgEviadminspolecnostView1
   */
  public KpKtgEviadminspolecnostViewImpl getKpKtgEviadminspolecnostView1()
  {
    return (KpKtgEviadminspolecnostViewImpl)findViewObject("KpKtgEviadminspolecnostView1");
  }

  /**
   * 
   * Container's getter for VwKpDokladzustatkyuctuprotiView1
   */
  public VwKpDokladzustatkyuctuprotiViewImpl getVwKpDokladzustatkyuctuprotiView1()
  {
    return (VwKpDokladzustatkyuctuprotiViewImpl)findViewObject("VwKpDokladzustatkyuctuprotiView1");
  }

  private FileFilter ff = new FileFilter() {
      public boolean accept(File pathname) 
      {
        return true;
      }
    };

  private boolean checkOpraveni(String type, int id) 
  {
    boolean ret = true;
    
    if(type.startsWith("proj")) {
      int idUser = currentUsersId();
    
      ViewObject vo = getVwKtgProjektView1();
      vo.clearCache();
      vo.setWhereClause("ID = "+id+" AND ID_PMANAGER = "+idUser);
      if(!vo.hasNext()) 
      {
        ret = false;
      }
      vo.closeRowSet();
    }
    
    return ret;
  }

  /**
   * 
   * Gets the attribute value for the calculated attribute Prilohy
   */
  public String getPrilohy(String typ, int id, boolean deletable)
  {
    if(deletable) deletable=checkOpraveni(typ, id);
    
    boolean subdir = (id!=-123);
  
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.ARCHIV_FILES_PATH + typ;
    if(subdir) dirName += "\\" + id;
    File dir = new File(dirName);
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        String encName = name;
        try {
          encName = URLEncoder.encode(name, "windows-1250");
        } catch (UnsupportedEncodingException uee) {}
        typ = typ.replaceAll("\\\\","|5C");
        
        buf.append("<a target=\"_blank\" href=\"filesservlet?file=archiv|5C"+typ+"|5C"+(subdir?id+"|5C":"") + encName + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) ); 
        if(deletable) buf.append("&nbsp;<a href=\"FileDeleteOwn.jsp?file=archiv|5C"+typ+"|5C"+(subdir?id+"|5C":"") + encName + "\">DEL</a><br>");
        else buf.append("<br>");
      }
    }
    return buf.toString();
  }

  /**
   * 
   * Container's getter for VwRelSpolecnostappuserView1
   */
  public VwRelSpolecnostappuserViewImpl getVwRelSpolecnostappuserView1()
  {
    return (VwRelSpolecnostappuserViewImpl)findViewObject("VwRelSpolecnostappuserView1");
  }

  /**
   * 
   * Container's getter for VwLogUcetnispolecnostView1
   */
  public VwLogUcetnispolecnostViewImpl getVwLogUcetnispolecnostView1()
  {
    return (VwLogUcetnispolecnostViewImpl)findViewObject("VwLogUcetnispolecnostView1");
  }

  /**
   * 
   * Container's getter for KpCisDatabazeView1
   */
  public KpCisDatabazeViewImpl getKpCisDatabazeView1()
  {
    return (KpCisDatabazeViewImpl)findViewObject("KpCisDatabazeView1");
  }

  /**
   * 
   * Container's getter for VwKpDokladzustatkyuctuproti2View1
   */
  public VwKpDokladzustatkyuctuproti2ViewImpl getVwKpDokladzustatkyuctuproti2View1()
  {
    return (VwKpDokladzustatkyuctuproti2ViewImpl)findViewObject("VwKpDokladzustatkyuctuproti2View1");
  }

  /**
   * 
   * Container's getter for KpKtgSpolecnostView1
   */
  public KpKtgSpolecnostViewImpl getKpKtgSpolecnostView1()
  {
    return (KpKtgSpolecnostViewImpl)findViewObject("KpKtgSpolecnostView1");
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostLinkView1
   */
  public KpKtgUcetnispolecnostLinkViewImpl getKpKtgUcetnispolecnostLinkView1()
  {
    return (KpKtgUcetnispolecnostLinkViewImpl)findViewObject("KpKtgUcetnispolecnostLinkView1");
  }

  public void dbLink(String akce,
                     int id,
                     int idSpol,
                     String extSyst,
                     int idDb,
                     java.sql.Date dtOd,
                     java.sql.Date dtDo,
                     int spinId,
                     String topasId,
                     int idSubject,
                     String mena,
                     String ifrsPrim,
                     String idFeisPrenos) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_ktg_ucetniSpolecnost_link "+
                                            "(ID_KTGUCETNISPOLECNOST, C_EXTSYSTEM, ID_CISDATABAZE, DT_PLATNOSTOD, DT_PLATNOSTDO, SPIN_ID, TOPAS_ID, S_UZIVATEL, ID_CISSUBJECT, S_MENA, C_IFRSPRIMARNI, C_FEIS_PRENOS) "+
                                            "VALUES (?,?,?,?,?,?,?,?,?,?,?,?)",0);
        st.setInt(1,idSpol);
        st.setString(2, extSyst);
        st.setInt(3,idDb);
        st.setDate(4, dtOd);
        st.setDate(5, dtDo);
        if(spinId>0) st.setInt(6, spinId); else st.setNull(6,Types.INTEGER);
        st.setString(7, topasId);
        st.setString(8, getUser());
        st.setInt(9, idSubject);
        st.setString(10, mena);
        st.setString(11, ifrsPrim);
        st.setString(12, idFeisPrenos);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury dbLink akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_ktg_ucetniSpolecnost_link "+
                                            "SET C_EXTSYSTEM=?, ID_CISDATABAZE=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, SPIN_ID=?, TOPAS_ID=?, S_UZIVATEL=?, ID_CISSUBJECT=?, S_MENA=?, C_IFRSPRIMARNI=? , C_FEIS_PRENOS=? "+
                                            "WHERE ID=?",0);
        st.setString(1, extSyst);
        st.setInt(2,idDb);
        st.setDate(3, dtOd);
        st.setDate(4, dtDo);
        if(spinId>0) st.setInt(5, spinId); else st.setNull(5,Types.INTEGER);
        st.setString(6, topasId);
        st.setString(7, getUser());
        st.setInt(8, idSubject);
        st.setString(9, mena);
        st.setString(10, ifrsPrim);
        st.setString(11, idFeisPrenos);        
        st.setInt(12, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury dbLink akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_ktg_ucetniSpolecnost_link "+
                                            "SET S_UZIVATEL = ? "+
                                            "WHERE ID=?",0);
        st.setString(1, getUser());
        st.setInt(2, id);
        st.execute();
        st.close();
        
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_ktg_ucetniSpolecnost_link "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury dbLink akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpLogUcetnispolecnostOnlineView1
   */
  public KpLogUcetnispolecnostOnlineViewImpl getKpLogUcetnispolecnostOnlineView1()
  {
    return (KpLogUcetnispolecnostOnlineViewImpl)findViewObject("KpLogUcetnispolecnostOnlineView1");
  }

  /**
   * 
   * Container's getter for VwQProjektodborView1
   */
  public VwQProjektodborViewImpl getVwQProjektodborView1()
  {
    return (VwQProjektodborViewImpl)findViewObject("VwQProjektodborView1");
  }
  
  public void qProjektOdbor(int idSpol,
                            String poCode,
                            String rsCode,
                            String idProjekt,
                            String idOdbor) throws KisException
  {
    DBTransaction dbTran = getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_quaestorProjektOdbor(?,?,?,?,?); end;",0);
      st.setInt(1,idSpol);
      st.setString(2,poCode);
      st.setString(3,rsCode);
      st.setString(4,idProjekt);
      st.setString(5,idOdbor);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury db_jt.kap_guiv.p_quaestorProjektOdbor",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpCisMngsegmentView1
   */
  public KpCisMngsegmentViewImpl getKpCisMngsegmentView1()
  {
    return (KpCisMngsegmentViewImpl)findViewObject("KpCisMngsegmentView1");
  }

  /**
   * 
   * Container's getter for KpDatMngsegmentbossView1
   */
  public KpDatMngsegmentbossViewImpl getKpDatMngsegmentbossView1()
  {
    return (KpDatMngsegmentbossViewImpl)findViewObject("KpDatMngsegmentbossView1");
  }

  /**
   * 
   * Container's getter for VwKtgProjektView1
   */
  public VwKtgProjektViewImpl getVwKtgProjektView1()
  {
    return (VwKtgProjektViewImpl)findViewObject("VwKtgProjektView1");
  }

  /**
   * 
   * Container's getter for KpDatKartatypView1
   */
  public KpDatKartatypViewImpl getKpDatKartatypView1()
  {
    return (KpDatKartatypViewImpl)findViewObject("KpDatKartatypView1");
  }

  /**
   * 
   * Container's getter for KpRelSpolecnostkartatypView1
   */
  public KpRelSpolecnostkartatypViewImpl getKpRelSpolecnostkartatypView1()
  {
    return (KpRelSpolecnostkartatypViewImpl)findViewObject("KpRelSpolecnostkartatypView1");
  }

  /**
   * 
   * Container's getter for KpDatKartapravidlaView1
   */
  public KpDatKartapravidlaViewImpl getKpDatKartapravidlaView1()
  {
    return (KpDatKartapravidlaViewImpl)findViewObject("KpDatKartapravidlaView1");
  }

  /**
   * 
   * Container's getter for KpDatKartavyjimkyView1
   */
  public KpDatKartavyjimkyViewImpl getKpDatKartavyjimkyView1()
  {
    return (KpDatKartavyjimkyViewImpl)findViewObject("KpDatKartavyjimkyView1");
  }

  public void karta(String akce,
                    int idSpol,
                    int idKartaTyp,
                    java.sql.Date dtZprava) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_REL_SPOLECNOSTKARTATYP "+
                                            "(ID_KTGUCETNISPOLECNOST, ID_KARTATYP, DT_ZPRAVADALSI) "+
                                            "VALUES (?,?,?)",0);
        st.setInt(1,idSpol);
        st.setInt(2,idKartaTyp);
        st.setDate(3,dtZprava);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury karta akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }

    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_REL_SPOLECNOSTKARTATYP SET DT_ZPRAVADALSI=?"+
                                            "WHERE ID_KTGUCETNISPOLECNOST=? AND ID_KARTATYP=?",0);
        st.setDate(1,dtZprava);
        st.setInt(2,idSpol);
        st.setInt(3,idKartaTyp);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury karta akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_REL_SPOLECNOSTKARTATYP "+
                                            "WHERE ID_KTGUCETNISPOLECNOST=? AND ID_KARTATYP=?",0);
        st.setInt(1,idSpol);
        st.setInt(2,idKartaTyp);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury karta akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  public void kartaTyp(String akce,
                       int id,
                       String popis) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_DAT_KARTATYP "+
                                            "(S_POPIS) "+
                                            "VALUES (?)",0);
        st.setString(1, popis);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaTyp akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_KARTATYP "+
                                            "SET S_POPIS=? "+
                                            "WHERE ID=?",0);
        st.setString(1, popis);
        st.setInt(2, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaTyp akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_DAT_KARTATYP "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaTyp akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  public int kartaPravidla(String akce,
                            int id,
                            int idKartaTyp,
                            String text,
                            java.sql.Date dtOd,
                            java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("SELECT DB_JT.SQ_KP_kartaPravidla.nextVal NV FROM DUAL",0);
        ResultSet rs = st.executeQuery();
        if(rs.next()) id = rs.getInt("NV");
        rs.close();
        st.close();
      
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_DAT_KARTAPRAVIDLA "+
                                            "(ID,ID_KARTATYP,S_TEXT,DT_PLATNOSTOD,DT_PLATNOSTDO) "+
                                            "VALUES (?,?,?,?,?)",0);
        st.setInt(1, id);
        st.setInt(2, idKartaTyp);
        st.setString(3, text);
        st.setDate(4, dtOd);
        st.setDate(5, dtDo);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaPravidla akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_KARTAPRAVIDLA "+
                                            "SET ID_KARTATYP=?,S_TEXT=?,DT_PLATNOSTOD=?,DT_PLATNOSTDO=? "+
                                            "WHERE ID=?",0);
        st.setInt(1, idKartaTyp);
        st.setString(2, text);
        st.setDate(3, dtOd);
        st.setDate(4, dtDo);
        st.setInt(5, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaPravidla akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_DAT_KARTAPRAVIDLA "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaPravidla akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
    return id;
  }

  public void kartaVyjimky(String akce,
                            int id,
                            int idKartaTyp,
                            String text,
                            java.sql.Date dtOd,
                            java.sql.Date dtDo,
                            int idSpol) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_DAT_KARTAVYJIMKY "+
                                            "(ID_KARTATYP,S_TEXT,DT_PLATNOSTOD,DT_PLATNOSTDO,ID_KTGUCETNISPOLECNOST) "+
                                            "VALUES (?,?,?,?,?)",0);
        st.setInt(1, idKartaTyp);
        st.setString(2, text);
        st.setDate(3, dtOd);
        st.setDate(4, dtDo);
        st.setInt(5, idSpol);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaVyjimky akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_KARTAVYJIMKY "+
                                            "SET ID_KARTATYP=?,S_TEXT=?,DT_PLATNOSTOD=?,DT_PLATNOSTDO=?,ID_KTGUCETNISPOLECNOST=? "+
                                            "WHERE ID=?",0);
        st.setInt(1, idKartaTyp);
        st.setString(2, text);
        st.setDate(3, dtOd);
        st.setDate(4, dtDo);
        st.setInt(5, idSpol);
        st.setInt(6, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaVyjimky akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_DAT_KARTAVYJIMKY "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaVyjimky akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KtgAppuserIExterniView1
   */
  public KtgAppuserIExterniViewImpl getKtgAppuserIExterniView1()
  {
    return (KtgAppuserIExterniViewImpl)findViewObject("KtgAppuserIExterniView1");
  }

  public boolean jeSpolecnostClenSkupiny(int idSpol,
                                         int idSkup,
                                         java.sql.Date datum) throws KisException
  {
    boolean ret = false;
    DBTransaction dbTran = getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin ? := db_jt.f_jeSpolecnostClenSkupiny(?,?,?); end;",0);
      st.registerOutParameter(1,Types.INTEGER);
      st.setInt(2,idSpol);
      st.setInt(3,idSkup);
      st.setDate(4,datum);
      st.execute();
      ret = (st.getInt(1) == 1);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ funkce db_jt.jeSpolecnostClenSkupiny",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    return ret;
  }

  /**
   * 
   * Container's getter for VwKpSubkonsprehledView1
   */
  public VwKpSubkonsprehledViewImpl getVwKpSubkonsprehledView1()
  {
    return (VwKpSubkonsprehledViewImpl)findViewObject("VwKpSubkonsprehledView1");
  }

  /**
   * 
   * Container's getter for KpDatKartaspolzpravaView1
   */
  public KpDatKartaspolzpravaViewImpl getKpDatKartaspolzpravaView1()
  {
    return (KpDatKartaspolzpravaViewImpl)findViewObject("KpDatKartaspolzpravaView1");
  }

  public void kartaZprava(int idZprava,
                          int idSpol,
                          int idKartaTyp,
                          java.sql.Date datum,
                          String zprava) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if(idZprava==0) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_DAT_KARTASPOLZPRAVA "+
                                            "(ID_KTGUCETNISPOLECNOST,ID_KARTATYP,DT_DATUM,S_ZPRAVA,S_UZIVATEL) "+
                                            "VALUES (?,?,?,?,?)",0);
        st.setInt(1, idSpol);
        st.setInt(2, idKartaTyp);
        st.setDate(3, datum);
        st.setString(4, zprava);
        st.setString(5, getUser());
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaZprava id=0",s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_DAT_KARTASPOLZPRAVA "+
                                            "SET S_ZPRAVA=?,S_UZIVATEL=?,DT_DATUMZMENY=SYSDATE "+
                                            "WHERE ID=?",0);
        st.setString(1, zprava);
        st.setString(2, getUser());
        st.setInt(3, idZprava);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volďż˝nďż˝ procedury kartaZprava id="+idZprava,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for VwRelSpolecnostKartaTypView1
   */
  public VwRelSpolecnostKartaTypViewImpl getVwRelSpolecnostKartaTypView1()
  {
    return (VwRelSpolecnostKartaTypViewImpl)findViewObject("VwRelSpolecnostKartaTypView1");
  }

  public void setKartaDatum(int idSpol,
                            int idKartaTyp,
                            java.sql.Date datum,
                            int perioda) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_REL_SPOLECNOSTKARTATYP "+
                                          "SET DT_ZPRAVADALSI=?,NL_PERIODAMESICU=? "+
                                          "WHERE ID_KTGUCETNISPOLECNOST=? AND ID_KARTATYP=?",0);
      st.setDate(1,datum);
      if(perioda>0) st.setInt(2,perioda); else st.setNull(2,Types.INTEGER);
      st.setInt(3,idSpol);
      st.setInt(4,idKartaTyp);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volďż˝nďż˝ procedury setKartaDatum idSpol="+idSpol+",idKartaTyp="+idKartaTyp,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostZamkyView1
   */
  public KpKtgUcetnispolecnostZamkyViewImpl getKpKtgUcetnispolecnostZamkyView1()
  {
    return (KpKtgUcetnispolecnostZamkyViewImpl)findViewObject("KpKtgUcetnispolecnostZamkyView1");
  }

  /**
   * 
   * Container's getter for KpCisFeisPrenosView1
   */
  public KpCisFeisPrenosViewImpl getKpCisFeisPrenosView1()
  {
    return (KpCisFeisPrenosViewImpl)findViewObject("KpCisFeisPrenosView1");
  }


}