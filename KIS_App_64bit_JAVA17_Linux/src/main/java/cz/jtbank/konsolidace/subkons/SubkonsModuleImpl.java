package cz.jtbank.konsolidace.subkons;
import cz.jtbank.konsolidace.common.*;
import java.sql.*;
import java.io.*;
import cz.jtbank.konsolidace.excel.*;
import oracle.jbo.server.ApplicationModuleImpl;
import cz.jtbank.konsolidace.common.KisException;
import oracle.jbo.server.DBTransaction;
import java.sql.SQLException;
import cz.jtbank.konsolidace.ucskup.KpKtgUcetniskupinaViewImpl;
import cz.jtbank.konsolidace.doklady.KpKtgUcetnispolecnostViewImpl;
import cz.jtbank.konsolidace.fininv.KpCisMenaViewImpl;
import cz.jtbank.konsolidace.ifrs.KpCisIfrstyppravidloViewImpl;
import cz.jtbank.konsolidace.ifrs.KpCisIfrstyppravidlodetailViewImpl;
import cz.jtbank.konsolidace.ucskup.VwRelUcetniskupinaclenViewImpl;
import cz.jtbank.konsolidace.users.KtgAppuserViewImpl;
import oracle.jbo.ViewObject;
import oracle.jbo.Row;
import oracle.jbo.domain.Number;

//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---------------------------------------------------------------

public class SubkonsModuleImpl extends ApplicationModuleImpl implements cz.jtbank.konsolidace.subkons.common.SubkonsModule 
{
  /**
   * 
   * This is the default constructor (do not remove)
   */
  public SubkonsModuleImpl()
  {
  }

  /**
   * 
   * Container's getter for VwKpSubkonsolidaceView1
   */
  public VwKpSubkonsolidaceViewImpl getVwKpSubkonsolidaceView1()
  {
    return (VwKpSubkonsolidaceViewImpl)findViewObject("VwKpSubkonsolidaceView1");
  }

  /**
   * 
   * Container's getter for KpRelSubkonsolidaceclenView1
   */
  public KpRelSubkonsolidaceclenViewImpl getKpRelSubkonsolidaceclenView1()
  {
    return (KpRelSubkonsolidaceclenViewImpl)findViewObject("KpRelSubkonsolidaceclenView1");
  }

  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
  public static void main(String[] args) throws Exception
  {
    //launchTester("cz.jtbank.konsolidace.subkons", "SubkonsModuleLocal");
    SubkonsModuleImpl dm = (SubkonsModuleImpl) oracle.jbo.client.Configuration.createRootApplicationModule("cz.jtbank.konsolidace.subkons.SubkonsModule","SubkonsModuleLocal");
    String text = dm.calculateSyntaxText(3657, "-1*(-SubPravidlo(2016)-100*AktMenaKurzNBS('SKK','GBP')/AktMenaKurzNBS('SKK','EUR'))");
    System.out.println(text);
  }

  private String getUser() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, false);
    return user;
  }
  
  public int subKonsolidace(String akce,
                           int idSpol,
                           int idSkup,
                           int poradi,
                           String mena,
                           String nazev,
                           java.sql.Date datumOd,
                           java.sql.Date datumDo,
                           String kursListek,
                           String listKR,
                           java.sql.Date datumArch,
                           int krokClenu,
                           String expFlag) throws KisException
  {
    int ret = 0;
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KpSubKonsolidace(?,?,?,?,?,?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idSpol);
      st.setInt(3, idSkup);
      st.setInt(4, poradi);
      st.setString(5, mena);
      st.setString(6, nazev);
      st.setDate(7, datumOd);
      st.setDate(8, datumDo);
      if(kursListek!=null && kursListek.length()>0) 
        st.setString(9, kursListek);
      else
        st.setNull(9, Types.VARCHAR);
      st.setString(10, listKR);
      st.setString(11, userName);
      st.setDate(12, datumArch);
      st.setInt(13, krokClenu);
      st.setString(14, expFlag);
      st.registerOutParameter(2, Types.INTEGER);
      st.execute();
      ret = st.getInt(2);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KpSubKonsolidace",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    return ret;
  }

  public void subKonsolidaceClen(String akce,
                                 int idSubkons,
                                 int idSpol,
                                 int idClenstvi,
                                 double pomer,
                                 java.sql.Date datumOd,
                                 java.sql.Date datumDo,
                                 java.sql.Date vazbyOd,
                                 java.sql.Date vazbyDo,
                                 String clen,
                                 String propisuj,
                                 java.sql.Date odOrig,
                                 int prestup) throws KisException
  {
    String userName = getUser();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KPRelSubKonsolidaceClen(?,?,?,?,?,?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idSubkons);
      st.setInt(3, idSpol);
      st.setInt(4, idClenstvi);
      st.setDouble(5, pomer);
      st.setString(6, clen);
      st.setDate(7, datumOd);
      st.setDate(8, datumDo);
      st.setDate(9, vazbyOd);
      st.setDate(10, vazbyDo);
      st.setString(11, propisuj);
      st.setString(12, userName);
      st.setDate(13, odOrig);
      st.setInt(14, prestup);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KPRelSubKonsolidaceClen",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void subKonsolidaceMatka(int idSubkons,
                                  int idSpol) throws KisException
  {
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KpSubKonsolidaceSetMatka(?,?,?); end;",0);
      st.setInt(1, idSubkons);
      if(idSpol>0) st.setInt(2, idSpol); else st.setNull(2,Types.INTEGER);
      st.setString(3, userName);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KpSubKonsolidaceSetMatka",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { }
    }
  }

  /**
   * 
   * Container's getter for KpKtgUcetniskupinaView1
   */
  public KpKtgUcetniskupinaViewImpl getKpKtgUcetniskupinaView1()
  {
    return (KpKtgUcetniskupinaViewImpl)findViewObject("KpKtgUcetniskupinaView1");
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostView1
   */
  public KpKtgUcetnispolecnostViewImpl getKpKtgUcetnispolecnostView1()
  {
    return (KpKtgUcetnispolecnostViewImpl)findViewObject("KpKtgUcetnispolecnostView1");
  }

  /**
   * 
   * Container's getter for KpCisMenaView1
   */
  public KpCisMenaViewImpl getKpCisMenaView1()
  {
    return (KpCisMenaViewImpl)findViewObject("KpCisMenaView1");
  }

  /**
   * 
   * Container's getter for KpKtgSubkonsolidacepravidloView1
   */
  public KpKtgSubkonsolidacepravidloViewImpl getKpKtgSubkonsolidacepravidloView1()
  {
    return (KpKtgSubkonsolidacepravidloViewImpl)findViewObject("KpKtgSubkonsolidacepravidloView1");
  }

  /**
   * 
   * Container's getter for KpKtgSubkonsolpravidlodetailView1
   */
  public KpKtgSubkonsolpravidlodetailViewImpl getKpKtgSubkonsolpravidlodetailView1()
  {
    return (KpKtgSubkonsolpravidlodetailViewImpl)findViewObject("KpKtgSubkonsolpravidlodetailView1");
  }

  /**
   * 
   * Container's getter for KpKtgSubkonsolidaceetapaView1
   */
  public KpKtgSubkonsolidaceetapaViewImpl getKpKtgSubkonsolidaceetapaView1()
  {
    return (KpKtgSubkonsolidaceetapaViewImpl)findViewObject("KpKtgSubkonsolidaceetapaView1");
  }

  /**
   * 
   * Container's getter for KpCisIfrstyppravidloView1
   */
  public KpCisIfrstyppravidloViewImpl getKpCisIfrstyppravidloView1()
  {
    return (KpCisIfrstyppravidloViewImpl)findViewObject("KpCisIfrstyppravidloView1");
  }

  /**
   * 
   * Container's getter for KpCisIfrstyppravidlodetailView1
   */
  public KpCisIfrstyppravidlodetailViewImpl getKpCisIfrstyppravidlodetailView1()
  {
    return (KpCisIfrstyppravidlodetailViewImpl)findViewObject("KpCisIfrstyppravidlodetailView1");
  }
  
  public void subkonsPravidlo(String akce,
                           int id,
                           int idPoradi,
                           int typ,
                           int idSub,
                           int idSpol,
                           int idEtapa,
                           java.sql.Date platnostOd,
                           java.sql.Date platnostDo,
                           String poznamka,
                           int validaceRadek,
                           int validaceList,
                           double validaceHodnota) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KPSubKonsolidacePravidlo(?,?,?,?,?,?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, id);
      st.setInt(3, idPoradi);
      st.setInt(4, typ);
      st.setInt(5, idSub);
      st.setInt(6, idSpol);
      st.setInt(7, idEtapa);
      st.setDate(8, platnostOd);
      st.setDate(9, platnostDo);
      st.setString(10, poznamka);
      if(validaceRadek>0) 
        st.setInt(11, validaceRadek);
      else 
        st.setNull(11, Types.INTEGER);
      st.setInt(12, validaceList);
      st.setDouble(13, validaceHodnota);
      st.setString(14, getUser());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KPSubKonsolidacePravidlo",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  
  public void subkonsPravidloDetail(String akce,
                                 int id,
                                 int idPrav,
                                 int idPoradi,
                                 int idPoradiPodminka,
                                 int typ,
                                 String poznamka,
                                 int radek,
                                 int list,
                                 double castka,
                                 String vzorec,
                                 String ucetZbytek,
                                 String podminka,
                                 int refSpol,
                                 int refSub,
                                 int idProtistrana) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KPSubKonPravidloDetail(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, id);
      st.setInt(3, idPrav);
      st.setInt(4, idPoradi);
      st.setInt(5, idPoradiPodminka);
      st.setInt(6, typ);
      st.setString(7, poznamka);
      st.setInt(8, radek);
      st.setInt(9, list);
      if(vzorec==null || vzorec.length()==0) {
        st.setDouble(10, castka);
        st.setNull(11, Types.VARCHAR);
      }
      else 
      {
        st.setNull(10, Types.DOUBLE);
        st.setString(11, vzorec);
      }
      st.setString(12, ucetZbytek==null?null:ucetZbytek.trim());
      st.setString(13, podminka);
      if(refSpol>0) 
        st.setInt(14, refSpol);
      else
        st.setNull(14, Types.INTEGER);
      if(refSub>0) 
        st.setInt(15, refSub);
      else
        st.setNull(15, Types.INTEGER);
      st.setString(16, getUser());
      if(idProtistrana>0) 
        st.setInt(17, idProtistrana);
      else
        st.setNull(17, Types.INTEGER);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KPSubKonPravidloDetail",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void addEtapa(int idSubkons,
                       int poradi,
                       String nazev,
                       String zkratka) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    try {
      st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_KTG_SUBKONSOLIDACEETAPA (ID_KTGSUBKONSOLIDACE,NL_PORADI,S_POPIS,S_ZKRATKA)"+
                 " VALUES (?,?,?,?)",0);
      st.setInt(1, idSubkons);
      st.setInt(2, poradi);
      st.setString(3, nazev);
      st.setString(4, zkratka);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo INSERT INTO DB_JT.KP_KTG_SUBKONSOLIDACEETAPA",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  public void modEtapa(int idEtapa,
                       String nazev) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_KTG_SUBKONSOLIDACEETAPA SET S_POPIS=? WHERE ID=?",0);
      st.setString(1, nazev);
      st.setInt(2, idEtapa);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo UPDATE DB_JT.KP_KTG_SUBKONSOLIDACEETAPA",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  public void delEtapa(int idEtapa) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    try {
      st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_KTG_SUBKONSOLIDACEETAPA WHERE ID=?",0);
      st.setInt(1, idEtapa);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo DELETE FROM DB_JT.KP_KTG_SUBKONSOLIDACEETAPA",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for VwRelUcetniskupinaclenView1
   */
  public VwRelUcetniskupinaclenViewImpl getVwRelUcetniskupinaclenView1()
  {
    return (VwRelUcetniskupinaclenViewImpl)findViewObject("VwRelUcetniskupinaclenView1");
  }

  public String calculateSyntaxText(int idPrav,
                                  String vzorec) throws KisException
  {
    String ret = "";
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
System.out.println("begin ? := db_jt.f_calculateSyntaxTest(?,?); end;");    
      st = dbTran.createCallableStatement("begin ? := db_jt.f_calculateSyntaxTest(?,?); end;",0);
      st.registerOutParameter(1,Types.VARCHAR);
System.out.println("vzorec="+vzorec);      
      st.setString(2, vzorec);
System.out.println("idPrav="+idPrav);
      st.setInt(3, idPrav);
      st.execute();
      ret = st.getString(1);
System.out.println("ret="+ret);      
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.f_calculateSyntaxTest",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    return ret;
  }

  public void exportExcel(java.sql.Date datum) throws KisException 
  {
    ESExportKonsPravidla ei = new ESExportKonsPravidla(this, datum);
    try {
      ei.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }
  
  protected FileFilter getFileFilter(final String name) 
  {
    return new FileFilter() {
      public boolean accept(File pathname) 
      {
        return true;
      }
    };
  }
  
  java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);

  public String getExcels() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_KONSOLIDACNI_ZMENY;
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_KONSOLIDACNI_ZMENY+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public void exportExcelKons(java.sql.Date datum) throws KisException 
  {
    ESExportSubkonsolidace ei = new ESExportSubkonsolidace(this, datum);
    try {
      ei.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }
  
  public String getExcelsKons() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_SUBKONSOLIDACE;
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_SUBKONSOLIDACE+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public void exportExcelSpravce(java.sql.Date datum) throws KisException 
  {
    ESExportSubkonsSpravce ei = new ESExportSubkonsSpravce(this, datum);
    try {
      ei.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }
  
  public String getExcelsSpravce() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_KONS_SPRAVCE;
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_KONS_SPRAVCE+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  /**
   * 
   * Container's getter for KpCisSubtypclenstviView1
   */
  public KpCisSubtypclenstviViewImpl getKpCisSubtypclenstviView1()
  {
    return (KpCisSubtypclenstviViewImpl)findViewObject("KpCisSubtypclenstviView1");
  }

  /**
   * 
   * Container's getter for KpRelSubkonsolidaceclenSpecial1
   */
  public KpRelSubkonsolidaceclenSpecialImpl getKpRelSubkonsolidaceclenSpecial1()
  {
    return (KpRelSubkonsolidaceclenSpecialImpl)findViewObject("KpRelSubkonsolidaceclenSpecial1");
  }

  /**
   * 
   * Container's getter for KpDatDokladvazbySpecialView1
   */
  public KpDatDokladvazbySpecialViewImpl getKpDatDokladvazbySpecialView1()
  {
    return (KpDatDokladvazbySpecialViewImpl)findViewObject("KpDatDokladvazbySpecialView1");
  }

  /**
   * 
   * Container's getter for KpLogSubkonsolidaceView1
   */
  public KpLogSubkonsolidaceViewImpl getKpLogSubkonsolidaceView1()
  {
    return (KpLogSubkonsolidaceViewImpl)findViewObject("KpLogSubkonsolidaceView1");
  }

  /**
   * 
   * Container's getter for KpLogSubkonsolidaceclenView1
   */
  public KpLogSubkonsolidaceclenViewImpl getKpLogSubkonsolidaceclenView1()
  {
    return (KpLogSubkonsolidaceclenViewImpl)findViewObject("KpLogSubkonsolidaceclenView1");
  }

  /**
   * 
   * Container's getter for VwKpUcspolskupinaporovnaniView1
   */
  public VwKpUcspolskupinaporovnaniViewImpl getVwKpUcspolskupinaporovnaniView1()
  {
    return (VwKpUcspolskupinaporovnaniViewImpl)findViewObject("VwKpUcspolskupinaporovnaniView1");
  }

  /**
   * 
   * Container's getter for VwKpUcspolskupinadataView1
   */
  public VwKpUcspolskupinadataViewImpl getVwKpUcspolskupinadataView1()
  {
    return (VwKpUcspolskupinadataViewImpl)findViewObject("VwKpUcspolskupinadataView1");
  }

  /**
   * 
   * Container's getter for KpTmpSubvazbyvyjimkyView1
   */
  public KpTmpSubvazbyvyjimkyViewImpl getKpTmpSubvazbyvyjimkyView1()
  {
    return (KpTmpSubvazbyvyjimkyViewImpl)findViewObject("KpTmpSubvazbyvyjimkyView1");
  }

  public void subVazbyVyjimky(String akce,
                     int oSub,
                     java.sql.Date oDatum,
                     int oSpol1,
                     int oSpol2,
                     int sub,
                     java.sql.Date datum,
                     int spol1,
                     int spol2) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_tmp_SubVazbyVyjimky "+
                                            "(ID_KTGSUBKONSOLIDACE,DT_DATUM,ID_KTGUCETNISPOLECNOST_1,ID_KTGUCETNISPOLECNOST_2) "+
                                            "VALUES (?,?,?,?)",0);
        st.setInt(1,sub);
        st.setDate(2, datum);
        st.setInt(3,spol1);
        st.setInt(4,spol2);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury subVazbyVyjimky akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_tmp_SubVazbyVyjimky "+
                                            "SET ID_KTGSUBKONSOLIDACE=?, DT_DATUM=?, ID_KTGUCETNISPOLECNOST_1=?, ID_KTGUCETNISPOLECNOST_2=? "+
                                            "WHERE ID_KTGSUBKONSOLIDACE=? AND DT_DATUM=? AND ID_KTGUCETNISPOLECNOST_1=? AND ID_KTGUCETNISPOLECNOST_2=?",0);
        st.setInt(1,sub);
        st.setDate(2, datum);
        st.setInt(3,spol1);
        st.setInt(4,spol2);
        st.setInt(5,oSub);
        st.setDate(6, oDatum);
        st.setInt(7,oSpol1);
        st.setInt(8,oSpol2);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury subVazbyVyjimky akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_tmp_SubVazbyVyjimky "+
                                            "WHERE ID_KTGSUBKONSOLIDACE=? AND DT_DATUM=? AND ID_KTGUCETNISPOLECNOST_1=? AND ID_KTGUCETNISPOLECNOST_2=?",0);
        st.setInt(1,oSub);
        st.setDate(2, oDatum);
        st.setInt(3,oSpol1);
        st.setInt(4,oSpol2);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury subVazbyVyjimky akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }


  public void setSubkonsOO(int idSpol,
                           int idOO,
                           int idTop) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_KTG_UCETNISPOLECNOST "+
                                          "SET ID_ODPOVEDNAOSOBA=?, ID_TOPMNG=? "+
                                          "WHERE ID=?",0);
      if(idOO>0) st.setInt(1,idOO); else st.setNull(1,Types.INTEGER);
      if(idTop>0) st.setInt(2,idTop); else st.setNull(2,Types.INTEGER);
      st.setInt(3,idSpol);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury setSubkonsOO idSpol="+idSpol,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KtgAppuserView1
   */
  public KtgAppuserViewImpl getKtgAppuserView1()
  {
    return (KtgAppuserViewImpl)findViewObject("KtgAppuserView1");
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostView2
   */
  public KpKtgUcetnispolecnostViewImpl getKpKtgUcetnispolecnostView2()
  {
    return (KpKtgUcetnispolecnostViewImpl)findViewObject("KpKtgUcetnispolecnostView2");
  }
/* UZ JE V DOKLADY-MODULE
  public void subKonsDokladDelete(int idSubkons,
                                  java.sql.Date datum) throws KisException
  {
    String userName = getUser();
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_subkon.p_deleteSubKonsolidaceDoklad(?,?,?); end;",0);
      st.setInt(1, idSubkons);
      st.setDate(2, datum);
      st.setString(3, userName);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_subkon.p_deleteSubKonsolidaceDoklad",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { }
    }
  }
*/  

  public void typSubPravidla(int idCis,
                             int idSub,
                             int idSpol,
                             java.sql.Date datum) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_typSubPravidla(?,?,?,?,?); end;",0);
      st.setInt(1, idCis);
      st.setInt(2, idSub);
      st.setInt(3, idSpol);
      st.setDate(4, datum);
      st.setString(5, getUser());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_typSubPravidla",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void typSubkonsPravidlo(String akce,
                           int id,
                           int idPoradi,
                           int typ,
                           int idEtapa,
                           String poznamka,
                           int idDatumTyp) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KPTypSubPravidlo(?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, id);
      st.setInt(3, idPoradi);
      st.setInt(4, typ);
      st.setInt(5, idEtapa);
      st.setString(6, poznamka);
      st.setInt(7, idDatumTyp);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KPTypSubPravidlo",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  
  public void typSubkonsPravidloDetail(String akce,
                                 int id,
                                 int idPrav,
                                 int idPoradi,
                                 int idPoradiPodminka,
                                 int typ,
                                 String poznamka,
                                 int radek,
                                 int list,
                                 String vzorec,
                                 String ucetZbytek,
                                 String podminka,
                                 int idProtistrana,
                                 String nulove,
                                 String matka) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KPTypSubPravidloDetail(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, id);
      st.setInt(3, idPrav);
      st.setInt(4, idPoradi);
      st.setInt(5, idPoradiPodminka);
      st.setInt(6, typ);
      st.setString(7, poznamka);
      st.setInt(8, radek);
      st.setInt(9, list);
      if(vzorec==null || vzorec.length()==0) {
        st.setNull(10, Types.VARCHAR);
      }
      else 
      {
        st.setString(10, vzorec);
      }
      st.setString(11, ucetZbytek==null?null:ucetZbytek.trim());
      st.setString(12, podminka);
      if(idProtistrana>0) 
        st.setInt(13, idProtistrana);
      else
        st.setNull(13, Types.INTEGER);
      st.setString(14, nulove);
      st.setString(15, matka);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KPTypSubPravidloDetail",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpCisTypsubetapaView1
   */
  public KpCisTypsubetapaViewImpl getKpCisTypsubetapaView1()
  {
    return (KpCisTypsubetapaViewImpl)findViewObject("KpCisTypsubetapaView1");
  }

  /**
   * 
   * Container's getter for KpKtgTypsubetapaView1
   */
  public KpKtgTypsubetapaViewImpl getKpKtgTypsubetapaView1()
  {
    return (KpKtgTypsubetapaViewImpl)findViewObject("KpKtgTypsubetapaView1");
  }

  /**
   * 
   * Container's getter for KpKtgTypsubpravidloView1
   */
  public KpKtgTypsubpravidloViewImpl getKpKtgTypsubpravidloView1()
  {
    return (KpKtgTypsubpravidloViewImpl)findViewObject("KpKtgTypsubpravidloView1");
  }

  /**
   * 
   * Container's getter for KpKtgTypsubpravidlodetailView1
   */
  public KpKtgTypsubpravidlodetailViewImpl getKpKtgTypsubpravidlodetailView1()
  {
    return (KpKtgTypsubpravidlodetailViewImpl)findViewObject("KpKtgTypsubpravidlodetailView1");
  }

  public void addTypEtapa(int idCisEtapa,
                       int poradi,
                       String nazev,
                       String zkratka) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    try {
      st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_KTG_TYPSUBETAPA (ID_CISTYPETAPA,NL_PORADI,S_POPIS,S_ZKRATKA)"+
                 " VALUES (?,?,?,?)",0);
      st.setInt(1, idCisEtapa);
      st.setInt(2, poradi);
      st.setString(3, nazev);
      st.setString(4, zkratka);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo INSERT INTO DB_JT.KP_KTG_TYPSUBETAPA",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  public void modTypEtapa(int idEtapa,
                       String nazev) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_KTG_TYPSUBETAPA SET S_POPIS=? WHERE ID=?",0);
      st.setString(1, nazev);
      st.setInt(2, idEtapa);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo UPDATE DB_JT.KP_KTG_TYPSUBETAPA",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  public void delTypEtapa(int idEtapa) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    try {
      st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_KTG_TYPSUBETAPA WHERE ID=?",0);
      st.setInt(1, idEtapa);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo DELETE FROM DB_JT.KP_KTG_TYPSUBETAPA",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpRelSubkonsolidaceclenRpView1
   */
  public KpRelSubkonsolidaceclenRpViewImpl getKpRelSubkonsolidaceclenRpView1()
  {
    return (KpRelSubkonsolidaceclenRpViewImpl)findViewObject("KpRelSubkonsolidaceclenRpView1");
  }

  public void subClenRp(String akce,
                        int idSub,
                        int idSpol,
                        String kdyPouzit,
                        String aktPas,
                        String vysl,
                        String vazby,
                        String doklad) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_REL_SUBKONSOLIDACECLEN_RP "+
                                            "(ID_KTGSUBKONSOLIDACE,ID_KTGUCETNISPOLECNOST,C_KDYPOUZIT,C_AKTIVAPASIVA,C_VYSLEDOVKA,C_DOKLADVAZBY,C_DOKLAD,S_UZIVATEL) "+
                                            "VALUES (?,?,?,?,?,?,?,?)",0);
        st.setInt(1, idSub);
        st.setInt(2, idSpol);
        st.setString(3, kdyPouzit);
        st.setString(4, aktPas);
        st.setString(5, vysl);
        st.setString(6, vazby);
        st.setString(7, doklad);
        st.setString(8, getUser());
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury subClenRp akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_REL_SUBKONSOLIDACECLEN_RP "+
                                            "SET C_AKTIVAPASIVA=?,C_VYSLEDOVKA=?,C_DOKLADVAZBY=?,C_DOKLAD=?,S_UZIVATEL=?,DT_DATUMZMENY=SYSDATE "+
                                            "WHERE ID_KTGSUBKONSOLIDACE=? AND ID_KTGUCETNISPOLECNOST=? AND C_KDYPOUZIT=?",0);
        st.setString(1, aktPas);
        st.setString(2, vysl);
        st.setString(3, vazby);
        st.setString(4, doklad);
        st.setString(5, getUser());
        st.setInt(6, idSub);
        st.setInt(7, idSpol);
        st.setString(8, kdyPouzit);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury subClenRp akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_REL_SUBKONSOLIDACECLEN_RP "+
                                            "SET S_UZIVATEL=?,DT_DATUMZMENY=SYSDATE "+
                                            "WHERE ID_KTGSUBKONSOLIDACE=? AND ID_KTGUCETNISPOLECNOST=? AND C_KDYPOUZIT=?",0);
        st.setString(1, getUser());
        st.setInt(2, idSub);
        st.setInt(3, idSpol);
        st.setString(4, kdyPouzit);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury subClenRp akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }

      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_REL_SUBKONSOLIDACECLEN_RP "+
                                            "WHERE ID_KTGSUBKONSOLIDACE=? AND ID_KTGUCETNISPOLECNOST=? AND C_KDYPOUZIT=?",0);
        st.setInt(1, idSub);
        st.setInt(2, idSpol);
        st.setString(3, kdyPouzit);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury subClenRp akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpDatSpolecnostlistView1
   */
  public KpDatSpolecnostlistViewImpl getKpDatSpolecnostlistView1()
  {
    return (KpDatSpolecnostlistViewImpl)findViewObject("KpDatSpolecnostlistView1");
  }

  /**
   * 
   * Container's getter for KpDatSpolecnostlistdetailView1
   */
  public KpDatSpolecnostlistdetailViewImpl getKpDatSpolecnostlistdetailView1()
  {
    return (KpDatSpolecnostlistdetailViewImpl)findViewObject("KpDatSpolecnostlistdetailView1");
  }

  public int currentUsersId() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    Number userId = null;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("S_USERID = '"+user+"'");
    if(voUser.hasNext()) 
    {
      Row rowUser = voUser.next();
      userId = (Number) rowUser.getAttribute("Id");
    }
    voUser.closeRowSet();
    if(userId == null) return -1;
    
    return userId.intValue();
  }

  public void spolecnostList(String akce,
                             int id,
                             String nazev,
                             String sdilene) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    
    int userId = currentUsersId();

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.kp_dat_spolecnostList "+
                                            "(ID_APPUSER,S_NAZEV,C_SDILENE) "+
                                            "VALUES (?,?,?)",0);
        st.setInt(1,userId);
        st.setString(2,nazev);
        st.setString(3,sdilene);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolecnostList akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.kp_dat_spolecnostList "+
                                            "SET ID_APPUSER=?,S_NAZEV=?,C_SDILENE=? "+
                                            "WHERE ID=?",0);
        st.setInt(1,userId);
        st.setString(2,nazev);
        st.setString(3,sdilene);
        st.setInt(4,id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolecnostList akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.kp_dat_spolecnostList "+
                                            "WHERE ID=?",0);
        st.setInt(1,id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolecnostList akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  public void spolecnostListDetail(String akce,
                                   int id,
                                   int idList,
                                   int idSpol,
                                   java.sql.Date dtOd,
                                   java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;
    
    int userId = currentUsersId();

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.kp_dat_spolecnostListDetail "+
                                            "(ID_SPOLECNOSTLIST,ID_KTGSPOLECNOST,DT_PLATNOSTOD,DT_PLATNOSTDO) "+
                                            "VALUES (?,?,?,?)",0);
        st.setInt(1,idList);
        st.setInt(2,idSpol);
        st.setDate(3, dtOd);
        st.setDate(4, dtDo);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolecnostListDetail akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.kp_dat_spolecnostListDetail "+
                                            "SET ID_SPOLECNOSTLIST=?,ID_KTGSPOLECNOST=? ,DT_PLATNOSTOD=?, DT_PLATNOSTDO=? "+
                                            "WHERE ID=?",0);
        st.setInt(1,idList);
        st.setInt(2,idSpol);
        st.setDate(3, dtOd);
        st.setDate(4, dtDo);
        st.setInt(5,id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolecnostListDetail akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.kp_dat_spolecnostListDetail "+
                                            "WHERE ID=?",0);
        st.setInt(1,id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolecnostListDetail akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for VwRelUcetniSpolecnostSkupinaView1
   */
  public VwRelUcetniSpolecnostSkupinaViewImpl getVwRelUcetniSpolecnostSkupinaView1()
  {
    return (VwRelUcetniSpolecnostSkupinaViewImpl)findViewObject("VwRelUcetniSpolecnostSkupinaView1");
  }

  /**
   * 
   * Container's getter for VwKpUcspolspravcekonsolidaceView1
   */
  public VwKpUcspolspravcekonsolidaceViewImpl getVwKpUcspolspravcekonsolidaceView1()
  {
    return (VwKpUcspolspravcekonsolidaceViewImpl)findViewObject("VwKpUcspolspravcekonsolidaceView1");
  }


}