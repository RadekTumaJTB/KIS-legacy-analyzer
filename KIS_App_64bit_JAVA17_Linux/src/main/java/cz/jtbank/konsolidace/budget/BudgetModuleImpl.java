package cz.jtbank.konsolidace.budget;
import oracle.jbo.server.ApplicationModuleImpl;
import cz.jtbank.konsolidace.dokument.KpCisTyptransakceViewImpl;
import oracle.jbo.server.DBTransaction;
import java.sql.*;
import cz.jtbank.konsolidace.common.KisException;
import cz.jtbank.konsolidace.dokument.KpKtgOdborViewImpl;
import oracle.jbo.ViewObject;
import oracle.jbo.Row;
import oracle.jbo.domain.Number;
import cz.jtbank.konsolidace.users.KtgAppuserViewImpl;
import cz.jtbank.konsolidace.fininv.KpCisMenaViewImpl;
import cz.jtbank.konsolidace.dokument.VwKtgOdborViewImpl;
import cz.jtbank.konsolidace.excel.*;
import cz.jtbank.konsolidace.common.Constants;
import java.io.*;
import java.util.*;
import cz.jtbank.konsolidace.mail.Mail;
import cz.jtbank.konsolidace.doklady.KpEmailParamViewImpl;
import cz.jtbank.konsolidace.dokument.KpCisTyptransakceEditViewImpl;
import cz.jtbank.konsolidace.projekt.VwKtgProjektViewImpl;
import cz.jtbank.konsolidace.dokument.KpCisTypTranCapexOpexViewImpl;
//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---------------------------------------------------------------

public class BudgetModuleImpl extends ApplicationModuleImpl implements cz.jtbank.konsolidace.budget.common.BudgetModule  
{
  /**
   * 
   * This is the default constructor (do not remove)
   */
  public BudgetModuleImpl()
  {
  }

  /**
   * 
   * Container's getter for KpDefBudgetmustekView1
   */
  public KpDefBudgetmustekViewImpl getKpDefBudgetmustekView1()
  {
    return (KpDefBudgetmustekViewImpl)findViewObject("KpDefBudgetmustekView1");
  }

  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
  public static void main(String[] args)
  {
    //launchTester("cz.jtbank.konsolidace.budget", "BudgetModuleLocal");
    BudgetModuleImpl dm = (BudgetModuleImpl) oracle.jbo.client.Configuration.createRootApplicationModule("cz.jtbank.konsolidace.budget.BudgetModule","BudgetModuleLocal");
    try {
      dm.eskaling(3,3);
    }
    catch(Exception e) 
    {
      e.printStackTrace();
    }
  }

  /**
   * 
   * Container's getter for KpCisTyptransakceView1
   */
  public KpCisTyptransakceViewImpl getKpCisTyptransakceView1()
  {
    return (KpCisTyptransakceViewImpl)findViewObject("KpCisTyptransakceView1");
  }

  /**
   * 
   * Container's getter for KpCisSubject1
   */
  public KpCisSubjectImpl getKpCisSubject1()
  {
    return (KpCisSubjectImpl)findViewObject("KpCisSubject1");
  }
  
  private String getUser() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, false);
    return user;
  }

  public int currentUsersId() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    Number userId = null;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("S_USERID = '"+user+"'");
    if(voUser.hasNext()) 
    {
      Row rowUser = voUser.next();
      userId = (Number) rowUser.getAttribute("Id");
    }
    voUser.closeRowSet();
    if(userId == null) return -1;
    
    return userId.intValue();
  }

  public void defBudgetMustek(String akce,
                              int id, 
                              int idSubject,
                              int idTypTran,
                              String ucet,
                              java.sql.Date dtOd,
                              java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_KpDefBudgetMustek(?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, id);
      st.setInt(3, idSubject);
      st.setInt(4, idTypTran);
      st.setString(5, ucet==null?null:ucet.trim());
      st.setString(6, getUser());
      st.setDate(7, dtOd);
      st.setDate(8, dtDo);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_KpDefBudgetMustek",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }


  /**
   * 
   * Container's getter for VwDatBudgetpolozkaView1
   */
  public VwDatBudgetpolozkaViewImpl getVwDatBudgetpolozkaView1()
  {
    return (VwDatBudgetpolozkaViewImpl)findViewObject("VwDatBudgetpolozkaView1");
  }


  /**
   * 
   * Container's getter for KpKtgOdborView1
   */
  public KpKtgOdborViewImpl getKpKtgOdborView1()
  {
    return (KpKtgOdborViewImpl)findViewObject("KpKtgOdborView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetView1
   */
  public VwDatBudgetViewImpl getVwDatBudgetView1()
  {
    return (VwDatBudgetViewImpl)findViewObject("VwDatBudgetView1");
  }

  public void updateBudgetPolozka(int idPolozka, 
                                  int idBudget,
                                  int idTypTran,
                                  double castka,
                                  String mena,
                                  String poznamka) throws KisException
  {
    int userId = currentUsersId();
    
    double origCastka = 0.0;
    Number[] oos = new Number[4];
    String budget=null, typTran=null;
    ViewObject vo = getVwDatBudgetpolozkaView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idPolozka);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      Number hlpNum = (Number) row.getAttribute("NdCastka");
      if(hlpNum!=null) origCastka = hlpNum.doubleValue();
      oos[0] = (Number) row.getAttribute("IdOdboroo");
      oos[1] = (Number) row.getAttribute("IdGestor");
      oos[2] = (Number) row.getAttribute("IdUcspoloo");
      oos[3] = (Number) row.getAttribute("IdUcspoltop");
      budget = (String) row.getAttribute("Budget"); 
      typTran = (String) row.getAttribute("Typtran"); 
    }
    vo.closeRowSet();
  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_updateBudgetPolozka(?,?,?,?,?,?,?); end;",0);
      st.setInt(1, idPolozka);
      st.setInt(2, idBudget);
      st.setInt(3, idTypTran);
      st.setDouble(4, castka);
      st.setString(5, mena);
      st.setString(6, poznamka);
      st.setInt(7, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_updateBudgetPolozka",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    if(castka!=origCastka) 
    {
      String userName = getUserName(userId);
    
      int i;
      for(i=0; i<oos.length; i++) 
        if(oos[i]!=null && jsemNeboZastupuji(oos[i].intValue())) break;
      for(++i; i<oos.length; i++) 
        oos[i] = null;
      Mail mail = new Mail();
      mail.sendBudgetZmenaCastky(this,origCastka,castka,mena,oos,budget,typTran,userName);
    }
  }
  
  private String getUserName(int userId) 
  {
    String ret = "";
    ViewObject vo = getKtgAppuserView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+userId);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      String kj = (String) row.getAttribute("SKrestni");
      String pj = (String) row.getAttribute("SPrijmeni");
      ret += (kj==null?"":kj+" ");
      ret += (pj==null?"":pj);
    }
    vo.closeRowSet();
    return ret;
  }

  public void schvaleno(String akce,
                        int idPolozka, 
                        int typOO) throws KisException
  {
    int userId = currentUsersId();
  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_schvaleno(?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idPolozka);
      st.setInt(3, typOO);
      st.setInt(4, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_schvaleno",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void schvalenoVse(String akce,
                           int idBud, 
                           int typOO) throws KisException
  {
    int userId = currentUsersId();
  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_schvalenoVse(?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idBud);
      st.setInt(3, typOO);
      st.setInt(4, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_schvalenoVse",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void schvalenoVseTopAdmin(String akce,
                                   int idBud) throws KisException
  {
    int userId = currentUsersId();
  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_schvalenoVseTopAdmin(?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idBud);
      st.setInt(3, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_schvalenoVseTopAdmin",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void schvalenoVseGestor(String akce,
                                 int idTran) throws KisException
  {
    int userId = currentUsersId();
  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_schvalenoVseGestor(?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idTran);
      st.setInt(3, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_schvalenoVseGestor",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void vytvoritBudgety(java.sql.Date dtOd,
                              java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_vytvoritBudgety(?,?); end;",0);
      st.setDate(1, dtOd);
      st.setDate(2, dtDo);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_vytvoritBudgety",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void vytvoritBudget(int idOdbor, 
                             java.sql.Date dtOd,
                             java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_vytvoritBudget(?,?,?); end;",0);
      st.setInt(1, idOdbor);
      st.setDate(2, dtOd);
      st.setDate(3, dtDo);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_vytvoritBudget",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void vytvoritBudgetyProjekt(java.sql.Date dtOd,
                              java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_vytvoritBudgetyProjekt(?,?); end;",0);
      st.setDate(1, dtOd);
      st.setDate(2, dtDo);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_vytvoritBudgetyProjekt",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void vytvoritBudgetProjekt(int idProjekt, 
                             java.sql.Date dtOd,
                             java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_budget.p_vytvoritBudgetProjekt(?,?,?); end;",0);
      st.setInt(1, idProjekt);
      st.setDate(2, dtOd);
      st.setDate(3, dtDo);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_budget.p_vytvoritBudgetProjekt",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KtgAppuserView1
   */
  public KtgAppuserViewImpl getKtgAppuserView1()
  {
    return (KtgAppuserViewImpl)findViewObject("KtgAppuserView1");
  }

  /**
   * 
   * Container's getter for KpCisMenaView1
   */
  public KpCisMenaViewImpl getKpCisMenaView1()
  {
    return (KpCisMenaViewImpl)findViewObject("KpCisMenaView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgettransakceView1
   */
  public VwDatBudgettransakceViewImpl getVwDatBudgettransakceView1()
  {
    return (VwDatBudgettransakceViewImpl)findViewObject("VwDatBudgettransakceView1");
  }

  /**
   * 
   * Container's getter for VwKtgOdborView1
   */
  public VwKtgOdborViewImpl getVwKtgOdborView1()
  {
    return (VwKtgOdborViewImpl)findViewObject("VwKtgOdborView1");
  }
  
  public void exportExcel(java.sql.Date datum, int exportType, boolean detail, boolean manual, int typ) throws KisException 
  {
    if(typ==0) {
      ESExportBudgetStd eb = new ESExportBudgetStd(this, datum, currentUsersId(), exportType, detail, manual);
      try {
        eb.excelOutput();
      }
      catch (IOException ex) {
        ex.printStackTrace(); //pro zacatek
      }
    }
    else if(typ==1) {
      ESExportBudgetProjekt eb = new ESExportBudgetProjekt(this, datum, currentUsersId(), exportType, detail, manual);
      try {
        eb.excelOutput();
      }
      catch (IOException ex) {
        ex.printStackTrace(); //pro zacatek
      }
    }
  }

  protected FileFilter getFileFilter(final String name) 
  {
    return new FileFilter() {
      public boolean accept(File pathname) 
      {
        if(pathname.getName().startsWith(name)) return false;
        else return true;
      }
    };
  }

  private java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);
  
  public String getExcels(int typ) 
  {
    StringBuffer buf = new StringBuffer();
    String dirInDir = Constants.DIR_BUDGET_STD;
    if(typ==1) dirInDir = Constants.DIR_BUDGET_PROJEKT;
    String dirName = Constants.XLS_FILES_PATH + dirInDir + "\\" + currentUsersId();
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("x");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a href=\"FileDeleteOwn.jsp?file=data|5C"+dirInDir+"|5C" + currentUsersId() + "|5C" + name + "\">DEL</a>&nbsp;");

        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+dirInDir+"|5C" + currentUsersId() + "|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  /**
   * 
   * Container's getter for VwDatBudgetpolozkadata1View1
   */
  public VwDatBudgetpolozkadata1ViewImpl getVwDatBudgetpolozkadata1View1()
  {
    return (VwDatBudgetpolozkadata1ViewImpl)findViewObject("VwDatBudgetpolozkadata1View1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetpolozkadata2View1
   */
  public VwDatBudgetpolozkadata2ViewImpl getVwDatBudgetpolozkadata2View1()
  {
    return (VwDatBudgetpolozkadata2ViewImpl)findViewObject("VwDatBudgetpolozkadata2View1");
  }
  
  public void eskaling(int idBud, int idTran) 
  {
    Set set = new HashSet();
    String zadatel = null, budget = null, tran = null;
  
    ViewObject vo = getVwDatBudgetpolozkaView1();
    vo.clearCache();
    vo.setWhereClause("ID_BUDGET = "+idBud+" AND ID_CISTYPTRAN = "+idTran);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      zadatel = (String) row.getAttribute("Odboroo");
      Number gestor = (Number) row.getAttribute("IdGestor");
      Number ucspoloo = (Number) row.getAttribute("IdUcspoloo");
      Number ucspoltop = (Number) row.getAttribute("IdUcspoltop");
      if(gestor != null) set.add(gestor);
      if(ucspoloo != null) set.add(ucspoloo);
      if(ucspoltop != null) set.add(ucspoltop);
    }
    vo.closeRowSet();
    
    if(!set.isEmpty()) 
    {
      ViewObject voBud = getVwDatBudgetView1();
      voBud.clearCache();
      voBud.setWhereClause("ID = "+idBud);
      if(voBud.hasNext()) 
      {
        Row row = voBud.next();
        budget = (String) row.getAttribute("SNazev");
      }
      voBud.closeRowSet();
      if(budget==null) 
      {
        voBud = getVwDatBudgetprojektView1();
        voBud.clearCache();
        voBud.setWhereClause("ID = "+idBud);
        if(voBud.hasNext()) 
        {
          Row row = voBud.next();
          budget = (String) row.getAttribute("SNazev");
        }
        voBud.closeRowSet();
      }
      
      ViewObject voTran = getKpCisTyptransakceView1();
      voTran.clearCache();
      voTran.setWhereClause("ID = "+idTran);
      if(voTran.hasNext()) 
      {
        Row row = voTran.next();
        tran = (String) row.getAttribute("SPopis");
      }
      voTran.closeRowSet();
    
      Mail mail = new Mail();
      mail.sendBudgetEskaling(this, zadatel, set, budget, tran);
    }
  }

  /**
   * 
   * Container's getter for KpEmailParamView1
   */
  public KpEmailParamViewImpl getKpEmailParamView1()
  {
    return (KpEmailParamViewImpl)findViewObject("KpEmailParamView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgettransakcedocView1
   */
  public VwDatBudgettransakcedocViewImpl getVwDatBudgettransakcedocView1()
  {
    return (VwDatBudgettransakcedocViewImpl)findViewObject("VwDatBudgettransakcedocView1");
  }
  
  public double getKurz(String source,
                        String dest) throws KisException
  {
    double kurz = 1.0;
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin ? = db_jt.kurzy.f_getMenaKurs('ČNB',?,?,NULL); end;",0);
      st.registerOutParameter(1, Types.DOUBLE);
      st.setString(2, dest);
      st.setString(3, source);
      st.execute();
      kurz = st.getDouble(1);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kurzy.f_getMenaKurs",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    return kurz;
  }

  /**
   * 
   * Container's getter for KpCisTyptransakcegroupView1
   */
  public KpCisTyptransakcegroupViewImpl getKpCisTyptransakcegroupView1()
  {
    return (KpCisTyptransakcegroupViewImpl)findViewObject("KpCisTyptransakcegroupView1");
  }

  /**
   * 
   * Container's getter for KpDatBudgetzastupView1
   */
  public KpDatBudgetzastupViewImpl getKpDatBudgetzastupView1()
  {
    return (KpDatBudgetzastupViewImpl)findViewObject("KpDatBudgetzastupView1");
  }

  public void zastup(String akce,
                     int id,
                     int kdo,
                     java.sql.Date dtOd,
                     java.sql.Date dtDo,
                     int koho,
                     String fwdEmail,
                     int idBudget) throws KisException
  {
    int idKoho = koho<1 ? currentUsersId() : koho;

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      if("I".equals(akce)) {
        st = dbTran.createCallableStatement("INSERT INTO DB_JT.KP_DAT_BUDGETZASTUP (ID_KOHO, ID_KDO, DT_PLATNOSTOD, DT_PLATNOSTDO, C_FWDEMAIL, ID_BUDGET) VALUES (?,?,?,?,?,?)",0);
        st.setInt(1,idKoho);
        st.setInt(2,kdo);
        st.setDate(3,dtOd);
        st.setDate(4,dtDo);
        st.setString(5,fwdEmail);
        if(idBudget>0) st.setInt(6,idBudget); else st.setNull(6,Types.INTEGER);
        st.execute();
      }
      else if("U".equals(akce)) {
        st = dbTran.createCallableStatement("UPDATE DB_JT.KP_DAT_BUDGETZASTUP SET ID_KOHO=?, ID_KDO=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, C_FWDEMAIL=?, ID_BUDGET=? WHERE ID=?",0);
        st.setInt(1,idKoho);
        st.setInt(2,kdo);
        st.setDate(3,dtOd);
        st.setDate(4,dtDo);
        st.setString(5,fwdEmail);
        if(idBudget>0) st.setInt(6,idBudget); else st.setNull(6,Types.INTEGER);
        st.setInt(7,id);
        st.execute();
      }
      else if("D".equals(akce)) {
        st = dbTran.createCallableStatement("DELETE FROM DB_JT.KP_DAT_BUDGETZASTUP WHERE ID=?",0);
        st.setInt(1,id);
        st.execute();
      }
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání java procedury zastup()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  private boolean isCurrentUserAdmin() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    if(Constants.ADMIN_USER.equals(user)) return true;
    else return false;
  }

  public boolean jsemNeboZastupuji(int osoba) 
  {
    if(isCurrentUserAdmin()) return true;

    boolean ret = false;
    int userId = currentUsersId();
    if(userId == osoba) return true;
  
    ViewObject voZastup = getKpDatBudgetzastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND (DT_PLATNOSTOD IS NULL OR DT_PLATNOSTOD<SYSDATE) AND (DT_PLATNOSTDO IS NULL OR DT_PLATNOSTDO>SYSDATE)");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      if(zastup != null && zastup.intValue()==osoba) {
        ret=true;
        break;
      }
    }
    voZastup.closeRowSet();

    return ret;
  }

  /**
   * 
   * Container's getter for KpCisTyptransakceExcelView1
   */
  public KpCisTyptransakceExcelViewImpl getKpCisTyptransakceExcelView1()
  {
    return (KpCisTyptransakceExcelViewImpl)findViewObject("KpCisTyptransakceExcelView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetpolozkadata1PARView1
   */
  public VwDatBudgetpolozkadata1PARViewImpl getVwDatBudgetpolozkadata1PARView1()
  {
    return (VwDatBudgetpolozkadata1PARViewImpl)findViewObject("VwDatBudgetpolozkadata1PARView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetpolozkadata2PARView1
   */
  public VwDatBudgetpolozkadata2PARViewImpl getVwDatBudgetpolozkadata2PARView1()
  {
    return (VwDatBudgetpolozkadata2PARViewImpl)findViewObject("VwDatBudgetpolozkadata2PARView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetprojektView1
   */
  public VwDatBudgetprojektViewImpl getVwDatBudgetprojektView1()
  {
    return (VwDatBudgetprojektViewImpl)findViewObject("VwDatBudgetprojektView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetProjektpolozkadata1PARView1
   */
  public VwDatBudgetProjektpolozkadata1PARViewImpl getVwDatBudgetProjektpolozkadata1PARView1()
  {
    return (VwDatBudgetProjektpolozkadata1PARViewImpl)findViewObject("VwDatBudgetProjektpolozkadata1PARView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetProjektpolozkadata2PARView1
   */
  public VwDatBudgetProjektpolozkadata2PARViewImpl getVwDatBudgetProjektpolozkadata2PARView1()
  {
    return (VwDatBudgetProjektpolozkadata2PARViewImpl)findViewObject("VwDatBudgetProjektpolozkadata2PARView1");
  }

  /**
   * 
   * Container's getter for VwKtgProjektView1
   */
  public VwKtgProjektViewImpl getVwKtgProjektView1()
  {
    return (VwKtgProjektViewImpl)findViewObject("VwKtgProjektView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetprojekttransakceView1
   */
  public VwDatBudgetprojekttransakceViewImpl getVwDatBudgetprojekttransakceView1()
  {
    return (VwDatBudgetprojekttransakceViewImpl)findViewObject("VwDatBudgetprojekttransakceView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetprojtransakcedocView1
   */
  public VwDatBudgetprojtransakcedocViewImpl getVwDatBudgetprojtransakcedocView1()
  {
    return (VwDatBudgetprojtransakcedocViewImpl)findViewObject("VwDatBudgetprojtransakcedocView1");
  }

  /**
   * 
   * Container's getter for KpLogBudgetnavyseniView1
   */
  public KpLogBudgetnavyseniViewImpl getKpLogBudgetnavyseniView1()
  {
    return (KpLogBudgetnavyseniViewImpl)findViewObject("KpLogBudgetnavyseniView1");
  }

  /**
   * 
   * Container's getter for NastaveniUrovniSchvalovaniView1
   */
  public NastaveniUrovniSchvalovaniViewImpl getNastaveniUrovniSchvalovaniView1()
  {
    return (NastaveniUrovniSchvalovaniViewImpl)findViewObject("NastaveniUrovniSchvalovaniView1");
  }

  public void updateUrovenSchvalovani(int typ,
                                      int id,
                                      double oo,
                                      double top) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      if(1==typ) {
        st = dbTran.createCallableStatement("UPDATE DB_JT.KP_KTG_UCETNISPOLECNOST SET ND_BUDGETNAVYSENI_OO=?, ND_BUDGETNAVYSENI_TOP=?, S_UZIVATEL=? WHERE ID=?",0);
        st.setDouble(1,oo);
        st.setDouble(2,top);
        st.setString(3,getUser());
        st.setInt(4,id);
        st.execute();
      }
      else if(2==typ) {
        st = dbTran.createCallableStatement("UPDATE DB_JT.KP_KTG_PROJEKT SET ND_BUDGETNAVYSENI_PM=?, ND_BUDGETNAVYSENI_TOP=? WHERE ID=?",0);
        st.setDouble(1,oo);
        st.setDouble(2,top);
        st.setInt(3,id);
        st.execute();
      }
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání java procedury updateUrovenSchvalovani()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  public void updateDatumSchvalovani(int id,
                                     java.sql.Date datum) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("UPDATE DB_JT.KP_DAT_BUDGET SET DT_SCHVALITDO=? WHERE ID=?",0);
      st.setDate(1,datum);
      st.setInt(2,id);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání java procedury updateDatumSchvalovani()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for WvDatBudgetpolozkadata2XPARView1
   */
  public WvDatBudgetpolozkadata2XPARViewImpl getWvDatBudgetpolozkadata2XPARView1()
  {
    return (WvDatBudgetpolozkadata2XPARViewImpl)findViewObject("WvDatBudgetpolozkadata2XPARView1");
  }

  /**
   * 
   * Container's getter for KpCisTypTranCapexOpexView1
   */
  public KpCisTypTranCapexOpexViewImpl getKpCisTypTranCapexOpexView1()
  {
    return (KpCisTypTranCapexOpexViewImpl)findViewObject("KpCisTypTranCapexOpexView1");
  }


}