package cz.jtbank.konsolidace.protistrany;
import cz.jtbank.konsolidace.common.KisException;
import oracle.jbo.server.ApplicationModuleImpl;
import oracle.jbo.server.DBTransaction;
import java.sql.CallableStatement;
import java.sql.Statement;
import java.sql.SQLException;
import cz.jtbank.konsolidace.common.Constants;
import cz.jtbank.konsolidace.excel.*;
import java.io.*;
import java.sql.*;

import org.apache.log4j.*;
import cz.jtbank.konsolidace.common.Logging;

//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---------------------------------------------------------------

public class ProtistranyModuleImpl extends ApplicationModuleImpl implements cz.jtbank.konsolidace.protistrany.common.ProtistranyModule 
{
  static Logger logger = Logger.getLogger(ProtistranyModuleImpl.class);
  static { logger.addAppender(Logging.getAppender(Logging.LOG_DEFAULT)); }

  /**
   * 
   * This is the default constructor (do not remove)
   */
  public ProtistranyModuleImpl()
  {
  }

  /**
   * 
   * Container's getter for VwProtistranaView1
   */
  public VwProtistranaViewImpl getVwProtistranaView1()
  {
    return (VwProtistranaViewImpl)findViewObject("VwProtistranaView1");
  }

  /**
   * 
   * Container's getter for VwProtistranadetailView1
   */
  public VwProtistranadetailViewImpl getVwProtistranadetailView1()
  {
    return (VwProtistranadetailViewImpl)findViewObject("VwProtistranadetailView1");
  }

  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
  public static void main2(String[] args)
  {
    launchTester("cz.jtbank.konsolidace.protistrany", "ProtistranyModuleLocal");
  }

//  class Stmt extends cz.jtbank.konsolidace.common.AbsStmt 
//  {
//  
//    public Stmt ( ApplicationModuleImpl aApplicationModuleImpl ) 
//    {
//      super ( aApplicationModuleImpl ); 
//    }
//  
//    protected void createStmt () throws SQLException
//    {
//      String userName = getUserPrincipalName();
//      st = dbTran.createCallableStatement("begin db_dsa.loadProtistrany.p_updateProtistrany ( '"+userName+"' ); end;",0);
//    }
//    
//  }

  private static boolean semaforPs = true;
  
  public void setXSemaforPs( boolean stav ) 
  {
    ProtistranyModuleImpl.semaforPs = stav;
  }
  
  public boolean getXSemaforPs(  ) 
  {
    return semaforPs ;
  }

  public void reloadProtistrany() throws KisException
  {
    if(!semaforPs) throw new KisException("V tomto okamžiku nelze spustit update protistran, protože je již spuštěn (od někoho jiného) a mohlo by dojít ke konfliktu... Pokud je to přesto nutné, zkuste to za chvíli znovu.",
                                        new KisException(Constants.ERR_MESSAGE_ONLY));
    String userName = cz.jtbank.konsolidace.common.Utils.getUserName(this, false);
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      semaforPs = false;
//      Stmt stmt = new Stmt(this);
//      stmt.execute();
      logger.info("Reload protistran startuje pro uživatele "+userName);
      st = dbTran.createCallableStatement("begin db_dsa.loadProtistrany.p_updateProtistrany ( '"+userName+"' ); "+/*db_jt.kap_report.p_loadSpravceKO;*/" end;",0);
      st.execute();
      logger.info("Reload protistran pro uživatele "+userName+" uspesne ukoncen!");
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      logger.error("Reload protistran pro uživatele "+userName+" skončil chybou!",s);
      throw new KisException("Selhalo volání procedury db_dsa.loadProtistrany.p_updateProtistrany"/* ci db_jt.kap_report.p_loadSpravceKO;"*/,s);
    }
    finally {
      semaforPs = true;
      logger.info("Reload protistran s pro uživatele "+userName+" FINALY");
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void reloadOsoby() throws KisException
  {
//ODSTRIZENO 11.7.2007
/*  
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      logger.info("Reload osob");
      st = dbTran.createCallableStatement("begin db_jt.kap_report.p_loadSpravceKO; end;",0);
      st.execute();
      logger.info("Reload osob úspěšně ukončen!");
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      logger.error("Reload osob skončil chybou!",s);
      throw new KisException("Selhalo volání procedury db_jt.kap_report.p_loadSpravceKO;",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { }
    }
*/    
  }

  /**
   * 
   * Container's getter for VwKpVyjimkyprotistranyView1
   */
  public VwKpVyjimkyprotistranyViewImpl getVwKpVyjimkyprotistranyView1()
  {
    return (VwKpVyjimkyprotistranyViewImpl)findViewObject("VwKpVyjimkyprotistranyView1");
  }

  /**
   * 
   * Container's getter for KpCisDatabazeView1
   */
  public KpCisDatabazeViewImpl getKpCisDatabazeView1()
  {
    return (KpCisDatabazeViewImpl)findViewObject("KpCisDatabazeView1");
  }
  
  public void processVyjimky(String akce,
                             int id,
                             int dbId,
                             String protistrana,
                             String ucetMaska,
                             int poziceOd) throws KisException
  {
    String sqlString = null;
    if("D".equals(akce)) 
    {
      sqlString = "DELETE FROM db_dsa.kp_ktg_ProtistranaVyjimky "+
                  "WHERE ID=" + id;
    }
    else if("I".equals(akce)) 
    {
      sqlString = "INSERT INTO db_dsa.kp_ktg_ProtistranaVyjimky "+
                  "(ID_DATABAZE, S_UCETMASKA, S_PROTISTRANA, NL_POZICEOD) "+
                  "VALUES "+
                  "("+dbId+", '"+ucetMaska+"', '"+protistrana+"', "+poziceOd+")";
    }
    else if("U".equals(akce)) 
    {
      sqlString = "UPDATE db_dsa.kp_ktg_ProtistranaVyjimky SET "+
                  "S_UCETMASKA='"+ucetMaska+"', "+
                  "S_PROTISTRANA='"+protistrana+"', "+
                  "NL_POZICEOD="+poziceOd+" "+
                  "WHERE ID="+id;
    }
    
    Statement st = null;
    try 
    {
      st = getDBTransaction().createStatement(1);
      st.execute(sqlString);
      getDBTransaction().commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury processVyjimky()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for VwProtistranahistorieView1
   */
  public VwProtistranahistorieViewImpl getVwProtistranahistorieView1()
  {
    return (VwProtistranahistorieViewImpl)findViewObject("VwProtistranahistorieView1");
  }

  /**
   * 
   * Container's getter for VwKpSpolecnostspravcekoView1
   */
  public VwKpSpolecnostspravcekoViewImpl getVwKpSpolecnostspravcekoView1()
  {
    return (VwKpSpolecnostspravcekoViewImpl)findViewObject("VwKpSpolecnostspravcekoView1");
  }

  public void exportExcelOsoby(java.sql.Date datum) throws KisException
  {
    ESExportProtiOsoby ep = new ESExportProtiOsoby(this, datum);
    try {
      ep.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  public void exportExcelGroup(java.sql.Date datum) throws KisException 
  {
    ESExportProtiGroup ep = new ESExportProtiGroup(this, datum);
    try {
      ep.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  protected FileFilter getFileFilter(final String name) 
  {
    return new FileFilter() {
      public boolean accept(File pathname) 
      {
        return true;
      }
    };
  }

  private java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);

  public String getExcelsOsoby() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_PROTI_OSOBY+"\\";
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_PROTI_OSOBY+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public String getExcelsGroup() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_PROTI_GROUP+"\\";
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_PROTI_GROUP+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  /**
   * 
   * Container's getter for KpKtgSpolecnostGroupView1
   */
  public KpKtgSpolecnostGroupViewImpl getKpKtgSpolecnostGroupView1()
  {
    return (KpKtgSpolecnostGroupViewImpl)findViewObject("KpKtgSpolecnostGroupView1");
  }

  /**
   * 
   * Container's getter for VwKpSpolecnostInGroupView1
   */
  public VwKpSpolecnostInGroupViewImpl getVwKpSpolecnostInGroupView1()
  {
    return (VwKpSpolecnostInGroupViewImpl)findViewObject("VwKpSpolecnostInGroupView1");
  }

  public void spolGroup(String akce,
                        int idSpol,
                        String gcOrig,
                        String scOrig,
                        String gn,
                        String gc,
                        String sn,
                        String sc,
                        java.sql.Date dtOd,
                        java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_KTG_SPOLECNOST_GROUP "+
                                            "(ID_SPOLECNOST, CUST_GROUP_NAME, CUST_GROUP_CODE, CUST_STRUC_NAME, CUST_STRUC_CODE, DT_PLATNOSTOD, DT_PLATNOSTDO) "+
                                            "VALUES (?,?,?,?,?,?,?)",0);
        st.setInt(1, idSpol);
        st.setString(2, gn);
        st.setString(3, gc);
        st.setString(4, sn);
        st.setString(5, sc);
        st.setDate(6, dtOd);
        st.setDate(7, dtDo);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolGroup akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_KTG_SPOLECNOST_GROUP "+
                                            "SET CUST_GROUP_NAME=?, CUST_GROUP_CODE=?, CUST_STRUC_NAME=?, CUST_STRUC_CODE=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=? "+
                                            "WHERE ID_SPOLECNOST=? AND CUST_GROUP_CODE=? AND CUST_STRUC_CODE=?",0);
        st.setString(1, gn);
        st.setString(2, gc);
        st.setString(3, sn);
        st.setString(4, sc);
        st.setDate(5, dtOd);
        st.setDate(6, dtDo);
        st.setInt(7, idSpol);
        st.setString(8, gcOrig);
        st.setString(9, scOrig);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolGroup akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_KTG_SPOLECNOST_GROUP "+
                                            "WHERE ID_SPOLECNOST=? AND CUST_GROUP_CODE=? AND CUST_STRUC_CODE=?",0);
        st.setInt(1, idSpol);
        st.setString(2, gcOrig);
        st.setString(3, scOrig);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolGroup akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  public void spolGroup(String akce,
                        int idSpolOrig,
                        String gc,
                        String gn,
                        String sc,
                        String sn,
                        int idSpol,
                        java.sql.Date dtOd,
                        java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_KTG_SPOLECNOST_GROUP "+
                                            "(ID_SPOLECNOST, CUST_GROUP_NAME, CUST_GROUP_CODE, CUST_STRUC_NAME, CUST_STRUC_CODE, DT_PLATNOSTOD, DT_PLATNOSTDO) "+
                                            "VALUES (?,?,?,?,?,?,?)",0);
        st.setInt(1, idSpol);
        st.setString(2, gn);
        st.setString(3, gc);
        st.setString(4, sn);
        st.setString(5, sc);
        st.setDate(6, dtOd);
        st.setDate(7, dtDo);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolGroup akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_KTG_SPOLECNOST_GROUP "+
                                            "SET ID_SPOLECNOST=?, CUST_GROUP_NAME=?, CUST_STRUC_NAME=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=? "+
                                            "WHERE ID_SPOLECNOST=? AND CUST_GROUP_CODE=? AND CUST_STRUC_CODE=?",0);
        st.setInt(1, idSpol);
        st.setString(2, gn);
        st.setString(3, sn);
        st.setDate(4, dtOd);
        st.setDate(5, dtDo);
        st.setInt(6, idSpolOrig);
        st.setString(7, gc);
        st.setString(8, sc);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolGroup akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_KTG_SPOLECNOST_GROUP "+
                                            "WHERE ID_SPOLECNOST=? AND CUST_GROUP_CODE=? AND CUST_STRUC_CODE=?",0);
        st.setInt(1, idSpolOrig);
        st.setString(2, gc);
        st.setString(3, sc);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolGroup akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  public void custGroup(String gc,
                        String gn,
                        String sc,
                        String sn,
                        java.sql.Date dtOd,
                        java.sql.Date dtDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    try {
      st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_CIS_CUSTOMER_GROUP "+
                                          "SET DT_PLATNOSTOD=?, DT_PLATNOSTDO=? "+
                                          "WHERE CUST_GROUP_CODE=? AND CUST_STRUC_CODE=? AND CUST_GROUP_NAME=? AND CUST_STRUC_NAME=?",0);
      st.setDate(1, dtOd);
      st.setDate(2, dtDo);
      st.setString(3, gc);
      st.setString(4, sc);
      st.setString(5, gn);
      st.setString(6, sn);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury custGroup pro CUST_GROUP_CODE="+gc,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpCisCustomerGroupView1
   */
  public KpCisCustomerGroupViewImpl getKpCisCustomerGroupView1()
  {
    return (KpCisCustomerGroupViewImpl)findViewObject("KpCisCustomerGroupView1");
  }

  public void spolSkupIc(String akce,
                         int idSpol,
                         int idClen,
                         java.sql.Date dtOd,
                         java.sql.Date dtDo,
                         java.sql.Date dtOdOrig,
                         java.sql.Date dtDoOrig) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.kp_rel_spolecnostSkupinaIc "+
                                            "(ID_KTGSPOLECNOST, ID_KTGSPOLECNOSTCLEN, DT_PLATNOSTOD, DT_PLATNOSTDO) "+
                                            "VALUES (?,?,?,?)",0);
        st.setInt(1, idSpol);
        st.setInt(2, idClen);
        st.setDate(3, dtOd);
        st.setDate(4, dtDo);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolSkupIc akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.kp_rel_spolecnostSkupinaIc "+
                                            "SET DT_PLATNOSTOD=?, DT_PLATNOSTDO=? "+
                                            "WHERE ID_KTGSPOLECNOST=? AND ID_KTGSPOLECNOSTCLEN=? AND DT_PLATNOSTOD=? AND DT_PLATNOSTDO=?",0);
        st.setDate(1, dtOd);
        st.setDate(2, dtDo);
        st.setInt(3, idSpol);
        st.setInt(4, idClen);
        st.setDate(5, dtOdOrig);
        st.setDate(6, dtDoOrig);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolSkupIc akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.kp_rel_spolecnostSkupinaIc "+
                                            "WHERE ID_KTGSPOLECNOST=? AND ID_KTGSPOLECNOSTCLEN=? AND DT_PLATNOSTOD=? AND DT_PLATNOSTDO=?",0);
        st.setInt(1, idSpol);
        st.setInt(2, idClen);
        st.setDate(3, dtOdOrig);
        st.setDate(4, dtDoOrig);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolSkupIc akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpKtgSpolecnostView1
   */
  public KpKtgSpolecnostViewImpl getKpKtgSpolecnostView1()
  {
    return (KpKtgSpolecnostViewImpl)findViewObject("KpKtgSpolecnostView1");
  }

  /**
   * 
   * Container's getter for KpRelSpolecnostskupinaicView1
   */
  public KpRelSpolecnostskupinaicViewImpl getKpRelSpolecnostskupinaicView1()
  {
    return (KpRelSpolecnostskupinaicViewImpl)findViewObject("KpRelSpolecnostskupinaicView1");
  }

  /**
   * 
   * Container's getter for KpKtgSpolecnostvprechoduView1
   */
  public KpKtgSpolecnostvprechoduViewImpl getKpKtgSpolecnostvprechoduView1()
  {
    return (KpKtgSpolecnostvprechoduViewImpl)findViewObject("KpKtgSpolecnostvprechoduView1");
  }

  public void spolVPrechodu(String akce,
                         int idSpol,
                         String ico) throws KisException 
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.kp_ktg_spolecnostVPrechodu "+
                                            "(ID_KTGSPOLECNOST, S_ICO) "+
                                            "VALUES (?,?)",0);
        st.setInt(1, idSpol);
        st.setString(2, ico);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolVPrechodu akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.kp_ktg_spolecnostVPrechodu "+
                                            "SET S_ICO=? "+
                                            "WHERE ID_KTGSPOLECNOST=?",0);
        st.setString(1, ico);
        st.setInt(2, idSpol);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolVPrechodu akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.kp_ktg_spolecnostVPrechodu "+
                                            "WHERE ID_KTGSPOLECNOST=?",0);
        st.setInt(1, idSpol);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury spolVPrechodu akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  public void manParovani(int idSpol, String ico, int idProti) throws KisException
  {
    CallableStatement st = null;
    try {
      st = getDBTransaction().createCallableStatement("begin db_dsa.loadManual.p_parovani(?,?,?,?); end;",0);
      st.setString(1, getUser());
      st.setInt(2, idSpol);
      st.setString(3, ico);
      st.setInt(4, idProti);
      st.execute();
      logger.info("manParovani - dokonceno");
    }
    catch (SQLException e) 
    {
      e.printStackTrace();
      logger.error("Selhalo volání procedury db_dsa.loadManual.p_parovani",e);
      throw new KisException("Selhalo volání procedury db_dsa.loadManual.p_parovani",e);
    }
    finally 
    {
      try 
      {
        if(st != null) st.close();
      }
      catch(Exception e) {}
    }
  }

  private String getUser() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, false);
    return user;
  }
  
	public void editSpolKodProti( int idSpol, String kod) throws KisException {
		DBTransaction dbTran = this.getDBTransaction();
		PreparedStatement st = null;
	
		try {
			st = dbTran.createPreparedStatement("update DB_JT.kp_ktg_spolecnost set  S_KODKATEGORIEPROTISTRANA_2 = ? "+
												"WHERE ID=?",0);
			st.setString(1, kod);
			st.setInt(2, idSpol);
			st.executeUpdate();
		} catch (SQLException s) {
			s.printStackTrace(); //pro zacatek
			throw new KisException("Selhal update kp_ktg_spolecnost",s);
		} finally {
			try {
			  if (st != null) st.close();
			} 
		catch (SQLException s) { /* ignore */}
		}
		dbTran.commit();
		
	}
  

  /**
   * 
   * Container's getter for KpSManualView1
   */
  public KpSManualViewImpl getKpSManualView1()
  {
    return (KpSManualViewImpl)findViewObject("KpSManualView1");
  }
  
  public static void main(String[] args)
  {
    ProtistranyModuleImpl dm = (ProtistranyModuleImpl)
      oracle.jbo.client.Configuration.createRootApplicationModule("cz.jtbank.konsolidace.protistrany.ProtistranyModule","ProtistranyModuleLocal");
	try {
		dm.editSpolKodProti( 44995, "kk" );
	} catch ( Exception e ) {
		e.printStackTrace();
	}
  }  

	/**
	 * 
	 * Container's getter for VwExtSpolecnostArchCestaView1
	 */
	public VwExtSpolecnostArchCestaViewImpl getVwExtSpolecnostArchCestaView1() {
		return (VwExtSpolecnostArchCestaViewImpl)findViewObject("VwExtSpolecnostArchCestaView1");
	}



  
}