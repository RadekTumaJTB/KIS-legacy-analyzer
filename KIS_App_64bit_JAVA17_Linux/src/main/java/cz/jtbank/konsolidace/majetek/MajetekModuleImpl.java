package cz.jtbank.konsolidace.majetek;
import cz.jtbank.konsolidace.common.*;
import cz.jtbank.konsolidace.common.KisException;
import cz.jtbank.konsolidace.excel.*;
import java.io.*;
import oracle.jbo.domain.Number;
import oracle.jbo.server.ApplicationModuleImpl;
import cz.jtbank.konsolidace.doklady.ViewJtSpolImpl;
import cz.jtbank.konsolidace.fininv.VwFinancniinvesticeViewImpl;
import cz.jtbank.konsolidace.fininv.VwFinancniinvemiseViewImpl;
import cz.jtbank.konsolidace.fininv.KpCisMenaViewImpl;
import cz.jtbank.konsolidace.protistrany.VwProtistranaViewImpl;
import java.sql.*;
import oracle.jbo.server.DBTransaction;
import cz.jtbank.konsolidace.doklady.ViewJtSpolUserPravaImpl;
import cz.jtbank.konsolidace.admin.KpParametryViewImpl;
import cz.jtbank.konsolidace.mustky.KpTmpCissubjectViewImpl;
import java.util.*;
import oracle.jbo.*;
import cz.jtbank.konsolidace.protistrany.KpKtgSpolecnostViewImpl;
//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---------------------------------------------------------------

public class MajetekModuleImpl extends ApplicationModuleImpl implements cz.jtbank.konsolidace.majetek.common.MajetekModule 
{
  /**
   * 
   * This is the default constructor (do not remove)
   */
  public MajetekModuleImpl()
  {
  }

  /**
   * 
   * Container's getter for KpCisMajetkovaucasttyptranView1
   */
  public KpCisMajetkovaucasttyptranViewImpl getKpCisMajetkovaucasttyptranView1()
  {
    return (KpCisMajetkovaucasttyptranViewImpl)findViewObject("KpCisMajetkovaucasttyptranView1");
  }

  /**
   * 
   * Container's getter for KpCisMajetkovaucastzpusobView1
   */
  public KpCisMajetkovaucastzpusobViewImpl getKpCisMajetkovaucastzpusobView1()
  {
    return (KpCisMajetkovaucastzpusobViewImpl)findViewObject("KpCisMajetkovaucastzpusobView1");
  }

  /**
   * 
   * Container's getter for VwKpMajetkovaucastView1
   */
  public VwKpMajetkovaucastViewImpl getVwKpMajetkovaucastView1()
  {
    return (VwKpMajetkovaucastViewImpl)findViewObject("VwKpMajetkovaucastView1");
  }

  /**
   * 
   * Container's getter for VwKpMajetkovaucasthistorView1
   */
  public VwKpMajetkovaucasthistorViewImpl getVwKpMajetkovaucasthistorView1()
  {
    return (VwKpMajetkovaucasthistorViewImpl)findViewObject("VwKpMajetkovaucasthistorView1");
  }

  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
  public static void main(String[] args)
  {
    launchTester("cz.jtbank.konsolidace.majetek", "MajetekModuleLocal");
  }

  /**
   * 
   * Container's getter for ViewJtSpol1
   */
  public ViewJtSpolImpl getViewJtSpol1()
  {
    return (ViewJtSpolImpl)findViewObject("ViewJtSpol1");
  }

  /**
   * 
   * Container's getter for VwFinancniinvesticeView1
   */
  public VwFinancniinvesticeViewImpl getVwFinancniinvesticeView1()
  {
    return (VwFinancniinvesticeViewImpl)findViewObject("VwFinancniinvesticeView1");
  }

  /**
   * 
   * Container's getter for VwFinancniinvemiseView1
   */
  public VwFinancniinvemiseViewImpl getVwFinancniinvemiseView1()
  {
    return (VwFinancniinvemiseViewImpl)findViewObject("VwFinancniinvemiseView1");
  }

  /**
   * 
   * Container's getter for KpCisMenaView1
   */
  public KpCisMenaViewImpl getKpCisMenaView1()
  {
    return (KpCisMenaViewImpl)findViewObject("KpCisMenaView1");
  }

  private String getUser() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, false);
    return user;
  }
  

  public void majetkovaUcast(String akce,
                             int id,
                             int idSpol,
                             int emise,
                             java.sql.Date platnostOd,
                             java.sql.Date platnostDo,
                             String ucet,
                             int typ,
                             int zpusob,
                             double ks,
                             String menaTx,
                             double cenaTx,
                             double objemTx,
                             double kurz,
                             String menaUc,
                             double cenaUc,
                             double objemUc,
                             int koupenoOd) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KpMajetkovaUcast(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?); end;",0);
      int ii = 1;
      st.setString(ii++, akce);
      st.setInt(ii++, id);
      st.setInt(ii++, idSpol);
      st.setInt(ii++, emise);
      st.setDate(ii++, platnostOd);
      st.setDate(ii++, platnostDo);
      st.setString(ii++, ucet==null?null:ucet.trim());
      if(typ == -1) 
        st.setNull(ii++, Types.INTEGER);
      else
        st.setInt(ii++, typ);
          
      if(zpusob == -1) 
        st.setNull(ii++, Types.INTEGER);
      else
        st.setInt(ii++, zpusob);
      st.setDouble(ii++, ks);
      st.setString(ii++, menaTx);
      st.setDouble(ii++, cenaTx);
      st.setDouble(ii++, objemTx);
      st.setDouble(ii++, kurz);
      st.setString(ii++, menaUc);
      st.setDouble(ii++, cenaUc);
      st.setDouble(ii++, objemUc);
      if(koupenoOd == -1) 
        st.setNull(ii++, Types.INTEGER);
      else
        st.setInt(ii++, koupenoOd);
      st.setString(ii++, getUser());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KpMajetkovaUcast",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void majetkovaUcastPlatnost(int id,
                                     java.sql.Date platnostDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KpMajetkovaUcastPlatnost (?,?,?); end;",0);
      st.setInt(1, id);
      st.setDate(2, platnostDo);
      st.setString(3, getUser());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KpMajetkovaUcastPlatnost",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public String majetekUcastKontrola(int idSpol,
                                     java.sql.Date datum) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    String message = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_prim.p_spolecMajetekUcastKontrola (?,?,?,?); end;",0);
      st.setInt(1, idSpol);
      st.setDate(2, datum);
      st.registerOutParameter(3, Types.VARCHAR);
      st.setString(4, getUser());
      st.execute();
      message = st.getString(3);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_prim.p_spolecMajetekUcastKontrola",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    return message;
  }

  public void exportExcel(java.sql.Date datum, int co) throws KisException 
  {
    ESExportMajetek em = new ESExportMajetek(this, datum, co);
    try {
      em.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }
  
  protected FileFilter getFileFilter(final String name) 
  {
    return new FileFilter() {
      public boolean accept(File pathname) 
      {
        if(pathname.getName().indexOf(name)>-1) return true;
        return false;
      }
    };
  }
  
  public String getExcels() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_MAJETKOVE_UCASTI;
    java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("MajetkoveUcasti_");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_MAJETKOVE_UCASTI+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public String getExcelsNespecific() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_MAJETKOVE_UCASTI;
    java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("MajetkoveUcastiNespecific_");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_MAJETKOVE_UCASTI+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public String getExcelsSpecific() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_MAJETKOVE_UCASTI;
    java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);
    File dir = new File(dirName);
    FileFilter ff = getFileFilter("MajetkoveUcastiSpecific_");
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_MAJETKOVE_UCASTI+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public void majetekUcastVyjimka(String akce, 
                                  int id,
                                  int idKtgDoklad,
                                  String ucet,
                                  String popis) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_gui.p_KPKtgDokladMajUcastVyjimka(?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, id);
      st.setInt(3, idKtgDoklad);
      st.setString(4, ucet==null?null:ucet.trim());
      st.setString(5, popis);
      st.setString(6, getUser());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_gui.p_KPKtgDokladMajUcastVyjimka",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for ViewJtSpolUserPrava1
   */
  public ViewJtSpolUserPravaImpl getViewJtSpolUserPrava1()
  {
    return (ViewJtSpolUserPravaImpl)findViewObject("ViewJtSpolUserPrava1");
  }

  /**
   * 
   * Container's getter for KpParametryView1
   */
  public KpParametryViewImpl getKpParametryView1()
  {
    return (KpParametryViewImpl)findViewObject("KpParametryView1");
  }

  /**
   * 
   * Container's getter for KpKtgDokladmajucastvyjimkaView1
   */
  public KpKtgDokladmajucastvyjimkaViewImpl getKpKtgDokladmajucastvyjimkaView1()
  {
    return (KpKtgDokladmajucastvyjimkaViewImpl)findViewObject("KpKtgDokladmajucastvyjimkaView1");
  }

  /**
   * 
   * Container's getter for KpTmpCissubjectView1
   */
  public KpTmpCissubjectViewImpl getKpTmpCissubjectView1()
  {
    return (KpTmpCissubjectViewImpl)findViewObject("KpTmpCissubjectView1");
  }

  //STARA POMALA VERZE!
/*
  public HashMap getEmiseMap(String dateAsString) 
  {
    HashMap map = new HashMap();
    String date = "TO_DATE('"+dateAsString+"','dd.mm.yyyy')";
    
    ViewObject voInv = getVwFinancniinvesticeView1();
    voInv.clearCache();
    ViewObject voEmi = getVwFinancniinvemiseView1();
    voEmi.clearCache();
    while(voInv.hasNext()) 
    {
      Row rowInv = voInv.next();
      //Number idSpol = (Number) rowInv.getAttribute("IdKtgspolecnost");
      //String menaSpol = (String) rowInv.getAttribute("SMena");
      Number idInv = (Number) rowInv.getAttribute("Id");
      voEmi.setWhereClause("ID_KTGFINANCNIINVESTICE = "+idInv+" AND "+date+" BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
      double celkem = 0.0;
      while(voEmi.hasNext()) 
      {
        Row rowEmi = voEmi.next();
        Number zj = (Number) rowEmi.getAttribute("NdZakladnijmeni");
        celkem += zj==null ? 0.0 : zj.doubleValue();
      }
      voEmi.closeRowSet();
      map.put(idInv, new Double(celkem));
    }
    voInv.closeRowSet();
    return map;
  }
*/
  //NOVA RYCHLA VERZE!
  public HashMap getEmiseMap(String datum) 
  {
    HashMap map = new HashMap();
    
    ViewObject vo = getVwInvesticeZakladnijmeni1();
    vo.clearCache();
    vo.setWhereClauseParam(0,datum);
    while(vo.hasNext()) 
    {
      Row row = vo.next();
      Number idInv = (Number) row.getAttribute("Id");
      Number zj = (Number) row.getAttribute("Zj");
      map.put(idInv, zj);
    }
    vo.closeRowSet();
    return map;
  }

  /**
   * 
   * Container's getter for KpKtgSpolecnostView1
   */
  public KpKtgSpolecnostViewImpl getKpKtgSpolecnostView1()
  {
    return (KpKtgSpolecnostViewImpl)findViewObject("KpKtgSpolecnostView1");
  }

  /**
   * 
   * Container's getter for KpDefKontrolamajetkovaucastView1
   */
  public KpDefKontrolamajetkovaucastViewImpl getKpDefKontrolamajetkovaucastView1()
  {
    return (KpDefKontrolamajetkovaucastViewImpl)findViewObject("KpDefKontrolamajetkovaucastView1");
  }
  
  public void defKontrolaMU(String akce,
                            int id,
                            int idSubject,
                            String ucetMaska,
                            java.sql.Date datumOd,
                            java.sql.Date datumDo) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    String message = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_guiv.p_KpDefKontrolaMajetkovaUcast(?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, id);
      st.setInt(3, idSubject);
      st.setString(4, ucetMaska==null?null:ucetMaska.trim());
      st.setDate(5, datumOd);
      st.setDate(6, datumDo);
      st.setString(7, getUser());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_guiv.p_KpDefKontrolaMajetkovaUcast",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

/*
  public void getMajetkoveUcasti(int idMatka) {
    java.sql.Date datum = new java.sql.Date(System.currentTimeMillis());
    HashMap eMap = getEmiseMap(sdf.format(datum));
    HashMap iMap = new HashMap();
    
    ViewObject voMajetek = getVwKpMajetkovaucastView1();
    voMajetek.clearCache();
    ViewObject voEmise = getVwFinancniinvemiseView1();
    voEmise.clearCache();

    String whereMajetek = "ID_KTGUCETNISPOLECNOST = " + idMatka +
                          " AND TO_DATE('"+sdf.format(datum)+"','DD.MM.YYYY') BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO";
    voMajetek.setWhereClause(whereMajetek);
    double sumaOrig = 0.0, celkem = 0.0;
    while(voMajetek.hasNext()) 
    {
      Row rowMajetek = voMajetek.next();

      Number typSel = (Number) rowMajetek.getAttribute("IdCismutyptransakce");
      boolean isNakupProdej = typSel!=null && (typSel.intValue()==1 || typSel.intValue()==2);
      Number idInv = (Number) rowMajetek.getAttribute("IdFinancniinvestice");

      celkem = ((Double)map.get(idInv)).doubleValue();

      String whereEmise = "ID = " + rowMajetek.getAttribute("IdKtgfininvesticeemise");
      voEmise.setWhereClause(whereEmise);
      if(voEmise.hasNext()) 
      {
        Row rowEmise = voEmise.next();
        ksEmise = (Number) rowEmise.getAttribute("NlPocetkusu");
        ksDil = (Number) rowMajetek.getAttribute("NlPocetkusu");
        nominal = (Number) rowEmise.getAttribute("NlNominal");
      }
      voEmise.closeRowSet();
      
      double objOrig = 0.0;
      if(isNakupProdej && ksDil!=null && nominal!=null) {
        objOrig = ksDil.doubleValue() * nominal.doubleValue();
      }
      double pctOrig = celkem==0.0 ? 0.0 : 100.0*objOrig/celkem;
    }
    voMajetek.closeRowSet();
  }
*/

  public double getPodilInvestice(int idSpol,
                                  int idProti,
                                  java.sql.Date datum) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    double podil = 0.0;
    try {
      st = dbTran.createCallableStatement("begin ? := db_jt.f_getPodilInvestice(?,?,?); end;",0);
      st.registerOutParameter(1, Types.NUMERIC);
      st.setInt(2, idSpol);
      st.setInt(3, idProti);
      st.setDate(4, datum);
      st.execute();
      podil = st.getDouble(1);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání funkce db_jt.f_getPodilInvestice",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    return podil;
  }
  
  public Set getTypNakupProdej() 
  {
    Set set = new HashSet();
    ViewObject vo = getKpCisMajetkovaucasttyptranView1();
    vo.clearCache();
    vo.setWhereClause("C_SUMAZAPOCITAVAT = '1'");
    while(vo.hasNext()) 
    {
      Row row = vo.next();
      Number id = (Number) row.getAttribute("Id");
      set.add(id);
    }
    vo.closeRowSet();
    return set;
  }

  /**
   * 
   * Container's getter for VwKpMajetkovaucastprehledView1
   */
  public VwKpMajetkovaucastprehledViewImpl getVwKpMajetkovaucastprehledView1()
  {
    return (VwKpMajetkovaucastprehledViewImpl)findViewObject("VwKpMajetkovaucastprehledView1");
  }

  /**
   * 
   * Container's getter for VwInvesticeZakladnijmeni1
   */
  public VwInvesticeZakladnijmeniImpl getVwInvesticeZakladnijmeni1()
  {
    return (VwInvesticeZakladnijmeniImpl)findViewObject("VwInvesticeZakladnijmeni1");
  }
}