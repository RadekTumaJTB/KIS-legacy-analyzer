package cz.jtbank.konsolidace.dokument;
import oracle.jbo.server.ApplicationModuleImpl;
import cz.jtbank.konsolidace.doklady.KpKtgUcetnispolecnostViewImpl;
import cz.jtbank.konsolidace.projekt.KpKtgProjektViewImpl;
import cz.jtbank.konsolidace.projekt.KpCisProjektkategorieViewImpl;
import cz.jtbank.konsolidace.projekt.KpCisProjektjtViewImpl;
import cz.jtbank.konsolidace.projekt.KpCisProjektskupViewImpl;
import cz.jtbank.konsolidace.projekt.KpCisProjektpbViewImpl;
import cz.jtbank.konsolidace.projekt.KpCisProjektuverViewImpl;
import cz.jtbank.konsolidace.users.KtgAppuserViewImpl;
import oracle.jbo.domain.Number;
import oracle.jbo.*;
import oracle.jbo.server.DBTransaction;
import java.sql.*;
import cz.jtbank.konsolidace.common.KisException;
import cz.jtbank.konsolidace.fininv.KpCisMenaViewImpl;
import cz.jtbank.konsolidace.common.Constants;
import cz.jtbank.konsolidace.mail.Mail;
import java.util.*;
import cz.jtbank.konsolidace.projekt.KpCisProjektcashflowtypViewImpl;
import cz.jtbank.konsolidace.budget.KpCisTyptransakcegroupViewImpl;
import cz.jtbank.konsolidace.projekt.KpRelProjektucspolViewImpl;
import cz.jtbank.konsolidace.ifrs.KpCisIfrssegmentViewImpl;
import cz.jtbank.konsolidace.ifrs.KpCisIfrssubsegmentViewImpl;
import cz.jtbank.konsolidace.ifrs.KpCisMngsegmentViewImpl;
import cz.jtbank.konsolidace.excel.*;
import java.io.*;
import cz.jtbank.konsolidace.budget.VwDatBudgetViewImpl;
import cz.jtbank.konsolidace.budget.VwDatBudgetprojektViewImpl;
import cz.jtbank.konsolidace.protistrany.KpKtgSpolecnostViewImpl;
import cz.jtbank.konsolidace.mustky.KpTmpCissubjectViewImpl;
import org.apache.log4j.*;
import cz.jtbank.konsolidace.common.Logging;
//  ---------------------------------------------------------------
//  ---    File generated by Oracle Business Components for Java.
//  ---  esc - + kopec rucnych uprav uz od zaciatku ....
//  ---------------------------------------------------------------

public class DokumentModuleImpl extends ApplicationModuleImpl implements cz.jtbank.konsolidace.dokument.common.DokumentModule 
{
  
  static Logger logger = Logger.getLogger(DokumentModuleImpl.class);
  static { logger.addAppender(Logging.getAppender(Logging.LOG_DEFAULT)); }
  
  /**
   * 
   * This is the default constructor (do not remove)
   */
  public DokumentModuleImpl()
  {
  }
  
  

  /**
   * 
   * Container's getter for KpKtgUsekView1
   */
  public KpKtgUsekViewImpl getKpKtgUsekView1()
  {
    return (KpKtgUsekViewImpl)findViewObject("KpKtgUsekView1");
  }

  /**
   * 
   * Container's getter for KpKtgOdborView1
   */
  public KpKtgOdborViewImpl getKpKtgOdborView1()
  {
    return (KpKtgOdborViewImpl)findViewObject("KpKtgOdborView1");
  }

  /**
   * 
   * Container's getter for KpCisTyptransakceView1
   */
  public KpCisTyptransakceViewImpl getKpCisTyptransakceView1()
  {
    return (KpCisTyptransakceViewImpl)findViewObject("KpCisTyptransakceView1");
  }

  /**
   * 
   * Container's getter for KpCisDokumentView1
   */
  public KpCisDokumentViewImpl getKpCisDokumentView1()
  {
    return (KpCisDokumentViewImpl)findViewObject("KpCisDokumentView1");
  }


  /**
   * 
   * Container's getter for VwDatSchvalovakradekView1
   */
  public VwDatSchvalovakradekViewImpl getVwDatSchvalovakradekView1()
  {
    return (VwDatSchvalovakradekViewImpl)findViewObject("VwDatSchvalovakradekView1");
  }

  /**
   * 
   * Sample main for debugging Business Components code using the tester.
   */
  public static void main(String[] args)
  {
    launchTester("cz.jtbank.konsolidace.dokument", "DokumentModuleLocal");
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostView1
   */
  public KpKtgUcetnispolecnostViewImpl getKpKtgUcetnispolecnostView1()
  {
    return (KpKtgUcetnispolecnostViewImpl)findViewObject("KpKtgUcetnispolecnostView1");
  }

  /**
   * 
   * Container's getter for KpKtgProjektView1
   */
  public KpKtgProjektViewImpl getKpKtgProjektView1()
  {
    return (KpKtgProjektViewImpl)findViewObject("KpKtgProjektView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektkategorieView1
   */
  public KpCisProjektkategorieViewImpl getKpCisProjektkategorieView1()
  {
    return (KpCisProjektkategorieViewImpl)findViewObject("KpCisProjektkategorieView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektjtView1
   */
  public KpCisProjektjtViewImpl getKpCisProjektjtView1()
  {
    return (KpCisProjektjtViewImpl)findViewObject("KpCisProjektjtView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektskupView1
   */
  public KpCisProjektskupViewImpl getKpCisProjektskupView1()
  {
    return (KpCisProjektskupViewImpl)findViewObject("KpCisProjektskupView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektpbView1
   */
  public KpCisProjektpbViewImpl getKpCisProjektpbView1()
  {
    return (KpCisProjektpbViewImpl)findViewObject("KpCisProjektpbView1");
  }

  /**
   * 
   * Container's getter for KpCisProjektuverView1
   */
  public KpCisProjektuverViewImpl getKpCisProjektuverView1()
  {
    return (KpCisProjektuverViewImpl)findViewObject("KpCisProjektuverView1");
  }

  /**
   * 
   * Container's getter for KtgAppuserView1
   */
  public KtgAppuserViewImpl getKtgAppuserView1()
  {
    return (KtgAppuserViewImpl)findViewObject("KtgAppuserView1");
  }

  private String getUser() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, false);
    return user;
  }

  public int currentUsersId() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    Number userId = null;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("S_USERID = '"+user+"'");
    if(voUser.hasNext()) 
    {
      Row rowUser = voUser.next();
      userId = (Number) rowUser.getAttribute("Id");
    }
    voUser.closeRowSet();
    if(userId == null) return -1;
    
    return userId.intValue();
  }

  private int currentUsersCisDocUcSpol() 
  {
    Number ret = null;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("ID = "+currentUsersId());
    if(voUser.hasNext()) 
    {
      Row rowUser = voUser.next();
      ret = (Number) rowUser.getAttribute("IdCisdocucspol");
      /*0	Všechno
        1	Odbory společnosti
        2	Odbory povolených společností
        3	Odbory dle země
       * */
    }
    voUser.closeRowSet();
    if(ret == null) return 0;
    
    return ret.intValue();
  }

  public boolean checkCUIndikator(String type) 
  {
    boolean ret = false;
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    Number userId = null;
    
    ViewObject voUser = getKtgAppuserView1();
    voUser.clearCache();
    voUser.setWhereClause("S_USERID = '"+user+"' AND C_INDIKATOR LIKE '%"+type+"%'");
    if(voUser.hasNext()) 
    {
      ret = true;
    }
    voUser.closeRowSet();
    return ret;
  }

  /**
   * 
   * Container's getter for KpCisMenaView1
   */
  public KpCisMenaViewImpl getKpCisMenaView1()
  {
    return (KpCisMenaViewImpl)findViewObject("KpCisMenaView1");
  }

  public int dokument(String akce,
                       int id,
                       int idCisDok,
                       int idSpol,
                       String popis,
                       int idTypTran,
                       String typizovanaTran,
                       java.sql.Date typizovanaOd,
                       java.sql.Date typizovanaDo,
                       String mena,
                       String pisemne,
                       int idProti,
                       String protistrana,
                       String cislo,
                       java.sql.Date dtSplatnosti,
                       int idZadavatel,
                       int idCisStatus,
                       String poktran,
                       java.sql.Date dtPozadUhrada,
                       int idGestor,
                       int typLink,
                       String duvodZruseni,
                       int idTypPreceneni,
                       String ucet,
                       String ucet2,
                       String dph,
                       int idBudget,
                       int idTranDev,
                       int idUhrada,
                       int idSpolB,
                       String ucetB,
                       String ucetB2,
                       String 			cerpatRezervu,
					   java.sql.Date 	DtNavyseniSchvaleno,
					   java.sql.Date 	DtNavyseniZamitnuto,
					   String 			SNavyseniZamitnuto,					   					   				
					   int 				idNavyseniMb,             
             String         idCisFa, // 11/2012  prenos do FEIS
             java.sql.Date 	DtPrijato,
					   java.sql.Date 	DtDph,
             double         castka,
             String         feisPrenos,
             java.sql.Date 	DtDatOdes,
             int            idTypFkt,  
             String         sCapex_Opex,
             java.sql.Date 	Datvystaveni
					   ) throws KisException
  {
    int idRet = -1;
    int sendMail = 0;
    int userId = currentUsersId();
    
    if(idZadavatel == 0) idZadavatel=userId;

    //ulozit si id-cka schvalujicich a zamitajicih kvuli rozesilani emailu v pripade zmeny
    Set userIds = null;
    if("U".equals(akce)) 
    {
      userIds = new HashSet();
      Number user = null;
      Number zady = null;
      boolean schvalujeSe = false;
      oracle.jbo.domain.Date dt = null;
      oracle.jbo.domain.Date dtZamit = null;
      
      ViewObject vo = getVwDatSchvalovakView1();
      vo.clearCache();
      vo.setWhereClause("ID = "+id);
      if(vo.hasNext()) 
      {
        Row row = vo.next();
        
        user = (Number) row.getAttribute("IdGestor");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtGestorschvaleno");
        dtZamit = (oracle.jbo.domain.Date) row.getAttribute("DtGestorzamitnuto");
        schvalujeSe |= (dtZamit!=null || dt!=null);
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        zady = (Number) row.getAttribute("IdZadavatel");
      }
      vo.closeRowSet();
      
      vo = getVwDatSchvalovakradekView1();
      vo.setWhereClause("ID_DOKUMENT = "+id);
      while(vo.hasNext()) 
      {
        Row row = vo.next();
        
        dtZamit = (oracle.jbo.domain.Date) row.getAttribute("DtZamitnuto");
        schvalujeSe |= dtZamit!=null;
        user = (Number) row.getAttribute("IdOdboroo");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtSchvalenoodbor");
        schvalujeSe |= dt!=null;
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        user = (Number) row.getAttribute("IdProjektman");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtSchvalenoprojekt");
        schvalujeSe |= dt!=null;
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        user = (Number) row.getAttribute("IdUcspoloo");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtSchvalenoucspol");
        schvalujeSe |= dt!=null;
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        user = (Number) row.getAttribute("IdUcspoltop");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtSchvalenotop");
        schvalujeSe |= dt!=null;
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        user = (Number) row.getAttribute("IdZamitnuto");
        if(user!=null && dtZamit!=null) userIds.add(user);
      }
      vo.closeRowSet();
      
      if(schvalujeSe && zady!=null) userIds.add(zady);
    }
    
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_dokument(?,?,?,?,?, ?,?,?,?,?, ?,?,?,?,?, ?,?,?,?,?, ?,?,?,?,?, ?,?,?,?,?, ?,?,?,?,?, ?,?,?,? ,?,?,?,?,?,?,? ,?,?); end;",0);
      st.setString(1, akce);
      st.registerOutParameter(2,Types.INTEGER);
      st.setInt(2, id);
      st.setInt(3, idCisDok);
      if(idSpol>0) st.setInt(4, idSpol); else st.setNull(4, Types.INTEGER);
      st.setString(5, popis);
      if(idTypTran>0) st.setInt(6, idTypTran); else st.setNull(6, Types.INTEGER);
      st.setString(7, typizovanaTran);
      st.setDate(8,typizovanaOd);
      st.setDate(9,typizovanaDo);
      st.setString(10, mena);
      st.setString(11, pisemne);
      if(idProti>0) st.setInt(12, idProti); else st.setNull(12,Types.INTEGER);
      st.setString(13, protistrana);
      st.setString(14, cislo);
      st.setDate(15,dtSplatnosti);
      st.setInt(16, idZadavatel);
      st.setInt(17, idCisStatus);
      st.setString(18, poktran);
      st.setDate(19,dtPozadUhrada);
      if(idGestor>0) st.setInt(20, idGestor); else st.setNull(20,Types.INTEGER);
      st.setInt(21, userId);
      if(typLink>0) st.setInt(22, typLink); else st.setNull(22,Types.INTEGER);
      st.setString(23, duvodZruseni);
      st.registerOutParameter(24,Types.INTEGER);
      if(idTypPreceneni>0) st.setInt(25, idTypPreceneni); else st.setNull(25,Types.INTEGER);
      st.setString(26, ucet==null?null:ucet.trim());
      st.setString(27, ucet2==null?null:ucet2.trim());
      st.setString(28, dph);
      if(idBudget>0) st.setInt(29, idBudget); else st.setNull(29,Types.INTEGER);
      if(idTranDev>0) st.setInt(30, idTranDev); else st.setNull(30,Types.INTEGER);
      if(idUhrada>0) st.setInt(31, idUhrada); else st.setNull(31,Types.INTEGER);
      if(idSpolB>0) st.setInt(32, idSpolB); else st.setNull(32, Types.INTEGER);
      st.setString(33, ucetB==null?null:ucetB.trim());
      st.setString(34, ucetB2==null?null:ucetB2.trim());
      st.setString(35, cerpatRezervu);
	  st.setDate(36, DtNavyseniSchvaleno); //esc 23.07 08
	  st.setDate(37, DtNavyseniZamitnuto);
	  st.setString(38, SNavyseniZamitnuto);					   					   				
	  if(idNavyseniMb >0) st.setInt(39, idNavyseniMb); else st.setNull(39,Types.INTEGER);	  
	  st.setString(40, idCisFa);   //esc 15.11 12  KIS-FEIS
    st.setDate(41, DtPrijato); 
    st.setDouble(42,castka);
    st.setString(43, feisPrenos);
	  st.setDate(44, DtDph);
	  st.setDate(45, DtDatOdes);
    if(idTypFkt>0) st.setInt(46, idTypFkt); else st.setNull(46,Types.INTEGER);
    st.setString(47, sCapex_Opex);
	  st.setDate(48, Datvystaveni);    
    st.execute();
      idRet = st.getInt(2);
      sendMail = st.getInt(24);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_dokument",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    // rozeslat emaily tem, komu se zrusilo schvaleni ci zamitnuti
    if(sendMail > 0 && userIds != null && !userIds.isEmpty()) {
      Mail mail = new Mail();
      
      mail.sendDocZmenaZruseni(this, id, userIds);
    }
  
    return idRet;
  }

  public void setUhrada(int id, int idUhrada) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_setUhrada(?,?); end;",0);
      st.setInt(1, id);
      if(idUhrada>0) st.setInt(2, idUhrada); else st.setNull(2,Types.INTEGER);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_setUhrada",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void statusChange(int id, int idCisStatus) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_statusChange(?,?); end;",0);
      st.setInt(1, id);
      st.setInt(2, idCisStatus);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_statusChange",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void setRealDatumUhrady(int id, java.sql.Date dtRealUhrada, int idSpolUhrada) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_setRealDatumUhrady(?,?,?); end;",0);
      st.setInt(1, id);
      st.setDate(2, dtRealUhrada);
      if(idSpolUhrada>0)
        st.setInt(3, idSpolUhrada);
      else 
        st.setNull(3, Types.INTEGER);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_setRealDatumUhrady",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }


  public int dokumentRadek(String akce,
                            int id,
                            int idDok,
                            int idOdbor,
                            int idProjekt,
                            double castka,
                            String komentar,
                            String kpref,
                            int idTypTran,
                            int idObjRadek,
                            int idBankar,
                            String IsitBudget
							) throws KisException
  {
    int idRet = -1;
    int sendMail = 0;
    
    //ulozit si id-cka schvalujicich a zamitajicih kvuli rozesilani emailu v pripade zmeny
    Set userIds = null;
    if("U".equals(akce)) 
    {
      userIds = new HashSet();
      Number user = null;
      Number zady = null;
      boolean schvalujeSe = false;
      oracle.jbo.domain.Date dt = null;
      oracle.jbo.domain.Date dtZamit = null;
      
      ViewObject vo = getVwDatSchvalovakView1();
      vo.clearCache();
      vo.setWhereClause("ID = "+idDok);
      if(vo.hasNext()) 
      {
        Row row = vo.next();
        
        user = (Number) row.getAttribute("IdGestor");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtGestorschvaleno");
        dtZamit = (oracle.jbo.domain.Date) row.getAttribute("DtGestorzamitnuto");
        schvalujeSe |= (dtZamit!=null || dt!=null);
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        zady = (Number) row.getAttribute("IdZadavatel");
      }
      vo.closeRowSet();
      
      vo = getVwDatSchvalovakradekView1();
      vo.setWhereClause("ID = "+id);
      if(vo.hasNext()) 
      {
        Row row = vo.next();
        
        dtZamit = (oracle.jbo.domain.Date) row.getAttribute("DtZamitnuto");
        schvalujeSe |= dtZamit!=null;
        user = (Number) row.getAttribute("IdOdboroo");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtSchvalenoodbor");
        schvalujeSe |= dt!=null;
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        user = (Number) row.getAttribute("IdProjektman");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtSchvalenoprojekt");
        schvalujeSe |= dt!=null;
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        user = (Number) row.getAttribute("IdUcspoloo");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtSchvalenoucspol");
        schvalujeSe |= dt!=null;
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        user = (Number) row.getAttribute("IdUcspoltop");
        dt = (oracle.jbo.domain.Date) row.getAttribute("DtSchvalenotop");
        schvalujeSe |= dt!=null;
        if(user!=null && (dtZamit!=null || dt!=null)) userIds.add(user);
        user = (Number) row.getAttribute("IdZamitnuto");
        if(user!=null && dtZamit!=null) userIds.add(user);
      }
      vo.closeRowSet();
      
      if(schvalujeSe && zady!=null) userIds.add(zady);
    }
    
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_dokumentradek(?,?,?,?,?,?,?,?,?,? ,?,?, ?); end;",0);
      st.setString(1, akce);
      st.registerOutParameter(2,Types.INTEGER);
      st.setInt(2, id);
      st.setInt(3, idDok);
      if(idOdbor>0) st.setInt(4, idOdbor); else st.setNull(4, Types.INTEGER);
      if(idProjekt>0) st.setInt(5, idProjekt); else st.setNull(5, Types.INTEGER);
      st.setDouble(6, castka);
      st.setString(7, komentar);
      st.setString(8, kpref);
      st.registerOutParameter(9,Types.INTEGER);
      if(idTypTran>0) st.setInt(10, idTypTran); else st.setNull(10, Types.INTEGER);
	  //esc 01/09 OBJ
	  st.setInt(11, idObjRadek);
    st.setInt(12, idBankar);
    st.setString(13, IsitBudget);
      st.execute();
      idRet = st.getInt(2);
      sendMail = st.getInt(9);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_dokumentradek",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }

    // rozeslat emaily tem, komu se zrusilo schvaleni ci zamitnuti
    if(sendMail > 0 && userIds != null && !userIds.isEmpty()) {
      Mail mail = new Mail();
      
      mail.sendDocZmenaZruseni(this, idDok, userIds);
    }

    return idRet;
  }

  public void odbor(String akce,
                    int id,
                    int idSpol,
                    String nazev,
                    String kod,
                    int idOsoba,
                    java.sql.Date sDtOd,
                    java.sql.Date sDtDo,
                    int usek,
                    int mngSeg,
                    double uroven1,
                    String bud,
                    String arch,
                    int idSponzor) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_odbor(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, id);
      st.setInt(3, idSpol);
      st.setString(4, nazev);
      st.setString(5, kod);
      if(idOsoba>0) st.setInt(6, idOsoba);
      else st.setNull(6, Types.INTEGER);
      st.setDate(7, sDtOd);
      st.setDate(8, sDtDo);
      if(usek>0) st.setInt(9, usek);
      else st.setNull(9, Types.INTEGER);
      if(mngSeg>0) st.setInt(10, mngSeg);
      else st.setNull(10, Types.INTEGER);
      st.setDouble(11, uroven1);
      st.setString(12, bud);
      st.setString(13, arch);
      if(idSponzor>0) st.setInt(14, idSponzor);
      else st.setNull(14, Types.INTEGER);
      st.setString(15, getUser());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_odbor",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void usek(String akce,
                   int id,
                   int idSpol,
                   String nazev,
                   int idOsoba) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      if("I".equals(akce)) {
        st = dbTran.createCallableStatement("INSERT INTO DB_JT.KP_KTG_USEK (ID, ID_KTGUCETNISPOLECNOST, S_NAZEV, ID_ODPOVEDNAOSOBA) SELECT MAX(ID)+1,?,?,? FROM DB_JT.KP_KTG_USEK",0);
        st.setInt(1,idSpol);
        st.setString(2,nazev);
        st.setInt(3,idOsoba);
        st.execute();
      }
      else if("U".equals(akce)) {
        st = dbTran.createCallableStatement("UPDATE DB_JT.KP_KTG_USEK SET ID_KTGUCETNISPOLECNOST=?, S_NAZEV=?, ID_ODPOVEDNAOSOBA=? WHERE ID=?",0);
        st.setInt(1,idSpol);
        st.setString(2,nazev);
        st.setInt(3,idOsoba);
        st.setInt(4,id);
        st.execute();
      }
      else if("D".equals(akce)) {
        st = dbTran.createCallableStatement("DELETE FROM DB_JT.KP_KTG_USEK WHERE ID=?",0);
        st.setInt(1,id);
        st.execute();
      }
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání java procedury usek()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  public void schvaleno(String akce,
                        int idRadek,
                        int typOO) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_schvaleno(?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idRadek);
      st.setInt(3, typOO);
      st.setInt(4, currentUsersId());
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
	
	  //esc automaticke zamitnuti budgetu
	  int  vOraErr = s.getErrorCode() ;	  	   
	  if ( vOraErr == 20777 ) {	    
			// zamitnoutRadek( akce, idRadek, "Automaticke zamitnuti! V Budgetu Nezarazeno neni dostatek financnich zdroju!") ;
			zamitnoutRadek( akce, idRadek, "Automatické zamietnutie! V Nezařazeno nie je dostatok prostriedkov. Žiadajte navýšenie mimo rezervy.") ;											
	  		//throw new KisException( vOraErr +" ORA CHYBA xx20777xx db_jt.kap_dokument.p_schvaleno",s);
			
	  }
      else 
		throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_schvaleno",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void sGestor(String akce,
                      int idDoc) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_sGestor(?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idDoc);
      st.setInt(3, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_sGestor",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

// navyseni budgetu
  public void sMB(String akce,
                  int idDoc) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_sMB(?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idDoc);
      st.setInt(3, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_sMB",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }
  public void sUcetni(String akce,
                      int idDoc) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_sUcetni(?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idDoc);
      st.setInt(3, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_sUcetni",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void sUcetniUhrada(String akce,
                            int idDoc) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_sUcetniUhrada(?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idDoc);
      st.setInt(3, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_sUcetniUhrada",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void prefakturovano(String akce,
                             int idRadek) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_prefakturovano(?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idRadek);
      st.setInt(3, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_prefakturovano",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public boolean isCurrentUserZU(int idDoc) 
  {
    if(isCurrentUserAdmin()) return true;

    boolean ret = false;

    int userId = currentUsersId();
    if(userId < 0) return false;

    ViewObject vo = getVwDatSchvalovakView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idDoc+" AND (ID_ZODPOVEDNAUCETNI = "+userId+
                     " OR ID_ADMINISTRATOR = "+userId+
                     " OR ID_ZODPOVEDNAUCETNI IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO)"+
                     " OR ID_ADMINISTRATOR IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO))");
    if(vo.hasNext()) 
    {
      ret = true;
    }
    vo.closeRowSet();
    
    return ret;
  }

  public boolean isCurrentUserZUUhrada(int idDoc) 
  {
    if(isCurrentUserAdmin()) return true;

    boolean ret = false;

    int userId = currentUsersId();
    if(userId < 0) return false;

    ViewObject vo = getVwDatSchvalovakView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idDoc+" AND (ID_UHRADAUCETNI = "+userId+
                     " OR ID_UHRADAADMIN = "+userId+
                     " OR ID_UHRADAUCETNI IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO)"+
                     " OR ID_UHRADAADMIN IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO))");
    if(vo.hasNext()) 
    {
      ret = true;
    }
    vo.closeRowSet();
    
    return ret;
  }

  public boolean isCurrentUserGestor(int idDoc) 
  {
    if(isCurrentUserAdmin()) return true;

    boolean ret = false;

    int userId = currentUsersId();
    if(userId < 0) return false;

    ViewObject vo = getVwDatSchvalovakView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idDoc+" AND (ID_GESTOR = "+userId+
                     " OR ID_GESTOR IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO))");
    if(vo.hasNext()) 
    {
      ret = true;
    }
    vo.closeRowSet();
    
    return ret;
  }


  public boolean isCurrentUserMB(int idDoc) 
  {
    /*v1
	 String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    if(Constants.MASTER_BUDGET.equals(user)) return true;
    else return false;
	*/
//esc docasne povolene pre admin!
    //if(isCurrentUserAdmin()) return true;
//
    boolean ret = false;
    int userId = currentUsersId();
    if(userId < 0) return false;

    ViewObject vo = getVwDatSchvalovakView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idDoc+" AND (ID_NAVYSENI_MB = "+userId+
                     " OR ID_NAVYSENI_MB IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO))");
    if(vo.hasNext()) 
    {
      ret = true;
    }
	
    vo.closeRowSet();    
    return ret;		
  }
    
  private boolean isCurrentUserAdmin() 
  {
    String user = cz.jtbank.konsolidace.common.Utils.getUserName(this, true);
    if(Constants.ADMIN_USER.equals(user)) return true;
    else return false;
  }

  public boolean isCurrentUserType(int idSpol, int typeUser) 
  {
    if(isCurrentUserAdmin()) return true;
  
    boolean ret = false;
  
    String kdo = null;
    if(typeUser==Constants.UCETNI) { kdo="ID_ZODPOVEDNAUCETNI"; }
    else if(typeUser==Constants.SPRAVCE) { kdo="ID_SPRAVCEKONSOLIDACE"; }
    else if(typeUser==Constants.OO) { kdo="ID_ODPOVEDNAOSOBA"; }
    else if(typeUser==Constants.TOP) { kdo="ID_TOPMNG"; }
    else if(typeUser==Constants.SEF_SEGMENTU) { kdo="ID_MNGSEGMENTBOSS"; }
  
    int userId = currentUsersId();
    if(userId < 0) return false;
    
    ViewObject vo = getKpKtgUcetnispolecnostView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idSpol+
                      " AND "+kdo+" = "+userId);
    if(vo.hasNext()) 
    {
      ret = true;
    }
    vo.closeRowSet();
    
    return ret;
  }

  public void setUroven(int id,
                        double castka,
                        int uroven) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    String sql = null;
    if(uroven==1) sql = "UPDATE DB_JT.KP_KTG_ODBOR SET ND_DOCUROVEN1=? WHERE ID=?";
    if(uroven==2) sql = "UPDATE DB_JT.KP_KTG_UCETNISPOLECNOST SET ND_DOCUROVEN2=?, S_UZIVATEL='"+getUser()+"' WHERE ID=?";
    try {
      st = dbTran.createCallableStatement(sql,0);
      st.setDouble(1,castka);
      st.setInt(2,id);
      st.execute();
      dbTran.commit();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhal update ND_DOCUROVEN"+uroven,s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for VwKtgOdborView1
   */
  public VwKtgOdborViewImpl getVwKtgOdborView1()
  {
    return (VwKtgOdborViewImpl)findViewObject("VwKtgOdborView1");
  }

  /**
   * 
   * Container's getter for KpDatDoczastupView1
   */
  public KpDatDoczastupViewImpl getKpDatDoczastupView1()
  {
    return (KpDatDoczastupViewImpl)findViewObject("KpDatDoczastupView1");
  }

///--------
// vrati zoznam SL, kde bol pouzity riadok z OBJ ( cerpala sa neuplna ciastka )   - vezia bez rowsetu
	public String getSL4OBJdb( int idObjRadek )     
	{
	DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
	String zoznamSL="";
	String s_tmp;
	try {
      String sqlStm = "begin db_jt.p_getSL4OBJdb(?,?); end;";
      st = dbTran.createCallableStatement(sqlStm,0);
      st.registerOutParameter(1, Types.INTEGER);
      st.registerOutParameter(2, Types.VARCHAR);
      st.setInt(1, idObjRadek);	  
      
	  st.execute();
      
	  zoznamSL = st.getString(2);
	  
      if(("-1").equals(zoznamSL) ) {    
			zoznamSL = "";
			logger.debug("db_jt.p_getSL4OBJdb NEvrátilo hodnotu");
	  }
	  else 	logger.debug("db_jt.p_getSL4OBJdb vrátilo hodnotu "+zoznamSL);  
	  }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      logger.error("Selhalo volání procedury db_jt.p_getSL4OBJdb",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { s.printStackTrace();}
    }
	return zoznamSL;
	}
///---------

// vrati ID aktualneho budgetu podla id riadku
	public String getIdBudget( int id )     
	{
	DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
	String IdBudget="";
	try {
      String sqlStm = "begin db_jt.p_getIdBudget(?,?); end;";
      st = dbTran.createCallableStatement(sqlStm,0);
      st.registerOutParameter(1, Types.INTEGER);
      st.registerOutParameter(2, Types.VARCHAR);
      st.setInt(1, id);	  
      
	  st.execute();
      
	  IdBudget = st.getString(2);
	  
/*    if(IdBudget.length()>0) {        
			logger.debug("db_jt.p_getIdBudget vrátilo hodnotu "+IdBudget+"pre vstup:"+id);      
	  }
	  else 	a
    
      logger.debug("db_jt.p_getIdBudget NEvrátilo hodnotu"+"pre vstup:"+id);
*/	  
    }
    
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      logger.error("Selhalo volání procedury db_jt.p_getIdBudget",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { s.printStackTrace();}
    }
	return IdBudget;
	}
///---------

// vrati ID SL podla ID riadku - vezia bez rowsetu
	public String getIdSL4IdRowdb( int idRadek )     
	{
	DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
	String IdSL="";
	try {
      String sqlStm = "begin db_jt.p_getIdSL4IdRowdb(?,?); end;";
      st = dbTran.createCallableStatement(sqlStm,0);
      st.registerOutParameter(1, Types.INTEGER);
      st.registerOutParameter(2, Types.VARCHAR);
      st.setInt(1, idRadek);	  
      
	  st.execute();
      
	  IdSL = st.getString(2);
	  
      if(IdSL.length()>0) {        
			logger.debug("db_jt.p_getIdSL4IdRowdb vrátilo hodnotu "+IdSL);      
	  }
	  else 	logger.debug("db_jt.p_getIdSL4IdRowdb NEvrátilo hodnotu");
	  }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      logger.error("Selhalo volání procedury db_jt.p_getIdSL4IdRowdb",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { s.printStackTrace();}
    }
	return IdSL;
	}
///---------


// !! esc NAHRADENE moze zmazat vrati Id SL, podla riadku
/*  public String getIdSL4IdRow( int idRadek ) 
  {
    String ID = "";
	ViewObject vo = getVwDatSchvalovakradekView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idRadek);
	
	//prvy SL
	if(vo.hasNext()) {
			Row row = vo.next();
			ID = row.getAttribute("IdDokument").toString();		
	}
	vo.closeRowSet();		
    return ID;
  }
*/
// !! esc NAHRADENE moze zmazat vrati zoznam SL, kde bol pouzity riadok z OBJ ( cerpala sa neuplna ciastka )     
/*  public String getSL4OBJ( int idObjRadek ) 
  {
    String zoznamSL = "";
	ViewObject vo = getVwDatSchvalovakradekView1();
    vo.clearCache();
    vo.setWhereClause("ID_OBJ_RADEK = "+idObjRadek);
	
	
			//prvy SL
			if(vo.hasNext()) 
			{
				Row row = vo.next();
				zoznamSL = row.getAttribute("IdDokument").toString();		
			}
	
			// druhy SL a dalsie
			while(vo.hasNext()) 
			{
				Row row = vo.next();
				zoznamSL += ", "+ row.getAttribute("IdDokument").toString();		
			}
			vo.closeRowSet();
	
	//zoznamSL += ",TEST";
    return zoznamSL;
  }
*/  
  public String getWherePrijate() 
  {
    int userId = currentUsersId();
  
    StringBuffer where = new StringBuffer(8000);
	
	where.append("(exists (select null from db_jt.KP_DAT_DOKUMENTRADEK dr where VwDatSchvalovak.id = dr.id_dokument and (dr.id_odboroo=");
	where.append(userId);
	where.append(" or dr.id_projektman=");
	where.append(userId);
	where.append(" or id_ucspoloo=");
	where.append(userId);
	where.append(" or id_ucspoltop=");
	where.append(userId);
	where.append("))");

    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      where.append(" or exists (select null from db_jt.KP_DAT_DOKUMENTRADEK dr where VwDatSchvalovak.id = dr.id_dokument");
	  where.append(" and (dr.id_odboroo=");
	  where.append(zastup);
	  where.append(" or dr.id_projektman=");
	  where.append(zastup);
	  where.append(" or id_ucspoloo=");
	  where.append(zastup);
	  where.append(" or id_ucspoltop=");
	  where.append(zastup);
	  where.append("))");
    }
    voZastup.closeRowSet();
    where.append(")");

    return where.toString();
  }

  public String getWhereOdeslane() 
  {
    int userId = currentUsersId();
    
    StringBuffer where = new StringBuffer("(ID_ZADAVATEL = "+userId+" ");

    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      where.append(" OR ID_ZADAVATEL = "+zastup+" ");
    }
    voZastup.closeRowSet();
    where.append(")");

    return where.toString();
  }

  public String getWhereGestorovane() 
  {
    int userId = currentUsersId();
    
    StringBuffer where = new StringBuffer("(ID_GESTOR = "+userId+" ");

    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      where.append(" OR ID_GESTOR = "+zastup+" ");
    }
    voZastup.closeRowSet();
    where.append(")");
    
    where.append(" and exists (select null from db_jt.KP_DAT_DOKUMENTRADEK dr where VwDatSchvalovak.id = dr.id_dokument)");

    return where.toString();
  }

 public String getWhereMasterBudgeter() 
  {
    int userId = currentUsersId();
    
    StringBuffer where = new StringBuffer("(ID_NAVYSENI_MB = "+userId+" ");

    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      where.append(" OR ID_NAVYSENI_MB = "+zastup+" ");
    }
    voZastup.closeRowSet();
    where.append(")");
    
    where.append(" and exists (select null from db_jt.KP_DAT_DOKUMENTRADEK dr where VwDatSchvalovak.id = dr.id_dokument)");

    return where.toString();
  }


  public String getWherePrijateSchvaleno() 
  {
    int userId = currentUsersId();
  
    StringBuffer where = new StringBuffer("(EXISTS (SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR "+
		                        "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND "+
                                "DR.DT_ZAMITNUTO IS NULL AND "+
		                            "((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+userId+") OR "+
			                           "(DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+userId+") OR "+
			                           "(DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+userId+") OR "+
			                           "(DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+userId+"))) "+
                                          "OR (ID_GESTOR = "+userId+" AND DT_GESTORSCHVALENO IS NULL) "+
										  "OR (ID_NAVYSENI_MB = "+userId+" AND DT_NAVYSENI_SCHVALENO  IS NULL) "); /* esc 18.6.2009 */
										  
    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      where.append(" OR EXISTS (SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR "+
		                        "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND "+
                                "DR.DT_ZAMITNUTO IS NULL AND "+
		                            "((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+zastup+") OR "+
			                           "(DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+zastup+") OR "+
			                           "(DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+zastup+") OR "+
			                           "(DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+zastup+"))) "+
                                          "OR (ID_GESTOR = "+zastup+" AND DT_GESTORSCHVALENO IS NULL) "+
										  "OR (ID_NAVYSENI_MB = "+zastup+" AND DT_NAVYSENI_SCHVALENO  IS NULL) ");  /* esc 18.6.2009 */
	}
    voZastup.closeRowSet();
    where.append(")");

    return where.toString();
  }

  public String getWherePrijatePosledni() 
  {
    int userId = currentUsersId();
  
    StringBuffer where = new StringBuffer("(EXISTS ( SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR " +
		                                                "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND " +
                                                          "DR.DT_ZAMITNUTO IS NULL AND "+
                                                    //esc 18.06.2009 
													 //"(DR.ID_ODBOROO="+userId+" OR DR.ID_PROJEKTMAN="+userId+" OR ID_UCSPOLOO="+userId+" OR ID_UCSPOLTOP="+userId+") AND "+
													   "(DR.ID_ODBOROO="+userId+" OR DR.ID_PROJEKTMAN="+userId+" OR ID_UCSPOLOO="+userId+" OR ID_UCSPOLTOP="+userId+
													   " OR ID_NAVYSENI_MB =" +userId+ "AND DT_NAVYSENI_SCHVALENO IS NULL"+ ") AND "+
													       "(((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+userId+") OR (ID_ODBOROO IS NULL) OR (ID_ODBOROO <> "+userId+" AND DR.DT_SCHVALENOODBOR IS NOT NULL)) AND " +
		                                                    "((DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+userId+") OR (ID_PROJEKTMAN IS NULL) OR (ID_PROJEKTMAN <> "+userId+" AND DR.DT_SCHVALENOPROJEKT IS NOT NULL)) AND " +
			                                                  "((DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+userId+") OR (ID_UCSPOLOO IS NULL) OR (ID_UCSPOLOO <> "+userId+" AND DR.DT_SCHVALENOUCSPOL IS NOT NULL)) AND " +
			                                                  "((DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+userId+") OR (ID_UCSPOLTOP IS NULL) OR (ID_UCSPOLTOP <> "+userId+" AND DR.DT_SCHVALENOTOP IS NOT NULL)))) ");

    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      where.append(" OR EXISTS ( SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR " +
		                                                "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND " +
                                                          "DR.DT_ZAMITNUTO IS NULL AND "+
                                                       //esc 18.06.2009 
													   //"(DR.ID_ODBOROO="+zastup+" OR DR.ID_PROJEKTMAN="+zastup+" OR ID_UCSPOLOO="+zastup+" OR ID_UCSPOLTOP="+zastup+") AND "+
													   "(DR.ID_ODBOROO="+zastup+" OR DR.ID_PROJEKTMAN="+zastup+" OR ID_UCSPOLOO="+zastup+" OR ID_UCSPOLTOP="+zastup+
													   " OR ID_NAVYSENI_MB =" +userId+ "AND DT_NAVYSENI_SCHVALENO IS NULL"+ ") AND "+													   
		                                                   "(((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+zastup+") OR (ID_ODBOROO IS NULL) OR (ID_ODBOROO <> "+zastup+" AND DR.DT_SCHVALENOODBOR IS NOT NULL)) AND " +
		                                                    "((DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+zastup+") OR (ID_PROJEKTMAN IS NULL) OR (ID_PROJEKTMAN <> "+zastup+" AND DR.DT_SCHVALENOPROJEKT IS NOT NULL)) AND " +
			                                                  "((DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+zastup+") OR (ID_UCSPOLOO IS NULL) OR (ID_UCSPOLOO <> "+zastup+" AND DR.DT_SCHVALENOUCSPOL IS NOT NULL)) AND " +
			                                                  "((DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+zastup+") OR (ID_UCSPOLTOP IS NULL) OR (ID_UCSPOLTOP <> "+zastup+" AND DR.DT_SCHVALENOTOP IS NOT NULL)))) ");
    }
    voZastup.closeRowSet();
    where.append(")");

    return where.toString();
  }

  public String getWherePrijateJaTopPar() 
  {
    int userId = currentUsersId();
  
    StringBuffer where = new StringBuffer("(EXISTS (SELECT NULL FROM DB_JT.VW_DAT_SCHVALOVAKRADEK DR "+
		                        "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND "+
                                 "DR.DT_ZAMITNUTO IS NULL AND "+
                                " DR.NESCHVALENO_TOP_PAR = '1' AND "+
		                            "((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+userId+") OR "+
			                           "(DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+userId+") OR "+
			                           "(DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+userId+") OR "+
			                           "(DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+userId+"))) "+
                                          //esc 121208
										  //"OR (ID_GESTOR = "+userId+" AND DT_GESTORSCHVALENO IS NULL) ");
                                          "OR (ID_GESTOR = "+userId+" AND DT_GESTORSCHVALENO IS NULL) "+
										  "OR (ID_NAVYSENI_MB = "+userId+" AND DT_NAVYSENI_SCHVALENO  IS NULL) ");
    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      where.append(" OR EXISTS (SELECT NULL FROM DB_JT.VW_DAT_SCHVALOVAKRADEK DR "+
		                        "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND "+
                                 "DR.DT_ZAMITNUTO IS NULL AND "+
                                " DR.NESCHVALENO_TOP_PAR = '1' AND "+
		                            "((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+zastup+") OR "+
			                           "(DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+zastup+") OR "+
			                           "(DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+zastup+") OR "+
			                           "(DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+zastup+"))) "+
                                        //"OR (ID_GESTOR = "+zastup+" AND DT_GESTORSCHVALENO IS NULL) ");   --esc061809
                                          "OR (ID_GESTOR = "+zastup+" AND DT_GESTORSCHVALENO IS NULL) "+
										  "OR (ID_NAVYSENI_MB = "+zastup+" AND DT_NAVYSENI_SCHVALENO  IS NULL) ");
    }
    voZastup.closeRowSet();
    where.append(")");

    return where.toString();
  }

  public String getWhereSchvalovatel(int userId) 
  {
    StringBuffer where = new StringBuffer("(EXISTS (SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR "+
		                        "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND "+
		                            "(ID_ODBOROO = "+userId+" OR "+
			                           "ID_PROJEKTMAN = "+userId+" OR "+
			                           "ID_UCSPOLOO = "+userId+" OR "+
			                           "ID_UCSPOLTOP = "+userId+")) "+
                              "OR ID_GESTOR = "+userId+") ");

    return where.toString();
  }

//esc 25.05.2011
  public String getWhereNeschvalenoKym(int userId, boolean zastupy) 
  {
    StringBuffer where = new StringBuffer("(EXISTS ( SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR " +
		                                                "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND " +
                                                          "DR.DT_ZAMITNUTO IS NULL AND "+
		                                                   "((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+userId+") OR "+
                                                       "(DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+userId+") OR "+
			                                                 "(DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+userId+") OR "+
			                                                 "(DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+userId+"))) "+
                                          "OR (ID_GESTOR = "+userId+" AND DT_GESTORSCHVALENO IS NULL) "+
										  "OR (ID_NAVYSENI_MB = "+userId+" AND DT_NAVYSENI_SCHVALENO  IS NULL) "); /* esc 18.6.2009 */
    
    if( zastupy ) {
                  ViewObject voZastup = getKpDatDoczastupView1();
                  voZastup.clearCache();
                  voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
                  while(voZastup.hasNext()) 
                  {
                      Row rowZastup = voZastup.next();
                      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
                      where.append(" OR EXISTS ( SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR " +
		                                                "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND " +
                                                          "DR.DT_ZAMITNUTO IS NULL AND "+
		                                                   "((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+zastup+") OR "+
                                                       "(DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+zastup+") OR "+
			                                                 "(DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+zastup+") OR "+
			                                                 "(DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+zastup+"))) "+
                                          "OR (ID_GESTOR = "+zastup+" AND DT_GESTORSCHVALENO IS NULL) "+
										  "OR (ID_NAVYSENI_MB = "+zastup+" AND DT_NAVYSENI_SCHVALENO  IS NULL) ");  /* esc 18.6.2009 */
                  }
                  voZastup.closeRowSet();    
    }
    
    where.append(")");

    return where.toString();
  }
//esc  

public String getWhereNeschvalenoKym(int userId) 
{
    String where;
    where = getWhereNeschvalenoKym(userId, true); 
    return where;
}
//esc
/*  public String getWhereNeschvalenoKym(int userId) 
  {
    StringBuffer where = new StringBuffer("(EXISTS ( SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR " +
		                                                "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND " +
                                                          "DR.DT_ZAMITNUTO IS NULL AND "+
		                                                   "((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+userId+") OR "+
                                                       "(DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+userId+") OR "+
			                                                 "(DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+userId+") OR "+
			                                                 "(DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+userId+"))) "+
                                          "OR (ID_GESTOR = "+userId+" AND DT_GESTORSCHVALENO IS NULL) "+
										  "OR (ID_NAVYSENI_MB = "+userId+" AND DT_NAVYSENI_SCHVALENO  IS NULL) "); 
    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      where.append(" OR EXISTS ( SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR " +
		                                                "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND " +
                                                          "DR.DT_ZAMITNUTO IS NULL AND "+
		                                                   "((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+zastup+") OR "+
                                                       "(DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+zastup+") OR "+
			                                                 "(DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+zastup+") OR "+
			                                                 "(DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+zastup+"))) "+
                                          "OR (ID_GESTOR = "+zastup+" AND DT_GESTORSCHVALENO IS NULL) "+
										  "OR (ID_NAVYSENI_MB = "+zastup+" AND DT_NAVYSENI_SCHVALENO  IS NULL) ");  
    }
    voZastup.closeRowSet();
    where.append(")");

    return where.toString();
  }
*/
  public String getWhereNeschvalenoPosledni(int userId) 
  {
    StringBuffer where = new StringBuffer("(EXISTS ( SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR " +
		                                                "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND " +
                                                          "DR.DT_ZAMITNUTO IS NULL AND "+
                                                       "(DR.ID_ODBOROO="+userId+" OR DR.ID_PROJEKTMAN="+userId+" OR ID_UCSPOLOO="+userId+" OR ID_UCSPOLTOP="+userId+") AND "+
		                                                   "(((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+userId+") OR (ID_ODBOROO IS NULL) OR (ID_ODBOROO <> "+userId+" AND DR.DT_SCHVALENOODBOR IS NOT NULL)) AND " +
		                                                    "((DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+userId+") OR (ID_PROJEKTMAN IS NULL) OR (ID_PROJEKTMAN <> "+userId+" AND DR.DT_SCHVALENOPROJEKT IS NOT NULL)) AND " +
			                                                  "((DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+userId+") OR (ID_UCSPOLOO IS NULL) OR (ID_UCSPOLOO <> "+userId+" AND DR.DT_SCHVALENOUCSPOL IS NOT NULL)) AND " +
			                                                  "((DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+userId+") OR (ID_UCSPOLTOP IS NULL) OR (ID_UCSPOLTOP <> "+userId+" AND DR.DT_SCHVALENOTOP IS NOT NULL)))) ");

    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      where.append(" OR EXISTS ( SELECT NULL FROM DB_JT.KP_DAT_DOKUMENTRADEK DR " +
		                                                "WHERE VWDATSCHVALOVAK.ID = DR.ID_DOKUMENT AND " +
                                                          "DR.DT_ZAMITNUTO IS NULL AND "+
                                                       "(DR.ID_ODBOROO="+zastup+" OR DR.ID_PROJEKTMAN="+zastup+" OR ID_UCSPOLOO="+zastup+" OR ID_UCSPOLTOP="+zastup+") AND "+
		                                                   "(((DR.DT_SCHVALENOODBOR IS NULL AND ID_ODBOROO = "+zastup+") OR (ID_ODBOROO IS NULL) OR (ID_ODBOROO <> "+zastup+" AND DR.DT_SCHVALENOODBOR IS NOT NULL)) AND " +
		                                                    "((DR.DT_SCHVALENOPROJEKT IS NULL AND ID_PROJEKTMAN = "+zastup+") OR (ID_PROJEKTMAN IS NULL) OR (ID_PROJEKTMAN <> "+zastup+" AND DR.DT_SCHVALENOPROJEKT IS NOT NULL)) AND " +
			                                                  "((DR.DT_SCHVALENOUCSPOL IS NULL AND ID_UCSPOLOO = "+zastup+") OR (ID_UCSPOLOO IS NULL) OR (ID_UCSPOLOO <> "+zastup+" AND DR.DT_SCHVALENOUCSPOL IS NOT NULL)) AND " +
			                                                  "((DR.DT_SCHVALENOTOP IS NULL AND ID_UCSPOLTOP = "+zastup+") OR (ID_UCSPOLTOP IS NULL) OR (ID_UCSPOLTOP <> "+zastup+" AND DR.DT_SCHVALENOTOP IS NOT NULL)))) ");
    }
    voZastup.closeRowSet();
    where.append(")");

    return where.toString();
  }
  
  public boolean jsemNeboZastupuji(int osoba) 
  {
    if(isCurrentUserAdmin()) return true;

    boolean ret = false;
    int userId = currentUsersId();
    if(userId == osoba) return true;
  
    ViewObject voZastup = getKpDatDoczastupView1();
    voZastup.clearCache();
    voZastup.setWhereClause("ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO");
    while(voZastup.hasNext()) 
    {
      Row rowZastup = voZastup.next();
      Number zastup = (Number) rowZastup.getAttribute("IdKoho");
      if(zastup != null && zastup.intValue()==osoba) {
        ret=true;
        break;
      }
    }
    voZastup.closeRowSet();

    return ret;
  }

  public String getWhereRelDocSpol() 
  {
    int userId = currentUsersId();
    int cisRel = currentUsersCisDocUcSpol();
  
    String where = cz.jtbank.konsolidace.common.Constants.WHERE_SPOL_DOC;
    if(cisRel==1) 
    {
      where += " AND EXISTS (SELECT NULL FROM DB_JT.KTG_APPUSER U WHERE "+
                                          "U.ID_DOCUCSPOL = KPKTGUCETNISPOLECNOST.ID "+
                                          "AND (ID = "+userId+" OR ID IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO)))";
    }
    else if(cisRel>1) {
      where += " AND EXISTS (SELECT NULL FROM DB_JT.KP_REL_APPUSER_DOCUCSPOL REL WHERE "+
                                          "REL.ID_KTGUCETNISPOLECNOST = KPKTGUCETNISPOLECNOST.ID "+
                                          "AND (ID_APPUSER = "+userId+" OR ID_APPUSER IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO)))";
    }                                          

    return where;
  }

  public String getWhereRelDocOdbor() 
  {
    int userId = currentUsersId();
    int cisRel = currentUsersCisDocUcSpol();
  
    String where = "";
    if(cisRel==1) 
    {
      where = "EXISTS (SELECT NULL FROM DB_JT.KTG_APPUSER U WHERE "+
                                          "U.ID_DOCUCSPOL = VwKtgOdbor.ID_KTGUCETNISPOLECNOST "+
                                          "AND (ID = "+userId+" OR ID IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO)))";
    }
    else if(cisRel>1) {
      where = "EXISTS (SELECT NULL FROM DB_JT.KP_REL_APPUSER_DOCUCSPOL REL WHERE "+
                                          "REL.ID_KTGUCETNISPOLECNOST = VwKtgOdbor.ID_KTGUCETNISPOLECNOST "+
                                          "AND (ID_APPUSER = "+userId+" OR ID_APPUSER IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO)))";
    }                                          

    return where;
  }

  public String getWhereRelDocBudget() 
  {
    int userId = currentUsersId();
    int cisRel = currentUsersCisDocUcSpol();
  
    String where = "";
    if(cisRel==1) 
    {
      where = "(EXISTS (SELECT NULL FROM DB_JT.KTG_APPUSER U WHERE "+
                                          "U.ID_DOCUCSPOL = VwDatBudget.ID_KTGUCETNISPOLECNOST "+
                                          "AND ID = "+userId+") OR ";
      where += "(SELECT z.ID_KOHO FROM DB_JT.KP_DAT_budgetZASTUP z WHERE z.ID_KDO = "+userId+" AND SYSDATE BETWEEN z.DT_PLATNOSTOD AND z.DT_PLATNOSTDO AND (z.ID_BUDGET is null OR z.ID_BUDGET = VwDatBudget.ID)) "+
      " in (VwDatBudget.ID_ODBOROO,VwDatBudget.ID_UCSPOLOO,VwDatBudget.ID_UCSPOLTOP))";
    }
    else if(cisRel>1) {
      where = "(EXISTS (SELECT NULL FROM DB_JT.KP_REL_APPUSER_DOCUCSPOL REL WHERE "+
                                          "REL.ID_KTGUCETNISPOLECNOST = VwDatBudget.ID_KTGUCETNISPOLECNOST "+
                                          "AND ID_APPUSER = "+userId+") OR ";
      where += "(SELECT z.ID_KOHO FROM DB_JT.KP_DAT_budgetZASTUP z WHERE z.ID_KDO = "+userId+" AND SYSDATE BETWEEN z.DT_PLATNOSTOD AND z.DT_PLATNOSTDO AND (z.ID_BUDGET is null OR z.ID_BUDGET = VwDatBudget.ID)) "+
      " in (VwDatBudget.ID_ODBOROO,VwDatBudget.ID_UCSPOLOO,VwDatBudget.ID_UCSPOLTOP))";
    }                                          

    return where;
  }
/*
  public String getWhereRelDocBudget() 
  {
    int userId = currentUsersId();
    int cisRel = currentUsersCisDocUcSpol();
  
    String where = "";
    if(cisRel==1) 
    {
      where = "EXISTS (SELECT NULL FROM DB_JT.KTG_APPUSER U WHERE "+
                                          "U.ID_DOCUCSPOL = VwDatBudget.ID_KTGUCETNISPOLECNOST "+
                                          "AND (ID = "+userId+" OR ID IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_BUDGETZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO)))";
    }
    else if(cisRel>1) {
      where = "EXISTS (SELECT NULL FROM DB_JT.KP_REL_APPUSER_DOCUCSPOL REL WHERE "+
                                          "REL.ID_KTGUCETNISPOLECNOST = VwDatBudget.ID_KTGUCETNISPOLECNOST "+
                                          "AND (ID_APPUSER = "+userId+" OR ID_APPUSER IN (SELECT ID_KOHO FROM DB_JT.KP_DAT_BUDGETZASTUP WHERE ID_KDO = "+userId+" AND SYSDATE BETWEEN DT_PLATNOSTOD AND DT_PLATNOSTDO)))";
    }                                          

    return where;
  }
*/  
  public void zastup(String akce,
                     int id,
                     int kdo,
                     java.sql.Date dtOd,
                     java.sql.Date dtDo,
                     int koho,
                     String fwdEmail) throws KisException
  {
    int idKoho = koho<1 ? currentUsersId() : koho;

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      if("I".equals(akce)) {
        st = dbTran.createCallableStatement("INSERT INTO DB_JT.KP_DAT_DOCZASTUP (ID_KOHO, ID_KDO, DT_PLATNOSTOD, DT_PLATNOSTDO, C_FWDEMAIL) VALUES (?,?,?,?,?)",0);
        st.setInt(1,idKoho);
        st.setInt(2,kdo);
        st.setDate(3,dtOd);
        st.setDate(4,dtDo);
        st.setString(5,fwdEmail);
        st.execute();
      }
      else if("U".equals(akce)) {
        st = dbTran.createCallableStatement("UPDATE DB_JT.KP_DAT_DOCZASTUP SET ID_KOHO=?, ID_KDO=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, C_FWDEMAIL=? WHERE ID=?",0);
        st.setInt(1,idKoho);
        st.setInt(2,kdo);
        st.setDate(3,dtOd);
        st.setDate(4,dtDo);
        st.setString(5,fwdEmail);
        st.setInt(6,id);
        st.execute();
      }
      else if("D".equals(akce)) {
        st = dbTran.createCallableStatement("DELETE FROM DB_JT.KP_DAT_DOCZASTUP WHERE ID=?",0);
        st.setInt(1,id);
        st.execute();
      }
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání java procedury zastup()",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpCisDokumentstatusView1
   */
  public KpCisDokumentstatusViewImpl getKpCisDokumentstatusView1()
  {
    return (KpCisDokumentstatusViewImpl)findViewObject("KpCisDokumentstatusView1");
  }

  public void setUserSpolTyp(int idCisSpolTyp, int idSpol, String country, int koho) throws KisException
  {
    int idKoho = koho<1 ? currentUsersId() : koho;

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_setUserSpolTyp(?,?,?,?); end;",0);
      st.setInt(1, idKoho);
      st.setInt(2, idCisSpolTyp);
      if(idSpol>0) st.setInt(3, idSpol);
      else st.setNull(3, Types.INTEGER);
      if(country==null || country.length()==0) st.setNull(4, Types.VARCHAR);
      else st.setString(4, country);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_setUserSpolTyp",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  /**
   * 
   * Container's getter for KpCisDokumentspoltypView1
   */
  public KpCisDokumentspoltypViewImpl getKpCisDokumentspoltypView1()
  {
    return (KpCisDokumentspoltypViewImpl)findViewObject("KpCisDokumentspoltypView1");
  }

  /**
   * 
   * Container's getter for KpRelAppuserDocucspolView1
   */
  public KpRelAppuserDocucspolViewImpl getKpRelAppuserDocucspolView1()
  {
    return (KpRelAppuserDocucspolViewImpl)findViewObject("KpRelAppuserDocucspolView1");
  }

  /**
   * 
   * Container's getter for VwKpZemeucspolView1
   */
  public VwKpZemeucspolViewImpl getVwKpZemeucspolView1()
  {
    return (VwKpZemeucspolViewImpl)findViewObject("VwKpZemeucspolView1");
  }

  public void klonujRadek(int idDoc, int idRadek, double iCastka ) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_klonujRadek(?,?,?); end;",0);
      st.setInt(1, idDoc);
      st.setInt(2, idRadek);
	  st.setDouble(3, iCastka);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_klonujRadek",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void zmenaCastky(int idRadek, double castka) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_zmenaCastky(?,?); end;",0);
      st.setInt(1, idRadek);
      st.setDouble(2, castka);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_zmenaCastky",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public void zamitnoutRadek(String akce, int idRadek, String duvod) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_zamitnoutRadek(?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idRadek);
      st.setString(3, duvod);
      st.setInt(4, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_zamitnoutRadek",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    if("I".equals(akce)) {
      ViewObject voRadek = getVwDatSchvalovakradekView1();
      voRadek.clearCache();
      voRadek.setWhereClause("ID = "+idRadek);
      if(voRadek.hasNext()) 
      {
        Row row = voRadek.next();
        Number idDoc = (Number)row.getAttribute("IdDokument");
        Number idZadavatel = (Number)row.getAttribute("IdZadavatel");
        if(idZadavatel != null) 
        {
          Set set = new HashSet();
          set.add(new Number(userId));
          set.add(idZadavatel);
          Mail mail = new Mail();
          mail.sendDocZamitRadek(this, set, idDoc, duvod);
        }
      }
      voRadek.closeRowSet();
    }
  }

  public void zamitnoutZadavatel(int idDoc, String duvod) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_zamitnoutZadavatel(?,?); end;",0);
      st.setInt(1, idDoc);
      st.setString(2, duvod);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_zamitnoutZadavatel",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    Set set = new HashSet();
    ViewObject vo = getVwDatSchvalovakView1();
    vo.clearCache();
    vo.setWhereClause("ID = "+idDoc);
    if(vo.hasNext()) 
    {
      Row row = vo.next();
      Number idAppuser = (Number)row.getAttribute("IdAppuser");
      if(idAppuser != null) 
      {
        set.add(new Number(userId));
        set.add(idAppuser);
        Mail mail = new Mail();
        mail.sendDocZamitZadavatel(this, set, new Number(idDoc), duvod);
      }
    }
    vo.closeRowSet();
  }


  public void zamitnoutGestor(String akce, int idDoc, String duvod) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_zamitnoutGestor(?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idDoc);
      st.setString(3, duvod);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_zamitnoutGestor",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
    if("I".equals(akce)) {
      Set set = new HashSet();
      ViewObject vo = getVwDatSchvalovakView1();
      vo.clearCache();
      vo.setWhereClause("ID = "+idDoc);
      if(vo.hasNext()) 
      {
        Row row = vo.next();
        Number idZadavatel = (Number)row.getAttribute("IdZadavatel");
        if(idZadavatel != null) 
        {
          Mail mail = new Mail();
          set.add(new Number(userId));
          set.add(idZadavatel);
          mail.sendDocZamitGestor(this, set, new Number(idDoc), duvod);
        }
      }
      vo.closeRowSet();
    }
  }
  
  
public void zamitnoutNavyseniBudgetu(String akce, int idDoc, String duvod) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_zamitnoutNavyseniBudgetu(?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idDoc);
      st.setString(3, duvod);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_zamitnoutNavyseniBudgetu",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    
	//zamitnout
    if("Z".equals(akce)) {
      Set set = new HashSet();
      ViewObject vo = getVwDatSchvalovakView1();
      vo.clearCache();
      vo.setWhereClause("ID = "+idDoc);
      if(vo.hasNext()) 
      {
        Row row = vo.next();
        Number idZadavatel = (Number)row.getAttribute("IdZadavatel");
        if(idZadavatel != null) 
        {
          Mail mail = new Mail();
          set.add(new Number(userId));
          set.add(idZadavatel);
          mail.sendDocZamitGestor(this, set, new Number(idDoc), " BUDGET "+duvod); //esc novy email !!
        }
      }
      vo.closeRowSet();
    }
  }  

  public void zamitnoutUcetni(String akce, int idDoc, String duvod) throws KisException
  {
    int userId = currentUsersId();

    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_zamitnoutUcetni(?,?,?,?); end;",0);
      st.setString(1, akce);
      st.setInt(2, idDoc);
      st.setString(3, duvod);
      st.setInt(4, userId);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_zamitnoutUcetni",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    if("I".equals(akce)) {
      Set set = new HashSet();
      ViewObject vo = getVwDatSchvalovakView1();
      vo.clearCache();
      vo.setWhereClause("ID = "+idDoc);
      if(vo.hasNext()) 
      {
        Row row = vo.next();
        Number idZadavatel = (Number)row.getAttribute("IdZadavatel");
        Number idGestor = (Number)row.getAttribute("IdGestor");
        if(idZadavatel != null) 
        {
          Mail mail = new Mail();
          set.add(new Number(userId));
          set.add(idZadavatel);
          set.add(idGestor);
          mail.sendDocZamitUcetni(this, set, new Number(idDoc), duvod);
        }
      }
      vo.closeRowSet();
    }
  }

  /**
   * 
   * Container's getter for KpCisProjektcashflowtypView1
   */
  public KpCisProjektcashflowtypViewImpl getKpCisProjektcashflowtypView1()
  {
    return (KpCisProjektcashflowtypViewImpl)findViewObject("KpCisProjektcashflowtypView1");
  }

  /**
   * 
   * Container's getter for KpCisMisuctymddView1
   */
  public KpCisMisuctymddViewImpl getKpCisMisuctymddView1()
  {
    return (KpCisMisuctymddViewImpl)findViewObject("KpCisMisuctymddView1");
  }

  public boolean checkBudget(int id) throws KisException
  {
    boolean ret = true;
    
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin ? := db_jt.kap_dokument.checkBudget(?); end;",0);
      st.registerOutParameter(1, Types.VARCHAR);
      st.setInt(2, id);
      st.execute();
      ret = null==st.getString(1);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání funkce db_jt.kap_dokument.checkBudget",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
/* VYPNUTO, DOKUD SE NENAPLNI BUDGETY PROJEKTU
    if(ret) 
    {
      try {
        st = dbTran.createCallableStatement("begin ? := db_jt.kap_dokument.checkBudgetProjekt(?); end;",0);
        st.registerOutParameter(1, Types.VARCHAR);
        st.setInt(2, id);
        st.execute();
        ret = null==st.getString(1);
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání funkce db_jt.kap_dokument.checkBudgetProjekt",s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { }
      }
    }
*/    
    return ret;
  }

  /**
   * 
   * Container's getter for KpCisTyptransakceEditView1
   */
  public KpCisTyptransakceEditViewImpl getKpCisTyptransakceEditView1()
  {
    return (KpCisTyptransakceEditViewImpl)findViewObject("KpCisTyptransakceEditView1");
  }

  /**
   * 
   * Container's getter for KpCisTyptransakcegroupView1
   */
  public KpCisTyptransakcegroupViewImpl getKpCisTyptransakcegroupView1()
  {
    return (KpCisTyptransakcegroupViewImpl)findViewObject("KpCisTyptransakcegroupView1");
  }

  public void typTransakce(String akce,
                           int id,
                           String popis,
                           String kod,
                           int idSkup,
                           int idCz,
                           int idSk,
                           int idZ,
                           java.sql.Date dtOd,
                           java.sql.Date dtDo,
                           String proZastupce,
                           String dev,
                           String komentar,
                           String special,
                           String mis2,
                           double urovenP,
                           String menaP,
                           double urovenS,
                           String menaS,
                           double urovenT,
                           String menaT,
                           String tiskMajetek,
                           String budgetovat,
                           String cops) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_CIS_TYPTRANSAKCE "+
                                            "(ID,S_POPIS,S_KOD,ID_TYPTRANSAKCEGROUP,ID_GESTOR_CZ,ID_GESTOR_SK,ID_GESTOR_Z,DT_PLATNOSTOD,DT_PLATNOSTDO,C_PROZASTUPCE,C_DEVELOPER,S_KOMENTAR,C_SPECIAL,C_PODVOJNEMIS,ND_UROVENPROJEKT,S_MENAUP,ND_UROVENSPOLECNOST,S_MENAUS,ND_UROVENTOP,S_MENAUT,C_TISKMAJETEK,C_BUDGETOVAT,C_CAPEX_OPEX) "+
                                            "SELECT NVL(MAX(ID),0)+1,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,? FROM DB_JT.KP_CIS_TYPTRANSAKCE WHERE C_SPECIAL=?",0);
        st.setString(1, popis);
        st.setString(2, kod);
        if(idSkup>0) st.setInt(3, idSkup); else st.setNull(3,Types.INTEGER);
        if(idCz>0) st.setInt(4, idCz); else st.setNull(4,Types.INTEGER);
        if(idSk>0) st.setInt(5, idSk); else st.setNull(5,Types.INTEGER);
        if(idZ>0) st.setInt(6, idZ); else st.setNull(6,Types.INTEGER);
        st.setDate(7, dtOd);
        st.setDate(8, dtDo);
        st.setString(9, proZastupce);
        st.setString(10, dev);
        st.setString(11, komentar);
        st.setString(12, special);
        st.setString(13, mis2);
        st.setDouble(14, urovenP);
        st.setString(15, menaP);
        st.setDouble(16, urovenS);
        st.setString(17, menaS);
        st.setDouble(18, urovenT);
        st.setString(19, menaT);
        st.setString(20, tiskMajetek);
        st.setString(21, budgetovat);
        st.setString(22, cops);

        st.setString(23, special);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury typTransakce akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_CIS_TYPTRANSAKCE "+
                                            "SET S_POPIS=? ,S_KOD=? ,ID_TYPTRANSAKCEGROUP=? ,ID_GESTOR_CZ=? ,ID_GESTOR_SK=? ,ID_GESTOR_Z=?, DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, C_PROZASTUPCE=?, C_DEVELOPER=?, S_KOMENTAR=?, C_SPECIAL=?, C_PODVOJNEMIS=?, "+
                                            "ND_UROVENPROJEKT=?, S_MENAUP=?, ND_UROVENSPOLECNOST=?, S_MENAUS=?, ND_UROVENTOP=?, S_MENAUT=?, C_TISKMAJETEK=?, C_BUDGETOVAT=? "+
                                            ",C_CAPEX_OPEX=? WHERE ID=?",0);
        st.setString(1, popis);
        st.setString(2, kod);
        if(idSkup>0) st.setInt(3, idSkup); else st.setNull(3,Types.INTEGER);
        if(idCz>0) st.setInt(4, idCz); else st.setNull(4,Types.INTEGER);
        if(idSk>0) st.setInt(5, idSk); else st.setNull(5,Types.INTEGER);
        if(idZ>0) st.setInt(6, idZ); else st.setNull(6,Types.INTEGER);
        st.setDate(7, dtOd);
        st.setDate(8, dtDo);
        st.setString(9, proZastupce);
        st.setString(10, dev);
        st.setString(11, komentar);
        st.setString(12, special);
        st.setString(13, mis2);
        st.setDouble(14, urovenP);
        st.setString(15, menaP);
        st.setDouble(16, urovenS);
        st.setString(17, menaS);
        st.setDouble(18, urovenT);
        st.setString(19, menaT);
        st.setString(20, tiskMajetek);
        st.setString(21, budgetovat);
        st.setString(22, cops);        

        st.setInt(23, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury typTransakce akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_CIS_TYPTRANSAKCE "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury typTransakce akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  public void typTransakceGroup(String akce,
                                int id,
                                String popis,
                                String kod,
                                java.sql.Date dtOd,
                                java.sql.Date dtDo,
                                String dev) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_CIS_TYPTRANSAKCEGROUP "+
                                            "(ID,S_POPIS,S_KOD,DT_PLATNOSTOD,DT_PLATNOSTDO,C_DEVELOPER) "+
                                            "SELECT NVL(MAX(ID),0)+1,?,?,?,?,? FROM DB_JT.KP_CIS_TYPTRANSAKCEGROUP",0);
        st.setString(1, popis);
        st.setString(2, kod);
        st.setDate(3, dtOd);
        st.setDate(4, dtDo);
        st.setString(5, dev);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury typTransakceGroup akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_CIS_TYPTRANSAKCEGROUP "+
                                            "SET S_POPIS=? ,S_KOD=? , DT_PLATNOSTOD=?, DT_PLATNOSTDO=?, C_DEVELOPER=? "+
                                            "WHERE ID=?",0);
        st.setString(1, popis);
        st.setString(2, kod);
        st.setDate(3, dtOd);
        st.setDate(4, dtDo);
        st.setString(5, dev);
        st.setInt(6, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury typTransakceGroup akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_CIS_TYPTRANSAKCEGROUP "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury typTransakceGroup akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for KpRelProjektucspolView1
   */
  public KpRelProjektucspolViewImpl getKpRelProjektucspolView1()
  {
    return (KpRelProjektucspolViewImpl)findViewObject("KpRelProjektucspolView1");
  }
  
  public int defaultProjekt(int idSpol) 
  {
    int projekt = -1;
  
    ViewObject vo = getKpRelProjektucspolView1();
    vo.clearCache();
    vo.setWhereClause("ID_KTGUCETNISPOLECNOST = "+idSpol+" and exists (select null from db_jt.kp_ktg_projekt p where p.ID = KpRelProjektucspol.ID_KTGPROJEKT and (p.ID_STATUS NOT IN (1,5,6,7) OR p.ID_STATUS IS NULL))"+
                      " AND (DT_MATKAOD <= SYSDATE OR DT_MATKAOD IS NULL) AND (DT_MATKADO >= SYSDATE OR DT_MATKADO IS NULL)");
    if(vo.getRowCount()==1) 
    {
      Row row = vo.next();
      projekt = ((Number) row.getAttribute("IdKtgprojekt")).intValue();
    }
    vo.closeRowSet();
    
    return projekt;
  }
  
  public int defaultOdbor(int idSpol) 
  {
    int odbor = -1;
  
    ViewObject vo = getKpKtgOdborView1();
    vo.clearCache();
    vo.setWhereClause("ID_KTGUCETNISPOLECNOST = "+idSpol);
    if(vo.getRowCount()==1) 
    {
      Row row = vo.next();
      odbor = ((Number) row.getAttribute("Id")).intValue();
    }
    vo.closeRowSet();
    
    return odbor;
  }

  /**
   * 
   * Container's getter for KpCisIfrssegmentView1
   */
  public KpCisIfrssegmentViewImpl getKpCisIfrssegmentView1()
  {
    return (KpCisIfrssegmentViewImpl)findViewObject("KpCisIfrssegmentView1");
  }

  /**
   * 
   * Container's getter for KpCisIfrssubsegmentView1
   */
  public KpCisIfrssubsegmentViewImpl getKpCisIfrssubsegmentView1()
  {
    return (KpCisIfrssubsegmentViewImpl)findViewObject("KpCisIfrssubsegmentView1");
  }

  /**
   * 
   * Container's getter for KpCisMngsegmentView1
   */
  public KpCisMngsegmentViewImpl getKpCisMngsegmentView1()
  {
    return (KpCisMngsegmentViewImpl)findViewObject("KpCisMngsegmentView1");
  }

  public void exportExcelOdbor(java.sql.Date datum) throws KisException 
  {
    ESExportOdbor es = new ESExportOdbor(this, datum);
    try {
      es.excelOutput();
    }
    catch (IOException ex) {
      ex.printStackTrace(); //pro zacatek
    }
  }

  java.text.DateFormat df = java.text.DateFormat.getDateTimeInstance(java.text.DateFormat.MEDIUM, java.text.DateFormat.MEDIUM);
  
  private FileFilter ff = new FileFilter() {
      public boolean accept(File pathname) 
      {
        return true;
      }
    };
  
  public String getExcelsOdbor() 
  {
    StringBuffer buf = new StringBuffer();
    String dirName = Constants.XLS_FILES_PATH + Constants.DIR_ODBORY;
    File dir = new File(dirName);
    File[] arr = dir.listFiles(ff);
    if(arr != null) {
      for( int i=0; i<arr.length; i++ ) 
      {
        String name = arr[i].getName();
        buf.append("<a target=\"_blank\" href=\"excelservlet/"+name+"?file="+Constants.DIR_ODBORY+"|5C" + name + "\">" + name+ "</a>");
        buf.append("&nbsp;" + df.format( new java.util.Date(arr[i].lastModified())) + "<br>"); 
      }
    }
    return buf.toString();
  }

  public void cisMisUcet(String akce,
                         int id,
                         String ucet,
                         String popis,
                         int idSubject,
                         int idTT) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_CIS_MISUCTYMDD "+
                                            "(ID,S_UCET,S_POPIS,ID_CISSUBJECT,ID_TYPTRANSAKCE) "+
                                            "SELECT NVL(MAX(ID),0)+1,?,?,?,? FROM DB_JT.KP_CIS_MISUCTYMDD",0);
        st.setString(1, ucet);
        st.setString(2, popis);
        st.setInt(3, idSubject);
        st.setInt(4, idTT);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury cisMisUcet akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //UPDATE
    else if("U".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("UPDATE DB_JT.KP_CIS_MISUCTYMDD "+
                                            "SET S_UCET=?, S_POPIS=?, ID_CISSUBJECT=?, ID_TYPTRANSAKCE=? "+
                                            "WHERE ID=?",0);
        st.setString(1, ucet);
        st.setString(2, popis);
        st.setInt(3, idSubject);
        st.setInt(4, idTT);
        st.setInt(5, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury cisMisUcet akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_CIS_MISUCTYMDD "+
                                            "WHERE ID=?",0);
        st.setInt(1, id);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury cisMisUcet akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }

  /**
   * 
   * Container's getter for VwDatBudgetView1
   */
  public VwDatBudgetViewImpl getVwDatBudgetView1()
  {
    return (VwDatBudgetViewImpl)findViewObject("VwDatBudgetView1");
  }

  /**
   * 
   * Container's getter for VwDatBudgetprojektView1
   */
  public VwDatBudgetprojektViewImpl getVwDatBudgetprojektView1()
  {
    return (VwDatBudgetprojektViewImpl)findViewObject("VwDatBudgetprojektView1");
  }

  /**
   * 
   * Container's getter for KpDefDeveloperspolecnostView1
   */
  public KpDefDeveloperspolecnostViewImpl getKpDefDeveloperspolecnostView1()
  {
    return (KpDefDeveloperspolecnostViewImpl)findViewObject("KpDefDeveloperspolecnostView1");
  }

  public void defDeveloper(String akce,
                           int idSpol) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    PreparedStatement st = null;

    //INSERT
    if("I".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("INSERT INTO DB_JT.KP_DEF_DEVELOPERSPOLECNOST "+
                                            "(ID_KTGUCETNISPOLECNOST) "+
                                            "VALUES (?)",0);
        st.setInt(1, idSpol);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury defDeveloper akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    //DELETE
    else if("D".equals(akce)) {
      try {
        st = dbTran.createPreparedStatement("DELETE FROM DB_JT.KP_DEF_DEVELOPERSPOLECNOST "+
                                            "WHERE ID=?",0);
        st.setInt(1, idSpol);
        st.execute();
      }
      catch (SQLException s) {
        s.printStackTrace(); //pro zacatek
        throw new KisException("Selhalo volání procedury defDeveloper akce="+akce,s);
      }
      finally {
        try {
          if (st != null) st.close();
        } 
        catch (SQLException s) { /* ignore */}
      }
    }
    
    dbTran.commit();
  }
  
  public List getDeveloperList() 
  {
    List list = new ArrayList();
    ViewObject vo = getKpDefDeveloperspolecnostView1();
    vo.clearCache();
    while(vo.hasNext()) 
    {
      Row row = vo.next();
      Number idSpol = (Number) row.getAttribute("IdKtgucetnispolecnost");
      list.add(idSpol);
    }
    vo.closeRowSet();
    return list;
  }

  /**
   * 
   * Container's getter for KpCisDokumentuhradaView1
   */
  public KpCisDokumentuhradaViewImpl getKpCisDokumentuhradaView1()
  {
    return (KpCisDokumentuhradaViewImpl)findViewObject("KpCisDokumentuhradaView1");
  }

  /**
   * 
   * Container's getter for VwRepSchvalovakpostupView1
   */
  public VwRepSchvalovakpostupViewImpl getVwRepSchvalovakpostupView1()
  {
    return (VwRepSchvalovakpostupViewImpl)findViewObject("VwRepSchvalovakpostupView1");
  }

  /**
   * 
   * Container's getter for KpKtgSpolecnostView1
   */
  public KpKtgSpolecnostViewImpl getKpKtgSpolecnostView1()
  {
    return (KpKtgSpolecnostViewImpl)findViewObject("KpKtgSpolecnostView1");
  }

  /**
   * 
   * Container's getter for KpTmpCissubjectView1
   */
  public KpTmpCissubjectViewImpl getKpTmpCissubjectView1()
  {
    return (KpTmpCissubjectViewImpl)findViewObject("KpTmpCissubjectView1");
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostView2
   */
  public KpKtgUcetnispolecnostViewImpl getKpKtgUcetnispolecnostView2()
  {
    return (KpKtgUcetnispolecnostViewImpl)findViewObject("KpKtgUcetnispolecnostView2");
  }

  /**
   * 
   * Container's getter for KpRelMisurovenschvalovaniView1
   */
  public KpRelMisurovenschvalovaniViewImpl getKpRelMisurovenschvalovaniView1()
  {
    return (KpRelMisurovenschvalovaniViewImpl)findViewObject("KpRelMisurovenschvalovaniView1");
  }

  public void misUrovenSchvalovani(int idTran, 
                                   int uroven,
                                   double castka,
                                   int idSpol,
                                   int idProjekt) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_misUrovenSchvalovani(?,?,?,?,?); end;",0);
      st.setInt(1, idTran);
      st.setInt(2, uroven);
      st.setDouble(3, castka);
      if(idSpol>0) st.setInt(4, idSpol); else st.setNull(4, Types.INTEGER);
      if(idProjekt>0) st.setInt(5, idProjekt); else st.setNull(5, Types.INTEGER);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_misUrovenSchvalovani",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

  public int klonujDokument(int idDoc) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    int userId = currentUsersId();
    int newId = -1;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_klonujDokument(?,?); end;",0);
      st.setInt(1, idDoc);
      st.setInt(2, userId);
      st.registerOutParameter(1, Types.INTEGER);
      st.execute();
      newId = st.getInt(1);
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_klonujDokument",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
    return newId;
  }

  public void checkBudgetPresun(int idDoc) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_checkBudgetPresun(?); end;",0);
      st.setInt(1, idDoc);
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); //pro zacatek
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_checkBudgetPresun",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { /* ignore */}
    }
  }

	/**
	 * 
	 * Container's getter for VwRepSchvalovakpostupDetailView1
	 */
	public VwRepSchvalovakpostupDetailViewImpl getVwRepSchvalovakpostupDetailView1() {
		return (VwRepSchvalovakpostupDetailViewImpl)findViewObject("VwRepSchvalovakpostupDetailView1");
	}

	/**
	 * 
	 * Container's getter for VwRelGestortransakceView1
	 */
	public VwRelGestortransakceViewImpl getVwRelGestortransakceView1() {
		return (VwRelGestortransakceViewImpl)findViewObject("VwRelGestortransakceView1");
	}

  public void updateGestorTransakceSegment(int idBunka, int idSegment, int idTran, int idGestor) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_setGestorTransakceSegment(?,?,?,?); end;",0);
      st.setInt(1, idBunka);
      st.setInt(2, idSegment);
      st.setInt(3, idTran);
      st.setInt(4, idGestor);	  
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); 
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_GestorTransakceSegment",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { 
							logger.error("Selhalo volání procedury db_jt.kap_dokument.p_GestorTransakceSegment",s);
	  }
    }
  }

 
  public void updateGestorTransakceSpolocnost(int idBunka, int idSpol, int idTran, int idGestor) throws KisException
  {
    DBTransaction dbTran = this.getDBTransaction();
    CallableStatement st = null;
    try {
      st = dbTran.createCallableStatement("begin db_jt.kap_dokument.p_setGestorTransakceSpolocnost(?,?,?,?); end;",0);
      st.setInt(1, idBunka);
      st.setInt(2, idSpol);
      st.setInt(3, idTran);
      st.setInt(4, idGestor);	  
      st.execute();
    }
    catch (SQLException s) {
      s.printStackTrace(); 
      throw new KisException("Selhalo volání procedury db_jt.kap_dokument.p_GestorTransakceSpolocnost",s);
    }
    finally {
      try {
        if (st != null) st.close();
      } 
      catch (SQLException s) { 
							logger.error("Selhalo volání procedury db_jt.kap_dokument.p_GestorTransakceSpolocnost",s);
	  }
    }
  }
  /**
   * 
   * Container's getter for VwRepSchvalovakhlavaView1
   */
  public VwRepSchvalovakhlavaViewImpl getVwRepSchvalovakhlavaView1()
  {
    return (VwRepSchvalovakhlavaViewImpl)findViewObject("VwRepSchvalovakhlavaView1");
  }

  /**
   * 
   * Container's getter for VwRepSchvalovakhlavadetailView1
   */
  public VwRepSchvalovakhlavadetailViewImpl getVwRepSchvalovakhlavadetailView1()
  {
    return (VwRepSchvalovakhlavadetailViewImpl)findViewObject("VwRepSchvalovakhlavadetailView1");
  }

  /**
   * 
   * Container's getter for VwRelGestortransakceSpolView1
   */
  public VwRelGestortransakceSpolViewImpl getVwRelGestortransakceSpolView1()
  {
    return (VwRelGestortransakceSpolViewImpl)findViewObject("VwRelGestortransakceSpolView1");
  }

  /**
   * 
   * Container's getter for VwRelGestortransakceSpolView2
   */
  public VwRelGestortransakceSpolViewImpl getVwRelGestortransakceSpolView2()
  {
    return (VwRelGestortransakceSpolViewImpl)findViewObject("VwRelGestortransakceSpolView2");
  }

  /**
   * 
   * Container's getter for VwDatSchvalovakAllView1
   */
  public VwDatSchvalovakAllViewImpl getVwDatSchvalovakAllView1()
  {
    return (VwDatSchvalovakAllViewImpl)findViewObject("VwDatSchvalovakAllView1");
  }

  /**
   * 
   * Container's getter for KpCisTypfakturyView1
   */
  public KpCisTypfakturyViewImpl getKpCisTypfakturyView1()
  {
    return (KpCisTypfakturyViewImpl)findViewObject("KpCisTypfakturyView1");
  }

  /**
   * 
   * Container's getter for VwDatSchvalovakView1
   */
  public VwDatSchvalovakViewImpl getVwDatSchvalovakView1()
  {
    return (VwDatSchvalovakViewImpl)findViewObject("VwDatSchvalovakView1");
  }

  /**
   * 
   * Container's getter for KpCisTypTranCapexOpexView1
   */
  public KpCisTypTranCapexOpexViewImpl getKpCisTypTranCapexOpexView1()
  {
    return (KpCisTypTranCapexOpexViewImpl)findViewObject("KpCisTypTranCapexOpexView1");
  }

  /**
   * 
   * Container's getter for KpCisBankarView1
   */
  public KpCisBankarViewImpl getKpCisBankarView1()
  {
    return (KpCisBankarViewImpl)findViewObject("KpCisBankarView1");
  }

  /**
   * 
   * Container's getter for VwCisTyptransakceView1
   */
  public VwCisTyptransakceViewImpl getVwCisTyptransakceView1()
  {
    return (VwCisTyptransakceViewImpl)findViewObject("VwCisTyptransakceView1");
  }

  /**
   * 
   * Container's getter for KpKtgUcetnispolecnostLinkView1
   */
  public KpKtgUcetnispolecnostLinkViewImpl getKpKtgUcetnispolecnostLinkView1()
  {
    return (KpKtgUcetnispolecnostLinkViewImpl)findViewObject("KpKtgUcetnispolecnostLinkView1");
  }






  
  
}