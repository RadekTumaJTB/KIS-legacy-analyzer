--------------------------------------------------------
-- SQL Script: Create Missing Tables for Oracle Package KAP_PROJEKT
-- Účel: Opravit INVALID status KAP_PROJEKT package body
-- Datum: 2025-12-10
--------------------------------------------------------

-- POZNÁMKA: Originální SQL používá TABLESPACE "DBAJT", který v Oracle 23ai Free neexistuje
-- SOLUTION: Změnit na USERS tablespace (default v Oracle 23ai Free)

--------------------------------------------------------
-- 1. KP_KTG_PROJEKTNAVRH - Návrhy projektů
--------------------------------------------------------
CREATE TABLE DB_JT.KP_KTG_PROJEKTNAVRH
(
    ID NUMBER,
    S_NAZEV VARCHAR2(150 BYTE),
    ID_NAVRHUJE NUMBER,
    S_EMAIL VARCHAR2(50 BYTE),
    ID_SPONZOR NUMBER,
    ID_PMANAGER NUMBER,
    S_POPIS VARCHAR2(3000 BYTE),
    ND_VYNOS NUMBER(15,2),
    S_MENAVYNOS VARCHAR2(3 BYTE),
    ND_NAKLAD NUMBER(15,2),
    S_MENANAKLAD VARCHAR2(3 BYTE),
    DT_ZACATEK DATE,
    DT_KONEC DATE,
    S_UZIVATEL VARCHAR2(30 BYTE),
    DT_VLOZENO DATE DEFAULT sysdate
) TABLESPACE USERS;

-- Sequence pro PROJEKTNAVRH
CREATE SEQUENCE DB_JT.SQ_KTG_PROJEKTNAVRH
  START WITH 1
  INCREMENT BY 1
  NOCACHE
  NOCYCLE;

COMMENT ON TABLE DB_JT.KP_KTG_PROJEKTNAVRH IS 'Návrhy nových projektů';

--------------------------------------------------------
-- 2. KP_LOG_PROJEKT - Audit log pro projekty
--------------------------------------------------------
CREATE TABLE DB_JT.KP_LOG_PROJEKT
(
    S_AKCE CHAR(1 BYTE),
    ID NUMBER,
    S_NAZEV VARCHAR2(100 BYTE),
    S_CISLOOLD VARCHAR2(6 BYTE),
    ID_STATUS NUMBER,
    DT_DATUMSTATUSZMENA DATE,
    ID_NAVRHUJE NUMBER,
    ID_SPONZOR NUMBER,
    ID_TOP NUMBER,
    ID_PMANAGER NUMBER,
    ID_KATEGORIE NUMBER,
    ID_TYPKATEGORIE NUMBER,
    ID_KTGUCETNISPOLECNOST NUMBER,
    ND_NAKLADY NUMBER(15,2),
    S_MENANAKLADY VARCHAR2(3 BYTE),
    ND_INVESTICE NUMBER(15,2),
    S_MENAINVESTICE VARCHAR2(3 BYTE),
    ND_OCENENI NUMBER(15,2),
    S_MENAOCENENI VARCHAR2(3 BYTE),
    DT_STARTOCENENI DATE,
    ID_FREKVENCE NUMBER,
    DT_KONECOCENENI DATE,
    S_POPIS VARCHAR2(250 BYTE),
    S_UZIVATEL VARCHAR2(20 BYTE),
    DT_ZMENY DATE,
    DT_PLATNOSTOD DATE,
    DT_PLATNOSTDO DATE,
    ID_PROJEKTNAVRH NUMBER,
    DT_MEMORANDUMDALSI DATE,
    NL_MEMORANDUMMESICU NUMBER(*,0),
    ID_IFRSSEGMENT NUMBER(*,0),
    ID_IFRSSUBSEGMENT NUMBER(*,0),
    ID_MNGSEGMENT NUMBER(*,0),
    ID_TYPBILANCE NUMBER(*,0),
    ID_TYPBUDGETU NUMBER(*,0),
    C_SLEDUJEBUDGET CHAR(1 BYTE)
) TABLESPACE USERS;

COMMENT ON TABLE DB_JT.KP_LOG_PROJEKT IS 'Audit log všech změn v projektech';

--------------------------------------------------------
-- 3. MAJETKOVÉ ÚČASTI - KP_CIS_MAJETKOVAUCASTZPUSOB
--------------------------------------------------------
CREATE TABLE DB_JT.KP_CIS_MAJETKOVAUCASTZPUSOB
(
    ID NUMBER(*,0),
    S_POPIS VARCHAR2(64 BYTE)
) TABLESPACE USERS;

ALTER TABLE DB_JT.KP_CIS_MAJETKOVAUCASTZPUSOB
ADD CONSTRAINT PK_KPMAJETKOVAUCASTZPUSOB PRIMARY KEY (ID);

COMMENT ON TABLE DB_JT.KP_CIS_MAJETKOVAUCASTZPUSOB IS 'Číselník - způsob majetkové účasti';

--------------------------------------------------------
-- 4. MAJETKOVÉ ÚČASTI - KP_CIS_MAJETKOVAUCASTTYPTRAN
--------------------------------------------------------
CREATE TABLE DB_JT.KP_CIS_MAJETKOVAUCASTTYPTRAN
(
    ID NUMBER(*,0),
    S_POPIS VARCHAR2(32 BYTE),
    C_SUMAZAPOCITAVAT CHAR(1 BYTE) DEFAULT '0'
) TABLESPACE USERS;

ALTER TABLE DB_JT.KP_CIS_MAJETKOVAUCASTTYPTRAN
ADD CONSTRAINT PK_KPMAJETKOVAUCASTTYPTRAN PRIMARY KEY (ID);

COMMENT ON TABLE DB_JT.KP_CIS_MAJETKOVAUCASTTYPTRAN IS 'Číselník - typ transakce majetkové účasti';

--------------------------------------------------------
-- 5. FINANČNÍ INVESTICE - KP_KTG_FINANCNIINVESTICE
--------------------------------------------------------
CREATE TABLE DB_JT.KP_KTG_FINANCNIINVESTICE
(
    ID NUMBER(*,0),
    S_NAZEV VARCHAR2(100 BYTE),
    ID_KTGUCETNISPOLECNOST NUMBER(*,0),
    S_POPIS VARCHAR2(500 BYTE),
    DT_PLATNOSTOD DATE,
    DT_PLATNOSTDO DATE,
    S_UZIVATEL VARCHAR2(20 BYTE),
    DT_ZMENA DATE DEFAULT sysdate
) TABLESPACE USERS;

ALTER TABLE DB_JT.KP_KTG_FINANCNIINVESTICE
ADD CONSTRAINT PK_KPKTGFINANCNIINVESTICE PRIMARY KEY (ID);

-- Sequence
CREATE SEQUENCE DB_JT.SQ_KP_KTG_FINANCNIINVESTICE
  START WITH 1
  INCREMENT BY 1
  NOCACHE
  NOCYCLE;

COMMENT ON TABLE DB_JT.KP_KTG_FINANCNIINVESTICE IS 'Katalog finančních investic';

--------------------------------------------------------
-- 6. EMISE FINANČNÍCH INVESTIC - KP_KTG_FININVESTICEEMISE
--------------------------------------------------------
CREATE TABLE DB_JT.KP_KTG_FININVESTICEEMISE
(
    ID NUMBER(*,0),
    ID_KTGFININVESTICE NUMBER(*,0),
    S_ISIN VARCHAR2(12 BYTE),
    S_NAZEV VARCHAR2(100 BYTE),
    S_POPIS VARCHAR2(500 BYTE),
    DT_PLATNOSTOD DATE,
    DT_PLATNOSTDO DATE,
    S_UZIVATEL VARCHAR2(20 BYTE),
    DT_ZMENA DATE DEFAULT sysdate
) TABLESPACE USERS;

ALTER TABLE DB_JT.KP_KTG_FININVESTICEEMISE
ADD CONSTRAINT PK_KPKTGFININVESTICEEMISE PRIMARY KEY (ID);

-- Sequence
CREATE SEQUENCE DB_JT.SQ_KP_KTG_FININVESTICEEMISE
  START WITH 1
  INCREMENT BY 1
  NOCACHE
  NOCYCLE;

-- Foreign key
ALTER TABLE DB_JT.KP_KTG_FININVESTICEEMISE
ADD CONSTRAINT FK_FININVEMISE_FININV
FOREIGN KEY (ID_KTGFININVESTICE)
REFERENCES DB_JT.KP_KTG_FINANCNIINVESTICE(ID);

COMMENT ON TABLE DB_JT.KP_KTG_FININVESTICEEMISE IS 'Emise finančních investic (ISIN)';

--------------------------------------------------------
-- 7. DATA MAJETKOVÝCH ÚČASTÍ - KP_DAT_MAJETKOVAUCAST
--------------------------------------------------------
CREATE TABLE DB_JT.KP_DAT_MAJETKOVAUCAST
(
    ID NUMBER(*,0),
    ID_PARENT NUMBER(*,0),
    ID_KTGUCETNISPOLECNOST NUMBER(*,0),
    ID_KTGFININVESTICEEMISE NUMBER(*,0),
    S_UCET VARCHAR2(12 BYTE),
    DT_PLATNOSTOD DATE,
    DT_PLATNOSTDO DATE,
    ID_CISMUTYPTRANSAKCE NUMBER(*,0),
    ID_CISMUZPUSOB NUMBER(*,0),
    NL_POCETKUSU NUMBER(17,4),
    S_MENATRANSAKCE VARCHAR2(3 BYTE),
    ND_CENATRANSAKCEKUS NUMBER(15,2),
    ND_OBJEMTRANSAKCE NUMBER(15,2),
    ND_KURZ NUMBER(10,6),
    S_MENAUCETNI VARCHAR2(3 BYTE),
    ND_CENAUCETNIKUS NUMBER(15,2),
    ND_OBJEMUCETNI NUMBER(15,2),
    DT_ZMENA DATE DEFAULT sysdate,
    S_UZIVATEL VARCHAR2(20 BYTE),
    ID_KTGUCETNISPOLECNOSTKOUPENO NUMBER(*,0),
    C_IGNOROVAT CHAR(1 BYTE) DEFAULT '0'
) TABLESPACE USERS;

ALTER TABLE DB_JT.KP_DAT_MAJETKOVAUCAST
ADD CONSTRAINT PK_KPDATMAJETKOVAUCAST PRIMARY KEY (ID);

-- Sequence
CREATE SEQUENCE DB_JT.SQ_KP_DAT_MAJETKOVAUCAST
  START WITH 1
  INCREMENT BY 1
  NOCACHE
  NOCYCLE;

-- Foreign keys
ALTER TABLE DB_JT.KP_DAT_MAJETKOVAUCAST
ADD CONSTRAINT FK_DATMAJUCAST_UCETSPOLEC
FOREIGN KEY (ID_KTGUCETNISPOLECNOST)
REFERENCES DB_JT.KP_KTG_UCETNISPOLECNOST(ID);

ALTER TABLE DB_JT.KP_DAT_MAJETKOVAUCAST
ADD CONSTRAINT FK_DATMAJUCAST_FININVEMISE
FOREIGN KEY (ID_KTGFININVESTICEEMISE)
REFERENCES DB_JT.KP_KTG_FININVESTICEEMISE(ID);

ALTER TABLE DB_JT.KP_DAT_MAJETKOVAUCAST
ADD CONSTRAINT FK_DATMAJUCAST_TYPTRAN
FOREIGN KEY (ID_CISMUTYPTRANSAKCE)
REFERENCES DB_JT.KP_CIS_MAJETKOVAUCASTTYPTRAN(ID);

ALTER TABLE DB_JT.KP_DAT_MAJETKOVAUCAST
ADD CONSTRAINT FK_DATMAJUCAST_ZPUSOB
FOREIGN KEY (ID_CISMUZPUSOB)
REFERENCES DB_JT.KP_CIS_MAJETKOVAUCASTZPUSOB(ID);

COMMENT ON TABLE DB_JT.KP_DAT_MAJETKOVAUCAST IS 'Data majetkových účastí (vlastnictví akcií)';
COMMENT ON COLUMN DB_JT.KP_DAT_MAJETKOVAUCAST.ID_KTGUCETNISPOLECNOSTKOUPENO IS 'Říká od koho se ta investice koupila.';

--------------------------------------------------------
-- 8. LOG MAJETKOVÝCH ÚČASTÍ - KP_LOG_MAJETKOVAUCAST
--------------------------------------------------------
CREATE TABLE DB_JT.KP_LOG_MAJETKOVAUCAST
(
    S_AKCE CHAR(1 BYTE),
    ID NUMBER(*,0),
    ID_PARENT NUMBER(*,0),
    ID_KTGUCETNISPOLECNOST NUMBER(*,0),
    ID_KTGFININVESTICEEMISE NUMBER(*,0),
    S_UCET VARCHAR2(12 BYTE),
    DT_PLATNOSTOD DATE,
    DT_PLATNOSTDO DATE,
    ID_CISMUTYPTRANSAKCE NUMBER(*,0),
    ID_CISMUZPUSOB NUMBER(*,0),
    NL_POCETKUSU NUMBER(17,4),
    S_MENATRANSAKCE VARCHAR2(3 BYTE),
    ND_CENATRANSAKCEKUS NUMBER(15,2),
    ND_OBJEMTRANSAKCE NUMBER(15,2),
    ND_KURZ NUMBER(10,6),
    S_MENAUCETNI VARCHAR2(3 BYTE),
    ND_CENAUCETNIKUS NUMBER(15,2),
    ND_OBJEMUCETNI NUMBER(15,2),
    DT_ZMENY DATE,
    S_UZIVATEL VARCHAR2(20 BYTE),
    ID_KTGUCETNISPOLECNOSTKOUPENO NUMBER(*,0),
    C_IGNOROVAT CHAR(1 BYTE)
) TABLESPACE USERS;

COMMENT ON TABLE DB_JT.KP_LOG_MAJETKOVAUCAST IS 'Audit log majetkových účastí';

--------------------------------------------------------
-- 9. LOG FINANČNÍCH INVESTIC - KP_LOG_FINANCNIINVESTICE
--------------------------------------------------------
CREATE TABLE DB_JT.KP_LOG_FINANCNIINVESTICE
(
    S_AKCE CHAR(1 BYTE),
    ID NUMBER(*,0),
    S_NAZEV VARCHAR2(100 BYTE),
    ID_KTGUCETNISPOLECNOST NUMBER(*,0),
    S_POPIS VARCHAR2(500 BYTE),
    DT_PLATNOSTOD DATE,
    DT_PLATNOSTDO DATE,
    S_UZIVATEL VARCHAR2(20 BYTE),
    DT_ZMENY DATE
) TABLESPACE USERS;

COMMENT ON TABLE DB_JT.KP_LOG_FINANCNIINVESTICE IS 'Audit log finančních investic';

--------------------------------------------------------
-- 10. LOG EMISE FINANČNÍCH INVESTIC - KP_LOG_FININVESTICEEMISE
--------------------------------------------------------
CREATE TABLE DB_JT.KP_LOG_FININVESTICEEMISE
(
    S_AKCE CHAR(1 BYTE),
    ID NUMBER(*,0),
    ID_KTGFININVESTICE NUMBER(*,0),
    S_ISIN VARCHAR2(12 BYTE),
    S_NAZEV VARCHAR2(100 BYTE),
    S_POPIS VARCHAR2(500 BYTE),
    DT_PLATNOSTOD DATE,
    DT_PLATNOSTDO DATE,
    S_UZIVATEL VARCHAR2(20 BYTE),
    DT_ZMENY DATE
) TABLESPACE USERS;

COMMENT ON TABLE DB_JT.KP_LOG_FININVESTICEEMISE IS 'Audit log emise finančních investic';

--------------------------------------------------------
-- TESTOVACÍ DATA PRO MAJETKOVÉ ÚČASTI
--------------------------------------------------------

-- Číselník způsobů majetkové účasti
INSERT INTO DB_JT.KP_CIS_MAJETKOVAUCASTZPUSOB (ID, S_POPIS) VALUES (1, 'Přímá akvizice');
INSERT INTO DB_JT.KP_CIS_MAJETKOVAUCASTZPUSOB (ID, S_POPIS) VALUES (2, 'Kapitálový vstup');
INSERT INTO DB_JT.KP_CIS_MAJETKOVAUCASTZPUSOB (ID, S_POPIS) VALUES (3, 'Převod z jiné účetní jednotky');
INSERT INTO DB_JT.KP_CIS_MAJETKOVAUCASTZPUSOB (ID, S_POPIS) VALUES (4, 'Veřejná nabídka');

-- Číselník typů transakcí
INSERT INTO DB_JT.KP_CIS_MAJETKOVAUCASTTYPTRAN (ID, S_POPIS, C_SUMAZAPOCITAVAT) VALUES (1, 'Nákup', '1');
INSERT INTO DB_JT.KP_CIS_MAJETKOVAUCASTTYPTRAN (ID, S_POPIS, C_SUMAZAPOCITAVAT) VALUES (2, 'Prodej', '0');
INSERT INTO DB_JT.KP_CIS_MAJETKOVAUCASTTYPTRAN (ID, S_POPIS, C_SUMAZAPOCITAVAT) VALUES (3, 'Zvýšení základního kapitálu', '1');
INSERT INTO DB_JT.KP_CIS_MAJETKOVAUCASTTYPTRAN (ID, S_POPIS, C_SUMAZAPOCITAVAT) VALUES (4, 'Snížení základního kapitálu', '0');
INSERT INTO DB_JT.KP_CIS_MAJETKOVAUCASTTYPTRAN (ID, S_POPIS, C_SUMAZAPOCITAVAT) VALUES (5, 'Dividenda', '0');

COMMIT;

--------------------------------------------------------
-- VERIFIKACE
--------------------------------------------------------
SELECT 'Vytvořené tabulky:' AS status FROM DUAL;

SELECT object_name, object_type, status
FROM user_objects
WHERE object_name IN (
    'KP_KTG_PROJEKTNAVRH',
    'KP_LOG_PROJEKT',
    'KP_CIS_MAJETKOVAUCASTZPUSOB',
    'KP_CIS_MAJETKOVAUCASTTYPTRAN',
    'KP_KTG_FINANCNIINVESTICE',
    'KP_KTG_FININVESTICEEMISE',
    'KP_DAT_MAJETKOVAUCAST',
    'KP_LOG_MAJETKOVAUCAST',
    'KP_LOG_FINANCNIINVESTICE',
    'KP_LOG_FININVESTICEEMISE'
)
ORDER BY object_name;

SELECT 'Vytvořené sekvence:' AS status FROM DUAL;

SELECT sequence_name
FROM user_sequences
WHERE sequence_name IN (
    'SQ_KTG_PROJEKTNAVRH',
    'SQ_KP_KTG_FINANCNIINVESTICE',
    'SQ_KP_KTG_FININVESTICEEMISE',
    'SQ_KP_DAT_MAJETKOVAUCAST'
);
